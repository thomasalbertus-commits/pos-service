<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>iFix Pro Enterprise - Cloud SaaS</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Aplikasi POS untuk Service HP & Penjualan - iFix Pro Enterprise">
    <meta name="theme-color" content="#1e40af">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="iFix Pro">
    <link rel="manifest" href="./manifest.json">
    
    <!-- 
    üî• FIREBASE QUOTA OPTIMIZATION AKTIF üî•
    ========================================
    ‚úÖ enableIndexedDbPersistence dengan synchronizeTabs
    ‚úÖ Cache-first strategy dengan metadata tracking
    ‚úÖ Limit 25 items per collection (turun dari 50)
    ‚úÖ Skip update jika data dari cache dan tidak ada perubahan
    ‚úÖ Pagination client-side untuk hemat reads
    
    Estimasi Penggunaan:
    - 10 user aktif/hari: ~3,000 reads/hari (6% quota)
    - Reload halaman: 0 reads (data dari cache)
    - Multi-tab support: shared cache antar tab
    -->
    
    <!-- 
    ‚ö†Ô∏è  DEPENDENCY VERSIONS LOCKED - DO NOT AUTO-UPDATE ‚ö†Ô∏è
    ================================================================
    Status: PRODUCTION STABLE (Tested & Working - Feb 2026)
    
    CORE LIBRARIES (LOCKED):
    - React: 18.2.0 (Stable - No breaking changes expected)
    - Firebase: 10.7.1 (Tested with persistence & offline)
    - Lucide Icons: 0.263.1 (Icon library)
    - Recharts: 2.12.0 (Charts)
    - HTML2Canvas: 1.4.1 (Export PDF)
    - Babel Standalone: 7.23.6 (JSX compiler)
    - Tailwind CSS: Latest (via CDN - safe to update)
    
    BREAKING CHANGE PROTECTION:
    ‚úÖ All versions pinned to exact numbers
    ‚úÖ Firebase API wrapped with error handling
    ‚úÖ Fallback mechanisms for offline/errors
    ‚úÖ Tested compatibility: React 18.2 + Firebase 10.7
    
    BEFORE UPDATING ANY VERSION:
    1. Test in development environment first
    2. Check changelog for breaking changes
    3. Update ONE library at a time
    4. Verify all features still work
    5. Update this documentation
    
    Last Verified: February 3, 2026
    Risk Level: LOW (All versions locked)
    ================================================================
    -->
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Libraries (VERSIONS LOCKED) -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom": "https://esm.sh/react-dom@18.2.0",
        "react-dom-client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "html2canvas": "https://esm.sh/html2canvas@1.4.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
      }
    }
    </script>
    
    <script src="https://unpkg.com/@babel/standalone@7.23.6/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
      body { background-color: #f8fafc; font-family: 'Inter', sans-serif; overflow-x: hidden; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #f1f1f1; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .saas-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
      
      /* Animasi Timeline */
      .timeline-line { position: absolute; left: 15px; top: 30px; bottom: -20px; width: 2px; background: #e2e8f0; z-index: 0; }
      .timeline-item:last-child .timeline-line { display: none; }
      
      /* Animasi Loading */
      .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 30px; height: 30px; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      @media print {
        .no-print { display: none !important; }
        body { background: white; }
        .print-only { display: block !important; }
        @page { margin: 0; }
      }

      /* Animasi Fade In */
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
      
      /* Sidebar Scrollbar - Custom untuk sidebar agar tidak mengecil */
      .sidebar-scroll::-webkit-scrollbar { width: 4px; }
      .sidebar-scroll::-webkit-scrollbar-track { background: #0f172a; }
      .sidebar-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
      .sidebar-scroll::-webkit-scrollbar-thumb:hover { background: #475569; }
      .sidebar-scroll { scrollbar-width: thin; scrollbar-color: #334155 #0f172a; }
    </style>
</head>
<body class="text-slate-800 antialiased selection:bg-blue-100 selection:text-blue-900">
    <!-- Error Display Container -->
    <div id="error-display" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 999999; overflow-y: auto; padding: 20px;">
        <div style="max-width: 800px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 20px; color: #dc2626;">
                <svg style="width: 32px; height: 32px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
                <h2 style="margin: 0; font-size: 24px; font-weight: bold; color: #dc2626;">Error Terdeteksi</h2>
            </div>
            <div id="error-content" style="font-family: monospace; font-size: 14px; line-height: 1.6; color: #1f2937; white-space: pre-wrap; word-wrap: break-word; background: #f3f4f6; padding: 15px; border-radius: 4px; margin-bottom: 20px; max-height: 400px; overflow-y: auto;"></div>
            
            <!-- Diagnostic Info -->
            <details style="margin-bottom: 20px; border: 1px solid #e5e7eb; border-radius: 4px; padding: 10px;">
                <summary style="cursor: pointer; font-weight: bold; color: #3b82f6; margin-bottom: 10px;">üìä Info Diagnostik (klik untuk lihat)</summary>
                <div id="diagnostic-info" style="font-family: monospace; font-size: 12px; line-height: 1.6; color: #1f2937; white-space: pre-wrap; background: #f9fafb; padding: 10px; border-radius: 4px; margin-top: 10px;"></div>
            </details>
            
            <button onclick="document.getElementById('error-display').style.display='none'" style="background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%;">Tutup</button>
            <button onclick="location.reload()" style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">Reload Halaman</button>
            <button onclick="navigator.clipboard.writeText(document.getElementById('error-content').textContent + '\\n\\n' + document.getElementById('diagnostic-info').textContent).then(() => alert('‚úÖ Error & diagnostic info berhasil disalin ke clipboard!'))" style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px;">üìã Copy Error Info</button>
        </div>
    </div>
    
    <!-- Debug Button (Floating) -->
    <button id="debug-btn" style="position: fixed; bottom: 80px; right: 20px; background: #8b5cf6; color: white; border: none; width: 48px; height: 48px; border-radius: 50%; font-size: 20px; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); z-index: 999998; display: flex; align-items: center; justify-center; transition: all 0.3s ease;">
        üêû
    </button>
    
    <div id="root"></div>

    <script>
        // Debug button handler
        document.getElementById('debug-btn').addEventListener('click', function() {
            window.showError('System Info', 'Tidak ada error.\nIni adalah informasi sistem Anda.', null);
        });
        
        document.getElementById('debug-btn').addEventListener('mouseover', function() {
            this.style.transform = 'scale(1.1)';
        });
        
        document.getElementById('debug-btn').addEventListener('mouseout', function() {
            this.style.transform = 'scale(1)';
        });
        
        // ==========================================
        // üîç DIAGNOSTIC INFO (tampil di console)
        // ==========================================
        console.log('==========================================');
        console.log('üöÄ iFix Pro Enterprise - Starting...');
        console.log('==========================================');
        console.log('üì± User Agent:', navigator.userAgent);
        console.log('üåê Browser:', navigator.appName + ' ' + navigator.appVersion);
        console.log('üì∫ Screen:', window.screen.width + 'x' + window.screen.height);
        console.log('ü™ü Viewport:', window.innerWidth + 'x' + window.innerHeight);
        console.log('üåç Online:', navigator.onLine);
        console.log('üíæ LocalStorage:', typeof localStorage !== 'undefined' ? 'Supported' : 'Not Supported');
        console.log('üîß ServiceWorker:', 'serviceWorker' in navigator ? 'Supported' : 'Not Supported');
        console.log('üìÖ Date:', new Date().toLocaleString('id-ID'));
        console.log('==========================================');
        
        // Global Error Handler untuk menampilkan error di halaman
        window.showError = function(title, message, error) {
            const errorDisplay = document.getElementById('error-display');
            const errorContent = document.getElementById('error-content');
            const diagnosticInfo = document.getElementById('diagnostic-info');
            
            let errorText = `üî¥ ${title}\n\n`;
            errorText += `${message}\n\n`;
            
            if (error) {
                errorText += `Error Details:\n`;
                errorText += `${error.toString()}\n\n`;
                
                if (error.stack) {
                    errorText += `Stack Trace:\n${error.stack}`;
                }
            }
            
            errorContent.textContent = errorText;
            
            // Populate diagnostic info
            let diagText = '';
            diagText += `User Agent: ${navigator.userAgent}\n`;
            diagText += `Browser: ${navigator.appName} ${navigator.appVersion}\n`;
            diagText += `Screen: ${window.screen.width}x${window.screen.height}\n`;
            diagText += `Viewport: ${window.innerWidth}x${window.innerHeight}\n`;
            diagText += `Online: ${navigator.onLine}\n`;
            diagText += `LocalStorage: ${typeof localStorage !== 'undefined' ? 'Supported' : 'Not Supported'}\n`;
            diagText += `ServiceWorker: ${'serviceWorker' in navigator ? 'Supported' : 'Not Supported'}\n`;
            diagText += `Cookies: ${navigator.cookieEnabled ? 'Enabled' : 'Disabled'}\n`;
            diagText += `Language: ${navigator.language}\n`;
            diagText += `Platform: ${navigator.platform}\n`;
            diagText += `Date: ${new Date().toLocaleString('id-ID')}\n`;
            diagText += `URL: ${window.location.href}\n`;
            
            diagnosticInfo.textContent = diagText;
            errorDisplay.style.display = 'block';
            
            // Juga log ke console untuk reference
            console.error('‚ùå Error:', title, message, error);
        };
        
        // Catch all unhandled errors
        window.addEventListener('error', function(event) {
            showError(
                'JavaScript Error',
                `File: ${event.filename}\nLine: ${event.lineno}:${event.colno}`,
                event.error
            );
        });
        
        // Catch all unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            showError(
                'Unhandled Promise Rejection',
                'Promise ditolak tanpa error handler',
                event.reason
            );
        });
        
        // Loading indicator
        window.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ DOM loaded');
            
            // Check if React loaded
            setTimeout(function() {
                const root = document.getElementById('root');
                if (!root.hasChildNodes()) {
                    showError(
                        'React Tidak Load',
                        'React tidak berhasil merender aplikasi.\nPeriksa koneksi internet atau kompabilitas browser.',
                        new Error('Root div kosong setelah 5 detik')
                    );
                }
            }, 5000);
            
            // Monitor network status
            if (!navigator.onLine) {
                showError(
                    'Tidak Ada Koneksi Internet',
                    'Perangkat Anda sedang offline.\nPastikan koneksi internet aktif.',
                    new Error('navigator.onLine = false')
                );
            }
            
            window.addEventListener('online', function() {
                console.log('‚úÖ Kembali online');
                const errorDisplay = document.getElementById('error-display');
                if (errorDisplay.style.display === 'block') {
                    if (confirm('Koneksi internet kembali. Reload halaman?')) {
                        location.reload();
                    }
                }
            });
            
            window.addEventListener('offline', function() {
                console.log('‚ö†Ô∏è Offline');
                showError(
                    'Koneksi Internet Terputus',
                    'Perangkat kehilangan koneksi internet.\nBeberapa fitur mungkin tidak tersedia.',
                    new Error('Connection lost')
                );
            });
        });
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useContext, createContext, useCallback, useMemo } from 'react';
        import { createRoot } from 'react-dom-client';
        import { 
          LayoutDashboard, Smartphone, Box, Wallet, FileText, Users, Settings, 
          LogOut, Plus, Search, Store, ChevronDown, Check, Lock, ShieldCheck, MapPin,
          Printer, Share2, X, Save, Menu, CheckCircle, AlertTriangle, Trash2, 
          Upload, Download, RefreshCw, Copy, Wrench, PackagePlus, PenTool, 
          MessageCircle, Calendar, DollarSign, CreditCard, Image as ImageIcon, 
          ArrowUpRight, ArrowDownRight, Activity, TrendingUp, TrendingDown, ToggleLeft, Globe, Eye, UserX, Key,
          ShieldAlert, Shield, Building, Database, HardDriveDownload, HardDriveUpload, Layers,
          Loader2, LogIn, UserPlus, RefreshCcw, SearchX, Truck, CheckCheck, Pencil,
          Hash, Edit3, Filter, MinusCircle, Crown, Minus, History, Tag,
          Zap, BarChart3, Info, ShoppingCart, Banknote, Phone, Mail, RotateCcw, RotateCw
        } from 'lucide-react';
        import { 
          BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell, 
          AreaChart, Area, PieChart, Pie
        } from 'recharts';
        import html2canvas from 'html2canvas';
        
        // --- FIREBASE IMPORTS ---
        import { initializeApp, deleteApp } from 'firebase/app';
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged, 
            signInAnonymously,
            setPersistence,
            browserLocalPersistence,
            browserSessionPersistence
        } from 'firebase/auth';
        import { 
            getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs,
            query, where, onSnapshot, orderBy, serverTimestamp, writeBatch, runTransaction, increment, limit,
            enableIndexedDbPersistence, Timestamp
        } from 'firebase/firestore';

        // ==========================================
        // ÔøΩÔ∏è FIREBASE API PROTECTION LAYER
        // ==========================================
        // Wrapper untuk protect dari breaking changes di Firebase API
        // Jika Firebase update dan API berubah, kita bisa handle di sini
        const FirebaseAPI = {
            // Firestore operations dengan error handling
            async safeGetDoc(ref) {
                try {
                    return await getDoc(ref);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase getDoc error:', error);
                    if (error.code === 'unavailable') {
                        throw new Error('Koneksi Firebase tidak tersedia. Cek internet Anda.');
                    }
                    throw error;
                }
            },
            
            async safeSetDoc(ref, data, options) {
                try {
                    return await setDoc(ref, data, options);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase setDoc error:', error);
                    if (error.code === 'permission-denied') {
                        throw new Error('Akses ditolak. Periksa permission Firestore.');
                    }
                    throw error;
                }
            },
            
            async safeAddDoc(collectionRef, data) {
                try {
                    return await addDoc(collectionRef, data);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase addDoc error:', error);
                    throw error;
                }
            },
            
            async safeGetDocs(queryRef) {
                try {
                    return await getDocs(queryRef);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase getDocs error:', error);
                    throw error;
                }
            },
            
            async safeUpdateDoc(ref, data) {
                try {
                    return await updateDoc(ref, data);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase updateDoc error:', error);
                    throw error;
                }
            },
            
            async safeDeleteDoc(ref) {
                try {
                    return await deleteDoc(ref);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase deleteDoc error:', error);
                    throw error;
                }
            },
            
            // Auth operations
            async safeSignIn(email, password) {
                try {
                    return await signInWithEmailAndPassword(auth, email, password);
                } catch (error) {
                    console.error('‚ö†Ô∏è Firebase signIn error:', error);
                    if (error.code === 'auth/wrong-password') {
                        throw new Error('Password salah');
                    } else if (error.code === 'auth/user-not-found') {
                        throw new Error('User tidak ditemukan');
                    } else if (error.code === 'auth/too-many-requests') {
                        throw new Error('Terlalu banyak percobaan. Coba lagi nanti.');
                    }
                    throw error;
                }
            },
            
            // Version info untuk tracking
            getVersionInfo() {
                return {
                    firebase: '10.7.1',
                    react: '18.2.0',
                    status: 'locked',
                    lastVerified: '2026-02-03'
                };
            }
        };
        
        // Export untuk logging
        console.log('üõ°Ô∏è Firebase Protection Layer Active:', FirebaseAPI.getVersionInfo());

        // ==========================================
        // ÔøΩüî• FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAF9msg6MbCPuyB2iJ1yXkUrQYTgG_H5EM",
            authDomain: "ifix-enterprise.firebaseapp.com",
            projectId: "ifix-enterprise",
            storageBucket: "ifix-enterprise.firebasestorage.app",
            messagingSenderId: "954001235629",
            appId: "1:954001235629:web:0cf28c5eeff9041e3ff024",
            measurementId: "G-RL6W0BGZDM"
        };

        // Initialize Firebase dengan error handling
        let app, auth, db;
        try {
            console.log('üîÑ Initializing Firebase...');
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('‚úÖ Firebase initialized successfully');
        } catch (error) {
            window.showError(
                'Firebase Initialization Error',
                'Gagal menginisialisasi Firebase.\nPeriksa koneksi internet atau konfigurasi.',
                error
            );
            throw error;
        }
        
        // Enable offline persistence dengan synchronizeTabs untuk cache data dan hemat kuota reads
        // Cache ini akan menyimpan data di browser, sehingga reload halaman tidak mengambil dari server
        enableIndexedDbPersistence(db, {
            synchronizeTabs: true // Allow multiple tabs to share cache
        }).catch((err) => {
            if (err.code === 'failed-precondition') {
                console.warn('‚ö†Ô∏è Persistence dengan synchronizeTabs aktif - beberapa tab terbuka');
                // Tidak perlu error karena ini wajar
            } else if (err.code === 'unimplemented') {
                console.warn('‚ö†Ô∏è Persistence tidak didukung di browser ini.');
                window.showError(
                    'Offline Persistence Warning',
                    'Browser tidak mendukung offline persistence.\nAplikasi tetap bisa digunakan, tapi data tidak di-cache.',
                    err
                );
            } else {
                console.error('‚ùå Persistence error:', err);
                window.showError(
                    'Persistence Error',
                    'Error saat mengaktifkan offline persistence.',
                    err
                );
            }
        });
        console.log('‚úÖ Firebase Offline Persistence AKTIF - Data akan di-cache di browser Anda');

        // ==========================================
        // üöÄ PWA SERVICE WORKER REGISTRATION
        // ==========================================
        let deferredPrompt;
        const installButton = document.createElement('button');
        installButton.id = 'pwa-install-btn';
        installButton.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            <span>Install Aplikasi</span>
        `;
        installButton.style.cssText = `
            position: fixed !important;
            bottom: 20px !important;
            right: 20px !important;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            border: none !important;
            padding: 12px 24px !important;
            border-radius: 50px !important;
            font-weight: bold !important;
            font-size: 14px !important;
            cursor: pointer !important;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4) !important;
            z-index: 999999 !important;
            display: none !important;
            align-items: center !important;
            gap: 8px !important;
            transition: all 0.3s ease !important;
            animation: pulse 2s infinite !important;
            pointer-events: auto !important;
        `;
        
        // Add pulse animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            #pwa-install-btn:hover {
                transform: scale(1.1) !important;
                box-shadow: 0 15px 35px rgba(102, 126, 234, 0.6) !important;
            }
        `;
        document.head.appendChild(style);
        document.body.appendChild(installButton);

        // Show install button immediately on page load for testing
        // Will hide if app is already installed or not supported
        setTimeout(() => {
            // Check if app is already installed
            if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true) {
                console.log('‚úÖ App already installed');
                installButton.style.display = 'none';
            } else {
                // Show button immediately (for testing and user awareness)
                installButton.style.display = 'flex';
                console.log('üöÄ Install button displayed');
            }
        }, 1000);

        // Listen for beforeinstallprompt event
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installButton.style.display = 'flex';
            console.log('‚úÖ PWA Install prompt ready');
        });

        // Handle install button click
        installButton.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            console.log('üñ±Ô∏è Install button clicked!');
            
            if (deferredPrompt) {
                // PWA install prompt tersedia
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    console.log('‚úÖ User accepted PWA install');
                    alert('‚úÖ Aplikasi berhasil diinstall!');
                } else {
                    console.log('‚ùå User dismissed PWA install');
                }
                
                deferredPrompt = null;
                installButton.style.display = 'none';
            } else {
                // Fallback: Berikan instruksi manual untuk Chrome
                const isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
                const isEdge = /Edg/.test(navigator.userAgent);
                
                if (isChrome || isEdge) {
                    alert(`üì± Cara Install Aplikasi:\n\n1. Klik icon ‚ãÆ (titik tiga) di pojok kanan atas browser\n2. Pilih "Install iFix Pro" atau "Add to Home Screen"\n3. Klik "Install"\n\n‚úÖ Aplikasi akan muncul seperti app native di device Anda!`);
                } else {
                    alert('‚ö†Ô∏è Untuk install aplikasi, gunakan Chrome atau Edge browser di Android/Windows/iOS.');
                }
            }
        });

        // Hide button when app is installed
        window.addEventListener('appinstalled', () => {
            installButton.style.display = 'none';
            console.log('‚úÖ PWA installed successfully');
        });

        // ==========================================
        // üîß SERVICE WORKER - DISABLED
        // ==========================================
        // Service Worker dinonaktifkan karena:
        // 1. File sw.js tidak ada di project
        // 2. Menyebabkan error di GitHub Codespaces (redirect issue)
        // 3. Firebase sudah handle offline persistence via IndexedDB
        // 
        // Jika ingin mengaktifkan:
        // 1. Buat file sw.js di root directory
        // 2. Uncomment kode di bawah
        // 3. Test di production environment
        
        // DISABLED: Service Worker Registration
        /*
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('‚úÖ Service Worker registered:', registration.scope);
                        registration.update();
                        setInterval(() => {
                            registration.update();
                        }, 60000);
                    })
                    .catch((error) => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        
        let refreshing = false;
        navigator.serviceWorker?.addEventListener('controllerchange', () => {
            if (!refreshing) {
                refreshing = true;
                console.log('üîÑ Service Worker updated, reloading...');
                window.location.reload();
            }
        });
        */
        
        console.log('‚ÑπÔ∏è Service Worker: Disabled (Firebase offline persistence active)');

        // Constants
        const SUPERADMIN_EMAIL = "agis.cpcd@gmail.com";
        const APP_COLLECTION_PREFIX = "ifix_enterprise_data"; 
        
        // ==========================================
        // üõ†Ô∏è UTILS
        // ==========================================
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n || 0);
        
        // Number formatter untuk input dengan separator ribuan
        const formatNumberWithSeparator = (value) => {
            if (!value) return '';
            const num = value.toString().replace(/\D/g, '');
            if (!num) return '';
            return new Intl.NumberFormat('id-ID').format(num);
        };
        
        const parseNumberFromInput = (value) => {
            if (!value) return 0;
            return parseInt(value.toString().replace(/\D/g, '')) || 0;
        };

        // ==========================================
        // üìÑ PAGINATION COMPONENT (Reusable)
        // ==========================================
        const Pagination = ({ currentPage, totalPages, totalItems, startIndex, endIndex, onPageChange, itemsPerPage, onItemsPerPageChange }) => {
            if (totalPages <= 1) return null;
            
            return (
                <div className="space-y-4">
                    {/* Items per page controls */}
                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => onItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => onItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                                <button onClick={() => onItemsPerPageChange(50)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 50 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>50</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                    </div>
                    
                    {/* Navigation */}
                    <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <button 
                            onClick={() => onPageChange(currentPage - 1)} 
                            disabled={currentPage === 1}
                            className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                        >
                            ‚Üê Sebelumnya
                        </button>
                        <div className="text-sm text-slate-600 font-medium">
                            Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                        </div>
                        <button 
                            onClick={() => onPageChange(currentPage + 1)} 
                            disabled={currentPage === totalPages}
                            className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                        >
                            Selanjutnya ‚Üí
                        </button>
                    </div>
                </div>
            );
        };
        
        // Custom number input component
        const NumberInput = ({ value, onChange, placeholder, className, ...props }) => {
            const [displayValue, setDisplayValue] = React.useState('');
            
            React.useEffect(() => {
                if (value || value === 0) {
                    setDisplayValue(formatNumberWithSeparator(value));
                } else {
                    setDisplayValue('');
                }
            }, [value]);
            
            const handleChange = (e) => {
                const input = e.target.value;
                const numericValue = parseNumberFromInput(input);
                
                // Update display value dengan separator
                setDisplayValue(formatNumberWithSeparator(numericValue));
                
                // Call onChange dengan angka asli
                if (onChange) {
                    onChange(numericValue);
                }
            };
            
            return (
                <input
                    type="text"
                    inputMode="numeric"
                    value={displayValue}
                    onChange={handleChange}
                    placeholder={placeholder || '0'}
                    className={className}
                    {...props}
                />
            );
        };
        
        const formatDate = (timestamp) => {
          if (!timestamp) return '-';
          let date;
          if (timestamp?.seconds) {
             date = new Date(timestamp.seconds * 1000);
          } else {
             date = new Date(timestamp);
          }
          if (isNaN(date.getTime())) return '-';
          return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        };

        const generateToken = () => Math.random().toString(36).substring(2, 8).toUpperCase();
        
        const STATUS_FLOW = ['Diterima', 'Diagnosa', 'Menunggu Sparepart', 'Selesai', 'Dibatalkan'];

        const formatWhatsAppNumber = (phone) => {
            if (!phone) return '';
            let p = phone.toString().replace(/\D/g, ''); 
            if (p.startsWith('0')) {
                p = '62' + p.substring(1);
            } else if (p.startsWith('8')) {
                p = '62' + p;
            }
            return p;
        };

        const handleShareProgress = (service) => {
            const formattedPhone = formatWhatsAppNumber(service.phone);
            
            if (!formattedPhone) {
                alert("‚ö†Ô∏è Nomor WA pelanggan kosong atau tidak valid!");
                return;
            }

            // Build detailed progress message
            const publicLink = `${window.location.origin}${window.location.pathname}?track=${service.id}`;
            
            let progressMessage = `Halo Kak ${service.customerName}! üëã\n\n`;
            progressMessage += `üì± *Update Progress Servis HP*\n`;
            progressMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
            progressMessage += `üÜî *Token:* ${service.token}\n`;
            progressMessage += `üì± *HP:* ${service.unitType || service.deviceType || '-'}\n`;
            progressMessage += `üîß *Keluhan:* ${service.complaint || service.problem || '-'}\n`;
            progressMessage += `‚öôÔ∏è *Status:* ${service.status}\n\n`;
            progressMessage += `üí∞ *Biaya Servis:* ${formatCurrency(service.costEstimate)}\n`;
            
            // Add payment status
            const paid = parseFloat(service.dp) || 0;
            const total = parseFloat(service.costEstimate) || 0;
            const remaining = total - paid;
            
            if (service.paymentStatus === 'Lunas') {
                progressMessage += `‚úÖ *Status Bayar:* LUNAS\n\n`;
            } else if (service.paymentStatus === 'DP') {
                progressMessage += `‚è≥ *Status Bayar:* DP ${formatCurrency(paid)}\n`;
                progressMessage += `üí≥ *Sisa Bayar:* ${formatCurrency(remaining)}\n\n`;
            } else {
                progressMessage += `‚è≥ *Status Bayar:* Belum Dibayar\n\n`;
            }
            
            progressMessage += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
            progressMessage += `üîó *Cek Progress Realtime:*\n${publicLink}\n\n`;
            progressMessage += `‚ú® Terimakasih telah mempercayakan servis HP kepada kami. Kami berkomitmen memberikan yang terbaik! üôè`;
            
            const encodedMessage = encodeURIComponent(progressMessage);
            const waLink = `https://wa.me/${formattedPhone}?text=${encodedMessage}`;
            window.open(waLink, '_blank');
        };

        const handleShareInvoiceToWA = async (service) => {
            const formattedPhone = formatWhatsAppNumber(service.phone);
            
            if (!formattedPhone) {
                alert("‚ö†Ô∏è Nomor WA pelanggan kosong atau tidak valid!");
                return;
            }

            // Generate invoice image FIRST
            setCaptureData(service);
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            try {
                const element = document.getElementById('invoice-capture');
                if (!element) {
                    alert("Gagal membuat invoice");
                    setCaptureData(null);
                    return;
                }

                const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff' });
                canvas.toBlob(async (blob) => {
                    setCaptureData(null);
                    
                    try {
                        const file = new File([blob], `Invoice-${service.token}.jpg`, { type: 'image/jpeg' });
                        
                        // Use native share API (mobile) - file will be attached, user just tap send
                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({
                                files: [file],
                                title: `Invoice ${service.customerName}`,
                                text: `Invoice servis untuk ${service.customerName}\nToken: ${service.token}`
                            });
                            return;
                        }
                        
                        // Desktop fallback: copy to clipboard then open WhatsApp
                        if (navigator.clipboard && navigator.clipboard.write) {
                            try {
                                const item = new ClipboardItem({ 'image/jpeg': blob });
                                await navigator.clipboard.write([item]);
                                
                                // Open WhatsApp after copying
                                const waLink = `https://wa.me/${formattedPhone}`;
                                window.open(waLink, '_blank');
                                
                                alert('‚úÖ Invoice sudah di-copy!\n\nPaste ke chat WA dengan Ctrl+V atau klik kanan > Paste');
                            } catch (err) {
                                // Fallback: download file
                                const link = document.createElement('a');
                                link.href = URL.createObjectURL(blob);
                                link.download = `Invoice-${service.token}.jpg`;
                                link.click();
                                
                                const waLink = `https://wa.me/${formattedPhone}`;
                                window.open(waLink, '_blank');
                                
                                alert('üì• Invoice sudah di-download!\n\nKirim file dari folder download ke chat WA');
                            }
                        }
                        
                    } catch (err) {
                        console.error('Share error:', err);
                    }
                }, 'image/jpeg', 0.95);
                
            } catch (err) {
                setCaptureData(null);
                console.error('Canvas error:', err);
            }
        };

        const showAccessDenied = (msg = "Akses Ditolak") => {
            alert(`üîí ${msg}`);
        };

        const normalizeFirestoreData = (data) => {
            if (!data) return data;
            if (typeof data === 'object') {
                if (data.seconds !== undefined && data.nanoseconds !== undefined) {
                    return new Date(data.seconds * 1000);
                }
                if (Array.isArray(data)) {
                    return data.map(normalizeFirestoreData);
                }
                const newItem = {};
                Object.keys(data).forEach(key => {
                    newItem[key] = normalizeFirestoreData(data[key]);
                });
                return newItem;
            }
            if (typeof data === 'string' && /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/.test(data)) {
                const d = new Date(data);
                if (!isNaN(d.getTime())) return d;
            }
            return data;
        };

        const recalculateServicePayment = async (serviceId, ownerId) => {
            if (!serviceId) return;
            try {
                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                const serviceSnap = await getDoc(serviceRef);
                if (!serviceSnap.exists()) return;
                const serviceData = serviceSnap.data();

                const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                const q = query(transRef, where('serviceId', '==', serviceId));
                const transSnap = await getDocs(q);
                
                let totalPaid = 0;
                transSnap.docs.forEach(doc => {
                    const t = doc.data();
                    if (t.type === 'income') totalPaid += (parseFloat(t.amount) || 0);
                });

                let paymentStatus = 'Belum Lunas';
                if (totalPaid >= (serviceData.costEstimate || 0) && (serviceData.costEstimate || 0) > 0) paymentStatus = 'Lunas';
                else if (totalPaid > 0) paymentStatus = 'DP';

                await updateDoc(serviceRef, {
                    dp: totalPaid,
                    paymentStatus: paymentStatus
                });
                console.log(`Service ${serviceId} synced. Total Paid: ${totalPaid}`);
            } catch (err) {
                console.error("Error syncing payment:", err);
            }
        };

        // ==========================================
        // ‚öõÔ∏è CONTEXT & HOOKS
        // ==========================================
        const SessionContext = createContext(null);
        const ToastContext = createContext(null);

        // Toast Notification System
        const Toast = ({ message, type = 'info', duration = 3000, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, duration);
                return () => clearTimeout(timer);
            }, [duration, onClose]);

            const bgColor = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500',
                sync: 'bg-purple-500'
            }[type] || 'bg-blue-500';

            return (
                <div className={`${bgColor} text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in`}>
                    {type === 'success' && <Check className="w-4 h-4"/>}
                    {type === 'error' && <X className="w-4 h-4"/>}
                    {type === 'warning' && <AlertTriangle className="w-4 h-4"/>}
                    {type === 'sync' && <RefreshCw className="w-4 h-4 animate-spin"/>}
                    <span className="text-sm font-medium">{message}</span>
                </div>
            );
        };

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            
            const showToast = (message, type = 'info', duration = 3000) => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, message, type, duration }]);
            };

            const removeToast = (id) => {
                setToasts(prev => prev.filter(t => t.id !== id));
            };

            return (
                <ToastContext.Provider value={{ showToast }}>
                    {children}
                    <div className="fixed bottom-6 right-6 space-y-2 z-[999]">
                        {toasts.map(toast => (
                            <Toast 
                                key={toast.id}
                                message={toast.message}
                                type={toast.type}
                                duration={toast.duration}
                                onClose={() => removeToast(toast.id)}
                            />
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        const useToast = () => {
            const context = useContext(ToastContext);
            if (!context) throw new Error('useToast must be used within ToastProvider');
            return context;
        };

        // Hook untuk monitor perubahan akses real-time
        const useAccessNotification = (userProfile) => {
            const { showToast } = useToast();
            const lastNotificationRef = useRef(null);

            useEffect(() => {
                if (!userProfile?.id || userProfile?.role === 'superadmin') return;

                const userRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'users', userProfile.id);
                
                const unsubscribe = onSnapshot(userRef, (docSnap) => {
                    if (!docSnap.exists()) return;
                    
                    const userData = docSnap.data();
                    const notification = userData?.notification;
                    
                    // Jika ada notifikasi baru tentang akses yang berubah
                    if (notification?.type === 'access_updated' && 
                        !notification?.acknowledged &&
                        lastNotificationRef.current !== notification?.timestamp) {
                        
                        lastNotificationRef.current = notification?.timestamp;
                        showToast(
                            'üîÑ Hak akses Anda telah diperbarui oleh Superadmin. Beberapa fitur mungkin terkunci.',
                            'sync',
                            4000
                        );
                        
                        // Mark notification as acknowledged
                        updateDoc(userRef, {
                            'notification.acknowledged': true
                        }).catch(e => console.error('Failed to acknowledge notification:', e));
                    }
                }, (error) => {
                    console.error('Error monitoring access notifications:', error);
                });

                return () => unsubscribe();
            }, [userProfile?.id, userProfile?.role, showToast]);
        };

        // ==========================================
        // üìä FIREBASE QUOTA TRACKING SYSTEM
        // ==========================================
        const QuotaTrackingContext = createContext();
        
        const QuotaTrackingProvider = ({children}) => {
            const [quotaStats, setQuotaStats] = useState(() => {
                const saved = localStorage.getItem('firebase_quota_stats');
                return saved ? JSON.parse(saved) : {
                    totalReads: 0,
                    cacheHits: 0,
                    serverReads: 0,
                    totalWrites: 0,
                    totalUpdates: 0,
                    totalDeletes: 0,
                    byCollection: {},
                    byCollectionWrites: {},
                    dailyStats: {},
                    lastReset: new Date().toISOString().split('T')[0]
                };
            });
            
            const trackRead = useCallback((collectionName, fromCache, count = 1) => {
                setQuotaStats(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Reset jika hari berbeda
                    if (prev.lastReset !== today) {
                        return {
                            totalReads: fromCache ? 0 : count,
                            cacheHits: fromCache ? count : 0,
                            serverReads: fromCache ? 0 : count,
                            totalWrites: 0,
                            totalUpdates: 0,
                            totalDeletes: 0,
                            byCollection: { [collectionName]: fromCache ? 0 : count },
                            byCollectionWrites: {},
                            dailyStats: {
                                ...prev.dailyStats,
                                [prev.lastReset]: {
                                    totalReads: prev.totalReads,
                                    serverReads: prev.serverReads,
                                    cacheHits: prev.cacheHits,
                                    totalWrites: prev.totalWrites,
                                    totalUpdates: prev.totalUpdates,
                                    totalDeletes: prev.totalDeletes
                                }
                            },
                            lastReset: today
                        };
                    }
                    
                    const updated = {
                        ...prev,
                        totalReads: prev.totalReads + count,
                        cacheHits: fromCache ? prev.cacheHits + count : prev.cacheHits,
                        serverReads: fromCache ? prev.serverReads : prev.serverReads + count,
                        byCollection: {
                            ...prev.byCollection,
                            [collectionName]: (prev.byCollection[collectionName] || 0) + (fromCache ? 0 : count)
                        }
                    };
                    
                    localStorage.setItem('firebase_quota_stats', JSON.stringify(updated));
                    return updated;
                });
            }, []);
            
            const trackWrite = useCallback((collectionName, operation = 'write', count = 1) => {
                setQuotaStats(prev => {
                    const today = new Date().toISOString().split('T')[0];
                    
                    // Reset jika hari berbeda
                    if (prev.lastReset !== today) {
                        return {
                            ...prev,
                            totalReads: prev.totalReads || 0,
                            cacheHits: prev.cacheHits || 0,
                            serverReads: prev.serverReads || 0,
                            totalWrites: operation === 'write' ? count : 0,
                            totalUpdates: operation === 'update' ? count : 0,
                            totalDeletes: operation === 'delete' ? count : 0,
                            byCollectionWrites: { [collectionName]: count },
                            dailyStats: {
                                ...prev.dailyStats,
                                [prev.lastReset]: {
                                    totalReads: prev.totalReads,
                                    serverReads: prev.serverReads,
                                    cacheHits: prev.cacheHits,
                                    totalWrites: prev.totalWrites,
                                    totalUpdates: prev.totalUpdates,
                                    totalDeletes: prev.totalDeletes
                                }
                            },
                            lastReset: today
                        };
                    }
                    
                    const updated = {
                        ...prev,
                        totalWrites: operation === 'write' ? (prev.totalWrites || 0) + count : (prev.totalWrites || 0),
                        totalUpdates: operation === 'update' ? (prev.totalUpdates || 0) + count : (prev.totalUpdates || 0),
                        totalDeletes: operation === 'delete' ? (prev.totalDeletes || 0) + count : (prev.totalDeletes || 0),
                        byCollectionWrites: {
                            ...prev.byCollectionWrites,
                            [collectionName]: ((prev.byCollectionWrites || {})[collectionName] || 0) + count
                        }
                    };
                    
                    localStorage.setItem('firebase_quota_stats', JSON.stringify(updated));
                    return updated;
                });
            }, []);
            
            const resetStats = useCallback(() => {
                const reset = {
                    totalReads: 0,
                    cacheHits: 0,
                    serverReads: 0,
                    totalWrites: 0,
                    totalUpdates: 0,
                    totalDeletes: 0,
                    byCollection: {},
                    byCollectionWrites: {},
                    dailyStats: {},
                    lastReset: new Date().toISOString().split('T')[0]
                };
                setQuotaStats(reset);
                localStorage.setItem('firebase_quota_stats', JSON.stringify(reset));
            }, []);
            
            return (
                <QuotaTrackingContext.Provider value={{ quotaStats, trackRead, trackWrite, resetStats }}>
                    {children}
                </QuotaTrackingContext.Provider>
            );
        };
        
        const useQuotaTracking = () => useContext(QuotaTrackingContext);
        
        // Helper functions untuk track writes otomatis
        const trackedAddDoc = async (collectionRef, data, quotaContext) => {
            const result = await addDoc(collectionRef, data);
            if (quotaContext) {
                const collectionName = collectionRef.path.split('/').pop();
                quotaContext.trackWrite(collectionName, 'write', 1);
            }
            return result;
        };
        
        const trackedUpdateDoc = async (docRef, data, quotaContext) => {
            const result = await updateDoc(docRef, data);
            if (quotaContext) {
                const collectionName = docRef.path.split('/')[docRef.path.split('/').length - 2];
                quotaContext.trackWrite(collectionName, 'update', 1);
            }
            return result;
        };
        
        const trackedDeleteDoc = async (docRef, quotaContext) => {
            const result = await deleteDoc(docRef);
            if (quotaContext) {
                const collectionName = docRef.path.split('/')[docRef.path.split('/').length - 2];
                quotaContext.trackWrite(collectionName, 'delete', 1);
            }
            return result;
        };

        const useFirestoreCollection = (collectionName, ownerId, storeId) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [fromCache, setFromCache] = useState(false);
            const quotaContext = useContext(QuotaTrackingContext);

            useEffect(() => {
                if (!collectionName) return;
                const colRef = collection(db, APP_COLLECTION_PREFIX, 'public', collectionName);
                
                // Untuk transactions, ambil semua data (no limit) agar keuntungan bisa ditampilkan
                // Untuk collection lain, gunakan limit 25 untuk lebih hemat
                const hasLimit = collectionName !== 'transactions';
                const limitCount = 25;
                
                // Query builder dengan fallback jika orderBy butuh index yang belum ada
                let q;
                if (ownerId) { 
                    try {
                        const constraints = [where('ownerId', '==', ownerId), orderBy('createdAt', 'desc')];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    } catch (e) {
                        console.warn(`OrderBy failed untuk ${collectionName}, fallback...`);
                        const constraints = [where('ownerId', '==', ownerId)];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    }
                } else {
                    try {
                        const constraints = [orderBy('createdAt', 'desc')];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    } catch (e) {
                        console.warn(`OrderBy failed untuk ${collectionName}, fallback...`);
                        const constraints = [];
                        if (hasLimit) constraints.push(limit(limitCount));
                        q = query(colRef, ...constraints);
                    }
                }
                
                const unsubscribe = onSnapshot(q, { includeMetadataChanges: true }, (snapshot) => {
                    // Deteksi apakah data dari cache (offline) atau server
                    const source = snapshot.metadata.fromCache ? 'cache' : 'server';
                    setFromCache(snapshot.metadata.fromCache);
                    
                    // Track quota usage
                    if (quotaContext && !snapshot.metadata.hasPendingWrites) {
                        quotaContext.trackRead(collectionName, snapshot.metadata.fromCache, snapshot.docs.length);
                    }
                    
                    // Jika data dari cache dan tidak ada perubahan, skip update untuk hemat resource
                    if (snapshot.metadata.fromCache && snapshot.metadata.hasPendingWrites === false && data.length > 0) {
                        setLoading(false);
                        return; // Data sudah ada di state, tidak perlu update
                    }
                    
                    let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    let filtered = items;
                    // Only filter by storeId if storeId is provided AND not null (null means "Semua"/all stores)
                    if (storeId !== undefined && storeId !== null) { 
                        filtered = filtered.filter(item => item.storeId === storeId); 
                    }
                    
                    // Client-side sort sebagai fallback
                    filtered.sort((a, b) => {
                        const tA = a.createdAt?.seconds || a.date?.seconds || 0;
                        const tB = b.createdAt?.seconds || b.date?.seconds || 0;
                        return tB - tA;
                    });
                    
                    setData(filtered);
                    setLoading(false);
                }, (error) => {
                    console.error(`Error fetching ${collectionName}:`, error);
                    // Fallback ke query tanpa orderBy dan limit jika ada error
                    const fallbackQ = ownerId 
                        ? query(colRef, where('ownerId', '==', ownerId))
                        : query(colRef);
                    
                    const fallbackUnsub = onSnapshot(fallbackQ, (snapshot) => {
                        let items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        let filtered = items;
                        if (storeId !== undefined && storeId !== null) { 
                            filtered = filtered.filter(item => item.storeId === storeId); 
                        }
                        filtered.sort((a, b) => {
                            const tA = a.createdAt?.seconds || a.date?.seconds || 0;
                            const tB = b.createdAt?.seconds || b.date?.seconds || 0;
                            return tB - tA;
                        });
                        setData(filtered);
                        setLoading(false);
                    }, (fallbackError) => {
                        console.error(`Fallback query failed untuk ${collectionName}:`, fallbackError);
                        setData([]);
                        setLoading(false);
                    });
                    return () => fallbackUnsub();
                });
                return () => unsubscribe();
            }, [collectionName, ownerId, storeId]);
            return { data, loading, fromCache };
        };

        
// ==========================================
// üîÑ REALTIME SYNC PLAN -> OWNER (OPTIONAL)
// ==========================================
// Jika owner.autoSyncPlan === true,
// maka perubahan plan_configs akan langsung update accessRights owner
const useRealtimePlanSync = (activeOwner) => {
  React.useEffect(() => {
    if (!activeOwner?.autoSyncPlan) return;
    if (!activeOwner?.plan || !activeOwner?.id) return;

    const unsub = onSnapshot(
      doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', activeOwner.plan),
      async (snap) => {
        if (!snap.exists()) return;
        try {
          await updateDoc(
            doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', activeOwner.id),
            { accessRights: snap.data() }
          );
          console.log('Owner accessRights synced with plan:', activeOwner.plan);
        } catch (e) {
          console.error('Sync plan error', e);
        }
      }
    );
    return () => unsub();
  }, [activeOwner?.id, activeOwner?.plan, activeOwner?.autoSyncPlan]);
};


const SessionProvider = ({ children }) => {
            const [authUser, setAuthUser] = useState(null); 
            const [userProfile, setUserProfile] = useState(null); 
            const [activeOwner, setActiveOwner] = useState(null); 
            const [activeStore, setActiveStore] = useState(null); 
            const [availableStores, setAvailableStores] = useState([]);
            const [ownerAccess, setOwnerAccess] = useState({});
            const [storeConfig, setStoreConfig] = useState({});
            const [loading, setLoading] = useState(true);
            const ownerUnsubRef = useRef(null);
            const storesUnsubRef = useRef(null);

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    setAuthUser(currentUser);
                    if (currentUser && !currentUser.isAnonymous) {
                        await fetchUserProfile(currentUser.email);
                    } else {
                        setUserProfile(null);
                        setActiveOwner(null);
                        setActiveStore(null);
                        if(ownerUnsubRef.current) ownerUnsubRef.current();
                        if(storesUnsubRef.current) storesUnsubRef.current();
                        setLoading(false);
                    }
                });
                return () => unsubscribe();
            }, []);

            const fetchUserProfile = async (email) => {
                try {
                    if (email.toLowerCase() === SUPERADMIN_EMAIL.toLowerCase()) {
                        const adminProfile = { uid: 'superadmin_master', email: email, name: 'Super Administrator', role: 'superadmin', ownerId: null };
                        setUserProfile(adminProfile);
                        setLoading(false);
                        return;
                    }
                    const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                    const q = query(usersRef, where('email', '==', email));
                    const snapshot = await getDocs(q); 

                    if (!snapshot.empty) {
                        const profile = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
                        setUserProfile(profile);
                        if (profile.role !== 'superadmin' && profile.ownerId) {
                            enterTenantContext(profile.ownerId, profile);
                        }
                    } else {
                        setUserProfile({ email: email, role: 'guest', name: 'Guest User' });
                    }
                } catch (err) {
                    console.error("Error fetching profile:", err);
                } finally {
                    setLoading(false);
                }
            };

            const enterTenantContext = (ownerId, specificUser = null) => {
                try {
                    const ownerRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', ownerId);
                    if (ownerUnsubRef.current) ownerUnsubRef.current();
                    
                    // Listener untuk owner doc - includes real-time accessRights update
                    ownerUnsubRef.current = onSnapshot(ownerRef, (docSnap) => {
                        if (docSnap.exists()) {
                            const ownerData = { id: docSnap.id, ...docSnap.data() };
                            setActiveOwner(ownerData);
                            setOwnerAccess(ownerData.accessRights || {});
                            
                            // Notifikasi jika ada perubahan akses
                            if (ownerData.updatedAt) {
                                console.log('‚úÖ Hak akses owner diperbarui secara real-time:', ownerData.accessRights);
                            }
                        } else {
                            handleLogout();
                        }
                    }, (error) => {
                        console.error('Error listening to owner:', error);
                    });

                    const storesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'stores');
                    const q = query(storesRef, where('ownerId', '==', ownerId));
                    if (storesUnsubRef.current) storesUnsubRef.current();

                    storesUnsubRef.current = onSnapshot(q, (snapshot) => {
                        const stores = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        let targetStore = null;
                        if (specificUser && specificUser.role !== 'owner' && specificUser.storeId) {
                            targetStore = stores.find(s => s.id === specificUser.storeId);
                            setAvailableStores(targetStore ? [targetStore] : []);
                        } else {
                            setAvailableStores(stores);
                            targetStore = stores[0];
                        }
                        
                        setActiveStore(prev => {
                            if (!prev) return targetStore;
                            const stillExists = stores.find(s => s.id === prev.id);
                            return stillExists ? prev : targetStore;
                        });
                        
                        const storeToLoad = activeStore || targetStore;
                        if (storeToLoad) fetchStoreConfig(storeToLoad.id);
                    });
                } catch (err) { console.error("Context Error:", err); }
            };

            const fetchStoreConfig = (storeId) => {
                 const unsub = onSnapshot(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), (snap) => {
                     const configs = snap.docs.map(d => d.data());
                     const conf = configs.find(c => c.storeId === storeId) || {
                         feature_share: true, feature_print: true, feature_delete: true, feature_stock_add: true
                     };
                     setStoreConfig(conf);
                 });
            };

            const switchStore = (storeId) => {
                if (storeId === null) {
                    // "Semua" - All stores mode
                    setActiveStore(null);
                    return;
                }
                const target = availableStores.find(s => s.id === storeId);
                if (target) {
                    setActiveStore(target);
                    fetchStoreConfig(target.id);
                }
            };

            const handleLogout = async () => {
                await signOut(auth);
                window.location.href = window.location.origin + window.location.pathname; 
            };

            const checkPermission = (featureKey) => {
                if (userProfile?.role === 'superadmin') return true;
                // Priority: Owner Access (Platform level) -> Store Config (Store level)
                if (ownerAccess && ownerAccess[featureKey] === false) return false;
                if (userProfile?.role === 'owner') return true;
                if (storeConfig && storeConfig[featureKey] === false) return false;
                return true;
            };

            return (
                <SessionContext.Provider value={{ 
                    user: userProfile, authUser, activeOwner, activeStore, availableStores, ownerAccess, storeConfig, 
                    switchStore, enterTenantContext, logout: handleLogout,
                    checkPermission, loading
                }}>
                    {children}
                </SessionContext.Provider>
            );
        };

        const PublicTrackingView = ({ token, onBack }) => {
            const [service, setService] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [store, setStore] = useState(null);

            useEffect(() => {
                const fetchData = async () => {
                    if (!auth.currentUser) { try { await signInAnonymously(auth); } catch(e) { console.error("Anon auth failed", e); } }
                    const servicesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'services');
                    try {
                        const q1 = query(servicesRef, where('token', '==', token));
                        const snap1 = await getDocs(q1);
                        let foundService = null;
                        if (!snap1.empty) foundService = { id: snap1.docs[0].id, ...snap1.docs[0].data() };
                        else {
                            const q2 = query(servicesRef, where('publicToken', '==', token));
                            const snap2 = await getDocs(q2);
                            if(!snap2.empty) foundService = { id: snap2.docs[0].id, ...snap2.docs[0].data() };
                        }
                        if (foundService) {
                            setService(foundService);
                            if(foundService.storeId) {
                                const storeSnap = await getDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', foundService.storeId));
                                if(storeSnap.exists()) setStore(storeSnap.data());
                            }
                        } else { setError('Data servis tidak ditemukan. Periksa kembali token Anda.'); }
                    } catch (err) { setError('Gagal memuat data. ' + err.message); } finally { setLoading(false); }
                };
                fetchData();
            }, [token]);

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50"><div className="text-center"><Loader2 className="w-10 h-10 animate-spin text-blue-600 mx-auto mb-4"/><p className="text-slate-500">Mencari Data Servis...</p></div></div>;
            if(error) return <div className="min-h-screen flex items-center justify-center bg-slate-50 p-6"><div className="bg-white p-8 rounded-2xl shadow-xl text-center max-w-md w-full"><div className="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4"><SearchX className="w-8 h-8"/></div><h2 className="text-xl font-bold text-slate-800 mb-2">Maaf!</h2><p className="text-slate-500 mb-6">{error}</p><button onClick={onBack} className="bg-slate-900 text-white px-6 py-3 rounded-xl font-bold w-full">Kembali</button></div></div>;
            const isDone = ['Selesai', 'Diambil'].includes(service.status);
            const statusColor = isDone ? 'bg-green-500' : service.status === 'Dibatalkan' ? 'bg-red-500' : 'bg-blue-500';
            return (
                <div className="min-h-screen bg-slate-100 py-10 px-4">
                    <div className="max-w-lg mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden border border-slate-200">
                        <div className="bg-slate-900 p-6 text-white text-center relative">{store?.logo ? <img src={store.logo} className="w-16 h-16 object-contain mx-auto mb-3 bg-white rounded-lg p-1"/> : <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center font-bold text-2xl mx-auto mb-3">iF</div>}<h1 className="font-bold text-xl">{store?.name || 'iFix Service Tracker'}</h1><p className="text-slate-400 text-xs mt-1">{store?.address}</p><div className="absolute top-4 right-4"><button onClick={onBack} className="text-slate-400 hover:text-white text-xs font-bold bg-slate-800 px-3 py-1 rounded-full">Login</button></div></div>
                        <div className="p-6"><div className="bg-slate-50 border border-slate-100 rounded-2xl p-5 mb-6 text-center shadow-inner"><p className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-2">Status Pengerjaan</p><div className={`inline-block px-6 py-2 rounded-full text-white font-bold text-lg shadow-lg ${statusColor} mb-2`}>{service.status}</div><p className="text-xs text-slate-500">Update Terakhir: {formatDate(service.updatedAt)}</p></div><div className="space-y-4 mb-8"><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-blue-100 p-2 rounded-lg text-blue-600"><UserPlus className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Pelanggan</p><p className="font-bold text-slate-800">{service.customerName}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-purple-100 p-2 rounded-lg text-purple-600"><Smartphone className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Perangkat</p><p className="font-bold text-slate-800">{service.unitType || service.deviceType}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Wrench className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Keluhan</p><p className="font-bold text-slate-800">{service.complaint || service.problem}</p></div></div></div><div className="flex justify-between items-center border-b border-slate-100 pb-3"><div className="flex items-center gap-3"><div className="bg-green-100 p-2 rounded-lg text-green-600"><Wallet className="w-5 h-5"/></div><div><p className="text-xs text-slate-400 font-bold">Biaya Estimasi</p><p className="font-bold text-green-600 text-lg">{formatCurrency(service.costEstimate)}</p></div></div></div></div><div><h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2"><Activity className="w-5 h-5 text-blue-500"/> Riwayat Status</h3><div className="space-y-0 pl-2"><div className="relative pl-8 pb-6 timeline-item"><div className="timeline-line"></div><div className="absolute left-0 top-0 w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm"><CheckCheck className="w-4 h-4"/></div><p className="font-bold text-sm text-slate-800">Diterima</p><p className="text-xs text-slate-500">{formatDate(service.createdAt)}</p></div>{service.status !== 'Diterima' && (<div className="relative pl-8 pb-0 timeline-item"><div className="absolute left-0 top-0 w-8 h-8 bg-green-100 text-green-600 rounded-full flex items-center justify-center border-2 border-white shadow-sm"><Activity className="w-4 h-4"/></div><p className="font-bold text-sm text-slate-800">{service.status}</p><p className="text-xs text-slate-500">{formatDate(service.updatedAt)}</p></div>)}</div></div></div><div className="bg-slate-50 p-4 text-center text-xs text-slate-400 border-t border-slate-200">&copy; 2026 iFix Enterprise Cloud</div></div></div>
            );
        };

        
// ================================
// PLAN CONFIG (SUPERADMIN)
// ================================
const PLAN_FEATURES = [
  { id: 'feature_delete', label: 'Hapus Data Servis' },
  { id: 'feature_print', label: 'Cetak Invoice' },
  { id: 'feature_share', label: 'Share WhatsApp' },
  { id: 'feature_stock_add', label: 'Tambah Stok Barang' },
  { id: 'menu_finance', label: 'Akses Menu Keuangan' },
  { id: 'feature_backup', label: 'Backup & Restore Data' },
  { id: 'feature_finance_edit', label: 'Edit & Hapus Keuangan' },
  { id: 'feature_employee_edit', label: 'Edit Data Pegawai' }
];

const PlanConfigModal = ({ close }) => {
  const [activePlan, setActivePlan] = React.useState('basic');
  const [config, setConfig] = React.useState({});
  const [loading, setLoading] = React.useState(false);

  React.useEffect(() => {
    const unsub = onSnapshot(
      doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', activePlan),
      (snap) => setConfig(snap.exists() ? snap.data() : {})
    );
    return () => unsub();
  }, [activePlan]);

  const toggle = (k) => setConfig(p => ({ ...p, [k]: !p[k] }));

  const save = async () => {
    setLoading(true);
    try {
      await setDoc(
        doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', activePlan),
        config,
        { merge: true }
      );
      alert(`Paket ${activePlan.toUpperCase()} disimpan`);
      close();
    } catch (e) {
      alert(e.message);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/70 backdrop-blur-sm z-[120] flex items-center justify-center p-4">
      <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl">
        <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
          <Crown className="w-5 h-5 text-yellow-400" />
          Pengaturan Paket
        </h3>
        <div className="flex gap-2 mb-4">
          {['basic','pro'].map(p => (
            <button key={p} onClick={() => setActivePlan(p)}
              className={`flex-1 py-2 rounded-lg font-bold uppercase text-xs ${activePlan===p?'bg-purple-600 text-white':'bg-slate-700 text-slate-400'}`}>
              {p}
            </button>
          ))}
        </div>
        <div className="space-y-3 max-h-[50vh] overflow-y-auto pr-1">
          {PLAN_FEATURES.map(f => (
            <label key={f.id} className="flex items-center justify-between bg-slate-900 p-3 rounded-lg border border-slate-700">
              <span className="text-slate-300 text-sm">{f.label}</span>
              <input type="checkbox" checked={!!config[f.id]} onChange={() => toggle(f.id)} className="accent-purple-600 w-5 h-5"/>
            </label>
          ))}
        </div>
        <div className="flex gap-3 mt-6">
          <button onClick={close} className="flex-1 py-2 border border-slate-600 rounded-lg text-slate-400 font-bold">Batal</button>
          <button onClick={save} disabled={loading} className="flex-1 py-2 bg-purple-600 text-white rounded-lg font-bold">
            {loading?'Menyimpan...':'Simpan'}
          </button>
        </div>
      </div>
    </div>
  );
};

const CategoryItemsModal = ({ close, ownerId, storeId }) => {
    const [categories, setCategories] = useState(['Sparepart', 'Aksesori', 'Tools', 'Lainnya']);
    const [customCategories, setCustomCategories] = useState([]);
    const [newCategory, setNewCategory] = useState('');
    const [loading, setLoading] = useState(false);
    const [deleting, setDeleting] = useState(null);

    useEffect(() => {
        if (!ownerId) return;
        // Load custom categories from Firestore
        let q;
        if (storeId) {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
        } else {
            q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
        }
        const unsubscribe = onSnapshot(q, (snapshot) => {
            const configs = snapshot.docs.map(doc => doc.data());
            const allCats = new Set([...categories]);
            configs.forEach(config => {
                if (config.customCategories && Array.isArray(config.customCategories)) {
                    config.customCategories.forEach(cat => allCats.add(cat));
                }
            });
            setCustomCategories(Array.from(allCats).filter(c => !categories.includes(c)));
        });
        return unsubscribe;
    }, [ownerId, storeId]);

    const addCategory = async (e) => {
        e.preventDefault();
        if (!newCategory.trim()) return;
        if ([...categories, ...customCategories].includes(newCategory)) {
            alert('Kategori sudah ada!');
            return;
        }

        setLoading(true);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId), limit(1));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), limit(1));
            }
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                const configData = {
                    ownerId: ownerId,
                    customCategories: [newCategory],
                    createdAt: serverTimestamp()
                };
                if (storeId) configData.storeId = storeId;
                await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), configData);
            } else {
                const docRef = snapshot.docs[0].ref;
                const existing = snapshot.docs[0].data().customCategories || [];
                if (!existing.includes(newCategory)) {
                    await updateDoc(docRef, {
                        customCategories: [...existing, newCategory]
                    });
                }
            }
            setNewCategory('');
            alert('Kategori berhasil ditambahkan!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setLoading(false);
        }
    };

    const deleteCategory = async (category) => {
        if (!confirm(`Hapus kategori "${category}"?`)) return;
        
        setDeleting(category);
        try {
            let q;
            if (storeId) {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId), where('storeId', '==', storeId));
            } else {
                q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('ownerId', '==', ownerId));
            }
            const snapshot = await getDocs(q);
            
            for (const docSnap of snapshot.docs) {
                const existing = docSnap.data().customCategories || [];
                const updated = existing.filter(c => c !== category);
                await updateDoc(docSnap.ref, { customCategories: updated });
            }
            alert('Kategori berhasil dihapus!');
        } catch(err) {
            alert('Gagal: ' + err.message);
        } finally {
            setDeleting(null);
        }
    };

    const allCategories = [...categories, ...customCategories];

    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="sticky top-0 bg-gradient-to-r from-orange-600 to-orange-500 p-6 text-white flex items-center justify-between">
                    <h2 className="font-bold text-xl flex items-center gap-2"><Tag className="w-6 h-6"/> Kelola Kategori Stok</h2>
                    <button onClick={close} className="p-1 hover:bg-white/20 rounded-lg"><X className="w-6 h-6"/></button>
                </div>

                <div className="p-6 space-y-4">
                    <form onSubmit={addCategory} className="flex gap-2 mb-6">
                        <input 
                            type="text" 
                            placeholder="Tambah kategori baru..."
                            value={newCategory}
                            onChange={e => setNewCategory(e.target.value)}
                            className="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:border-orange-500"
                        />
                        <button 
                            type="submit"
                            disabled={loading || !newCategory.trim()}
                            className="px-6 py-2 bg-orange-600 text-white font-bold rounded-lg hover:bg-orange-700 disabled:opacity-50"
                        >
                            {loading ? <Loader2 className="w-4 h-4 animate-spin" /> : '+'}
                        </button>
                    </form>

                    <div className="space-y-2">
                        <h3 className="font-bold text-slate-700 mb-3">Kategori Tersedia ({allCategories.length})</h3>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                            {allCategories.map((cat, idx) => (
                                <div 
                                    key={idx}
                                    className="flex items-center justify-between p-3 bg-slate-100 rounded-lg border border-slate-200"
                                >
                                    <span className="text-sm font-bold text-slate-700">{cat}</span>
                                    {!categories.includes(cat) && (
                                        <button
                                            onClick={() => deleteCategory(cat)}
                                            disabled={deleting === cat}
                                            className="p-1 hover:bg-red-100 rounded text-red-600 disabled:opacity-50"
                                        >
                                            <Trash2 className="w-4 h-4" />
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>

                    <p className="text-xs text-slate-500 mt-4 italic">* Kategori default (Sparepart, Aksesori, Tools, Lainnya) tidak dapat dihapus</p>
                </div>

                <div className="bg-slate-100 p-4 flex gap-2 justify-end sticky bottom-0">
                    <button onClick={close} className="px-6 py-2 bg-white border border-slate-300 rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const QCFunctionalItemsModal = ({ close, ownerId }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), where('ownerId', '==', ownerId)),
            (snap) => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        return () => unsub();
    }, [ownerId]);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), {
                name: newItem, ownerId, createdAt: serverTimestamp()
            });
            setNewItem('');
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-4 text-slate-800">Kelola QC Cek Fungsional</h3>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nama item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.map(item => (
                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
                            <span className="font-medium text-slate-800">{item.name}</span>
                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const MasterKelengkapanModal = ({ close }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items'), orderBy('createdAt', 'desc')),
            (snap) => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        return () => unsub();
    }, []);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items'), {
                name: newItem, createdAt: serverTimestamp()
            });
            setNewItem('');
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-2 text-slate-800">Master Data Kelengkapan</h3>
                <p className="text-sm text-slate-600 mb-4">Kelola item kelengkapan default untuk semua owner</p>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Tambah item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-teal-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-teal-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.length === 0 ? (
                        <p className="text-center text-slate-400 py-8">Belum ada item master</p>
                    ) : (
                        items.map(item => (
                            <div key={item.id} className="flex justify-between items-center p-3 bg-teal-50 border border-teal-200 rounded-lg">
                                <span className="font-medium text-slate-800">{item.name}</span>
                                <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                            </div>
                        ))
                    )}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const KelengkapanItemsModal = ({ close, ownerId }) => {
    const [items, setItems] = useState([]);
    const [newItem, setNewItem] = useState('');
    const [loading, setLoading] = useState(false);

    useEffect(() => {
        if (!ownerId) return;
        const unsub = onSnapshot(
            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), where('ownerId', '==', ownerId)),
            (snap) => setItems(snap.docs.map(d => ({ id: d.id, ...d.data() })))
        );
        return () => unsub();
    }, [ownerId]);

    const addItem = async () => {
        if (!newItem.trim()) return;
        setLoading(true);
        try {
            await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), {
                name: newItem, ownerId, createdAt: serverTimestamp()
            });
            setNewItem('');
        } finally { setLoading(false); }
    };

    const deleteItem = async (id) => {
        try { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items', id)); } catch (e) { alert(e.message); }
    };

    return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4">
            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <h3 className="font-bold text-xl mb-4 text-slate-800">Kelola Cek Kelengkapan</h3>
                <div className="flex gap-2 mb-4">
                    <input value={newItem} onChange={e => setNewItem(e.target.value)} placeholder="Nama item..." className="flex-1 border border-slate-300 p-2 rounded-lg text-sm text-slate-800 placeholder-slate-400 focus:outline-blue-500 bg-white"/>
                    <button onClick={addItem} disabled={loading} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700"><Plus className="w-4 h-4"/></button>
                </div>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                    {items.map(item => (
                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-100 rounded-lg">
                            <span className="font-medium text-slate-800">{item.name}</span>
                            <button onClick={() => deleteItem(item.id)} className="text-red-600 hover:text-red-700"><Trash2 className="w-4 h-4"/></button>
                        </div>
                    ))}
                </div>
                <div className="mt-6 flex gap-3">
                    <button onClick={close} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-800 hover:bg-slate-50">Tutup</button>
                </div>
            </div>
        </div>
    );
};

const SuperAdminDashboard = () => {
             const { logout, enterTenantContext } = useContext(SessionContext);
             const { data: owners } = useFirestoreCollection('owners');
             const quotaTracking = useQuotaTracking();
             const quotaStats = quotaTracking?.quotaStats || {
                 totalReads: 0,
                 cacheHits: 0,
                 serverReads: 0,
                 totalWrites: 0,
                 totalUpdates: 0,
                 totalDeletes: 0,
                 byCollection: {},
                 byCollectionWrites: {},
                 dailyStats: {}
             };
             const resetStats = quotaTracking?.resetStats || (() => {});
             const [modal, setModal] = useState(null); 
             const [selectedOwner, setSelectedOwner] = useState(null);
             const [selectedOwnerUser, setSelectedOwnerUser] = useState(null);
             const [loading, setLoading] = useState(false);
             
             // Calculate quota metrics
             const FREE_TIER_READS_LIMIT = 50000;
             const FREE_TIER_WRITES_LIMIT = 20000;
             const totalWrites = (quotaStats.totalWrites || 0) + (quotaStats.totalUpdates || 0) + (quotaStats.totalDeletes || 0);
             const readsPercentage = ((quotaStats.serverReads / FREE_TIER_READS_LIMIT) * 100).toFixed(2);
             const writesPercentage = ((totalWrites / FREE_TIER_WRITES_LIMIT) * 100).toFixed(2);
             const cacheEfficiency = quotaStats.totalReads > 0 
                 ? ((quotaStats.cacheHits / quotaStats.totalReads) * 100).toFixed(1)
                 : 0;
             
             // Daily stats for chart
             const dailyChartData = Object.entries(quotaStats.dailyStats || {})
                 .slice(-7)
                 .map(([date, stats]) => ({
                     date: new Date(date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }),
                     reads: stats.serverReads || 0,
                     writes: (stats.totalWrites || 0) + (stats.totalUpdates || 0) + (stats.totalDeletes || 0)
                 }));
             
             // Add today's data
             if (quotaStats.serverReads > 0 || quotaStats.cacheHits > 0 || totalWrites > 0) {
                 dailyChartData.push({
                     date: 'Hari Ini',
                     reads: quotaStats.serverReads,
                     writes: totalWrites
                 });
             }
             
             // Collection breakdown for reads
             const collectionReadsData = Object.entries(quotaStats.byCollection || {})
                 .filter(([_, count]) => count > 0)
                 .map(([name, value]) => ({ name, value }))
                 .sort((a, b) => b.value - a.value);
             
             // Collection breakdown for writes
             const collectionWritesData = Object.entries(quotaStats.byCollectionWrites || {})
                 .filter(([_, count]) => count > 0)
                 .map(([name, value]) => ({ name, value }))
                 .sort((a, b) => b.value - a.value);

             const createOwner = async (e) => { 
                 e.preventDefault(); 
                 setLoading(true); 
                 const formData = new FormData(e.target); 
                 const ownerName = formData.get('name'); 
                 const ownerEmail = formData.get('email'); 
                 const password = formData.get('password'); 
                 const personalName = formData.get('ownerName'); 
                 const plan = formData.get('plan'); 
                 
                 // üî• DEFINISI HAK AKSES DARI PLAN_CONFIGS (DINAMIS)
                 const planSnap = await getDoc(
                     doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', plan)
                 );
                 if (!planSnap.exists()) {
                     alert(`‚ùå Paket "${plan.toUpperCase()}" belum dikonfigurasi. Silakan atur Pengaturan Paket terlebih dahulu.`);
                     setLoading(false);
                     return;
                 }
                 const defaultAccessRights = planSnap.data();

                 try { 
                     let newUid = null; 
                     const secondaryApp = initializeApp(firebaseConfig, "Secondary"); 
                     const secondaryAuth = getAuth(secondaryApp); 
                     try { 
                         const userCred = await createUserWithEmailAndPassword(secondaryAuth, ownerEmail, password); 
                         newUid = userCred.user.uid; 
                         await signOut(secondaryAuth); 
                     } catch(authErr) { 
                         if(authErr.code === 'auth/email-already-in-use') { throw new Error("Email ini sudah terdaftar di sistem Authentication."); } 
                         throw authErr; 
                     } finally { 
                         await deleteApp(secondaryApp); 
                     } 
                     
                     const ownerRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'owners'), { 
                         name: ownerName, 
                         email: ownerEmail, 
                         plan: plan, 
                         status: 'active', 
                         createdAt: serverTimestamp(), 
                         accessRights: defaultAccessRights 
                     }); 
                     
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), { 
                         ownerId: ownerRef.id, 
                         name: `${ownerName} - Pusat`, 
                         address: 'Alamat Default', 
                         phone: '-', 
                         createdAt: serverTimestamp() 
                     }); 
                     
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), { 
                         uid: newUid, 
                         email: ownerEmail, 
                         name: personalName, 
                         role: 'owner', 
                         ownerId: ownerRef.id, 
                         storeId: null, 
                         createdAt: serverTimestamp() 
                     }); 
                     
                     alert(`‚úÖ SUKSES!\n\nTenant: ${ownerName}\nPlan: ${plan.toUpperCase()}\n\nUser telah dibuat. Default Access Rights disesuaikan dengan Plan.`); 
                     setModal(null); 
                 } catch (err) { 
                     alert("Gagal: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
             };
             
             const handleEditClick = async (owner) => {
                 setLoading(true);
                 try {
                     const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                     const q = query(usersRef, where('ownerId', '==', owner.id), where('role', '==', 'owner'));
                     const snap = await getDocs(q);
                     if (!snap.empty) {
                         setSelectedOwnerUser({ id: snap.docs[0].id, ...snap.docs[0].data() });
                     } else {
                         setSelectedOwnerUser(null);
                     }
                     setSelectedOwner(owner);
                     setModal('edit');
                 } catch (e) {
                     alert("Error mengambil data user owner: " + e.message);
                 } finally {
                     setLoading(false);
                 }
             };

             const updateOwner = async (e) => { 
                 e.preventDefault(); 
                 setLoading(true); 
                 const formData = new FormData(e.target); 
                 try { 
                     
                 // üîÑ AUTO SYNC ACCESS RIGHTS DENGAN PLAN
                 const plan = formData.get('plan');
                 const planSnap = await getDoc(
                     doc(db, APP_COLLECTION_PREFIX, 'public', 'plan_configs', plan)
                 );
                 if (!planSnap.exists()) {
                     alert(`‚ùå Paket "${plan.toUpperCase()}" belum dikonfigurasi.`);
                     setLoading(false);
                     return;
                 }
                 const accessRights = planSnap.data();

                 await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', selectedOwner.id), {
                         accessRights: accessRights, 
                         name: formData.get('name'), 
                         email: formData.get('email'),
                         plan: formData.get('plan'), 
                     }); 
                     if (selectedOwnerUser) {
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', selectedOwnerUser.id), {
                             name: formData.get('ownerName'), 
                             email: formData.get('email')
                         });
                     }
                     alert("Data Owner & Profil Berhasil Diperbarui!"); 
                     setModal(null); 
                 } catch(err) { 
                     alert("Gagal update: " + err.message); 
                 } finally { 
                     setLoading(false); 
                 } 
        };
             
             const deleteTenant = async (ownerId, ownerName) => { if (!confirm(`‚ö†Ô∏è BAHAYA!\n\nAnda yakin ingin menghapus Tenant: ${ownerName}?\n\nTindakan ini akan menghapus:\n- Data Owner\n- Data Toko (Cabang)\n- Data User (Pegawai)\n\nData tidak dapat dikembalikan!`)) return; setLoading(true); try { const usersQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), where('ownerId', '==', ownerId)); const usersSnap = await getDocs(usersQ); const userDeletions = usersSnap.docs.map(d => deleteDoc(d.ref)); await Promise.all(userDeletions); const storesQ = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), where('ownerId', '==', ownerId)); const storesSnap = await getDocs(storesQ); const storeDeletions = storesSnap.docs.map(d => deleteDoc(d.ref)); await Promise.all(storeDeletions); await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', ownerId)); alert(`Tenant ${ownerName} berhasil dihapus permanen.`); } catch(err) { alert("Gagal menghapus tenant: " + err.message); } finally { setLoading(false); } };
             const updateAccess = async (e) => { 
                 e.preventDefault(); 
                 if (!selectedOwner) return; 
                 
                 const newRights = { 
                     feature_delete: e.target.feature_delete.checked, 
                     feature_print: e.target.feature_print.checked, 
                     feature_share: e.target.feature_share.checked, 
                     feature_stock_add: e.target.feature_stock_add.checked, 
                     menu_finance: e.target.menu_finance.checked, 
                     feature_backup: e.target.feature_backup.checked, 
                     feature_finance_edit: e.target.feature_finance_edit.checked, 
                     feature_employee_edit: e.target.feature_employee_edit.checked, 
                     menu_dashboard: e.target.menu_dashboard.checked, 
                     menu_report: e.target.menu_report.checked, 
                     feature_service_edit: e.target.feature_service_edit.checked, 
                     feature_sales_edit: e.target.feature_sales_edit.checked, 
                     feature_inventory_edit: e.target.feature_inventory_edit.checked, 
                     feature_customer_edit: e.target.feature_customer_edit.checked 
                 }; 
                 
                 try { 
                     setLoading(true);
                     
                     // Update accessRights di owner doc
                     await updateDoc(
                         doc(db, APP_COLLECTION_PREFIX, 'public', 'owners', selectedOwner.id), 
                         { accessRights: newRights, updatedAt: serverTimestamp() }
                     );
                     
                     // Broadcast notification ke semua user di tenant ini
                     const usersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'users');
                     const usersQ = query(usersRef, where('ownerId', '==', selectedOwner.id));
                     const usersSnap = await getDocs(usersQ);
                     
                     const now = new Date();
                     const batch = writeBatch(db);
                     
                     usersSnap.docs.forEach(userDoc => {
                         batch.update(userDoc.ref, {
                             'notification.type': 'access_updated',
                             'notification.message': 'Hak akses Anda telah diperbarui oleh Superadmin',
                             'notification.timestamp': serverTimestamp(),
                             'notification.acknowledged': false
                         });
                     });
                     
                     await batch.commit();
                     
                     alert("‚úÖ Hak akses Tenant diperbarui dan semua user sedang menerima notifikasi real-time!");
                     setModal(null);
                 } catch (err) { 
                     alert("Gagal update: " + err.message); 
                 } finally {
                     setLoading(false);
                 }
             };
             return (
                 <div className="min-h-screen bg-slate-900 text-white">
                     {loading && <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center"><Loader2 className="w-10 h-10 animate-spin text-purple-500"/></div>}
                     <header className="bg-slate-800 border-b border-slate-700 p-6 flex justify-between items-center shadow-lg sticky top-0 z-50">
                         <div className="flex items-center gap-4">
                             <div className="w-12 h-12 bg-purple-600 rounded-xl flex items-center justify-center shadow-lg shadow-purple-500/20"><Globe className="w-7 h-7 text-white"/></div>
                             <div>
                                 <h1 className="text-xl font-black tracking-tight">iFix Platform Manager</h1>
                                 <p className="text-xs text-purple-400 font-medium uppercase tracking-wider">Superadmin Control Panel</p>
                             </div>
                         </div>
                         <div className="flex items-center gap-4">
                             <div className="text-right">
                                 <p className="text-sm font-bold">Administrator</p>
                                 <p className="text-xs text-slate-400">{SUPERADMIN_EMAIL}</p>
                             </div>
                             <button onClick={()=>setModal('masterKelengkapan')} className="bg-teal-600 hover:bg-teal-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 mr-2">
                                 <Settings className="w-4 h-4"/> Master Lengkap
                             </button>
                             <button onClick={logout} className="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2">
                                 <LogOut className="w-4 h-4"/> Logout
                             </button>
                         </div>
                     </header>
                     
                     {/* Firebase Quota Monitoring Dashboard */}
                     <div className="px-8 pt-6 max-w-7xl mx-auto">
                         <div className="bg-gradient-to-br from-purple-900 to-slate-800 rounded-2xl p-6 border border-purple-500/30 shadow-2xl mb-6">
                             <div className="flex justify-between items-start mb-6">
                                 <div>
                                     <h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                                         <Activity className="w-6 h-6 text-purple-400"/>
                                         Firebase Quota Monitor
                                     </h2>
                                     <p className="text-purple-200 text-sm">Real-time tracking penggunaan Firebase Reads & Writes ‚Ä¢ Hari ini: {new Date().toLocaleDateString('id-ID')}</p>
                                 </div>
                                 <div className="flex gap-2">
                                     <button 
                                         onClick={() => {
                                             if (confirm('Reset semua statistik quota hari ini?')) resetStats();
                                         }}
                                         className="bg-red-600/50 hover:bg-red-600 px-4 py-2 rounded-lg text-white font-bold text-sm flex items-center gap-2 border border-red-400/30 transition-all">
                                         <RefreshCw className="w-4 h-4"/> Reset
                                     </button>
                                 </div>
                             </div>
                             
                             {/* Metrics Cards */}
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Reads</span>
                                         <Database className="w-4 h-4 text-blue-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">{quotaStats.serverReads.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">dari {FREE_TIER_READS_LIMIT.toLocaleString()} limit</div>
                                     <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                                         <div 
                                             className={`h-full transition-all ${readsPercentage > 80 ? 'bg-red-500' : readsPercentage > 50 ? 'bg-yellow-500' : 'bg-blue-500'}`}
                                             style={{width: `${Math.min(readsPercentage, 100)}%`}}
                                         ></div>
                                     </div>
                                     <div className="text-xs text-white font-bold mt-1">{readsPercentage}% terpakai</div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Writes</span>
                                         <Edit3 className="w-4 h-4 text-orange-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">{totalWrites.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">dari {FREE_TIER_WRITES_LIMIT.toLocaleString()} limit</div>
                                     <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                                         <div 
                                             className={`h-full transition-all ${writesPercentage > 80 ? 'bg-red-500' : writesPercentage > 50 ? 'bg-yellow-500' : 'bg-orange-500'}`}
                                             style={{width: `${Math.min(writesPercentage, 100)}%`}}
                                         ></div>
                                     </div>
                                     <div className="text-xs text-white font-bold mt-1">{writesPercentage}% terpakai</div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Write Detail</span>
                                         <TrendingUp className="w-4 h-4 text-pink-400"/>
                                     </div>
                                     <div className="text-xl font-black text-white mb-1">{totalWrites.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">total write operations</div>
                                     <div className="mt-2 space-y-1 text-xs">
                                         <div className="flex justify-between">
                                             <span className="text-green-400">‚ûï Creates:</span>
                                             <span className="text-white font-bold">{(quotaStats.totalWrites || 0).toLocaleString()}</span>
                                         </div>
                                         <div className="flex justify-between">
                                             <span className="text-blue-400">‚úèÔ∏è Updates:</span>
                                             <span className="text-white font-bold">{(quotaStats.totalUpdates || 0).toLocaleString()}</span>
                                         </div>
                                         <div className="flex justify-between">
                                             <span className="text-red-400">üóëÔ∏è Deletes:</span>
                                             <span className="text-white font-bold">{(quotaStats.totalDeletes || 0).toLocaleString()}</span>
                                         </div>
                                     </div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Cache Hits</span>
                                         <Zap className="w-4 h-4 text-green-400"/>
                                     </div>
                                     <div className="text-3xl font-black text-white mb-1">{quotaStats.cacheHits.toLocaleString()}</div>
                                     <div className="text-xs text-purple-300">data dari offline cache</div>
                                     <div className="mt-2 px-3 py-1 bg-green-500/20 border border-green-400/30 rounded-full text-xs font-bold text-green-300 inline-block">
                                         üíæ {cacheEfficiency}% Efficiency
                                     </div>
                                 </div>
                                 
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <div className="flex items-center justify-between mb-2">
                                         <span className="text-purple-200 text-xs font-bold uppercase">Estimasi Biaya</span>
                                         <DollarSign className="w-4 h-4 text-yellow-400"/>
                                     </div>
                                     <div className="text-2xl font-black text-white mb-1">
                                         {(() => {
                                             let cost = 0;
                                             if (quotaStats.serverReads > FREE_TIER_READS_LIMIT) {
                                                 cost += ((quotaStats.serverReads - FREE_TIER_READS_LIMIT) / 100000) * 0.36;
                                             }
                                             if (totalWrites > FREE_TIER_WRITES_LIMIT) {
                                                 cost += ((totalWrites - FREE_TIER_WRITES_LIMIT) / 100000) * 1.08;
                                             }
                                             return cost > 0 ? `$${cost.toFixed(2)}` : '$0.00';
                                         })()}
                                     </div>
                                     <div className="text-xs text-purple-300">
                                         {(() => {
                                             const overageReads = quotaStats.serverReads > FREE_TIER_READS_LIMIT ? quotaStats.serverReads - FREE_TIER_READS_LIMIT : 0;
                                             const overageWrites = totalWrites > FREE_TIER_WRITES_LIMIT ? totalWrites - FREE_TIER_WRITES_LIMIT : 0;
                                             if (overageReads > 0 || overageWrites > 0) {
                                                 return `overage: ${overageReads > 0 ? overageReads.toLocaleString() + ' reads' : ''} ${overageReads > 0 && overageWrites > 0 ? '+ ' : ''}${overageWrites > 0 ? overageWrites.toLocaleString() + ' writes' : ''}`;
                                             }
                                             return '‚úÖ Masih dalam free tier';
                                         })()}
                                     </div>
                                     <div className="mt-2 px-2 py-1 bg-purple-500/20 border border-purple-400/30 rounded text-xs text-purple-200">
                                         Reset: {new Date().toLocaleDateString('id-ID')}
                                     </div>
                                 </div>
                             </div>
                             
                             {/* Mini Charts */}
                             <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                 {/* Trend Chart */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                         <TrendingUp className="w-4 h-4 text-blue-400"/>
                                         Trend 7 Hari Terakhir (Reads vs Writes)
                                     </h3>
                                     {dailyChartData.length > 0 ? (
                                         <ResponsiveContainer width="100%" height={180}>
                                             <BarChart data={dailyChartData}>
                                                 <CartesianGrid strokeDasharray="3 3" stroke="#475569" />
                                                 <XAxis dataKey="date" tick={{fill: '#cbd5e1', fontSize: 11}} />
                                                 <YAxis tick={{fill: '#cbd5e1', fontSize: 11}} />
                                                 <Tooltip 
                                                     contentStyle={{
                                                         backgroundColor: '#1e293b',
                                                         border: '1px solid #475569',
                                                         borderRadius: '8px',
                                                         color: '#fff'
                                                     }}
                                                 />
                                                 <Bar dataKey="reads" fill="#3b82f6" name="Reads" />
                                                 <Bar dataKey="writes" fill="#f97316" name="Writes" />
                                             </BarChart>
                                         </ResponsiveContainer>
                                     ) : (
                                         <div className="h-180 flex items-center justify-center text-purple-300 text-sm">
                                             Belum ada data tracking
                                         </div>
                                     )}
                                 </div>
                                 
                                 {/* Collection Breakdown - Reads */}
                                 <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20">
                                     <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                         <Database className="w-4 h-4 text-blue-400"/>
                                         Breakdown Reads per Collection
                                     </h3>
                                     {collectionReadsData.length > 0 ? (
                                         <div className="space-y-2">
                                             {collectionReadsData.map((item, idx) => {
                                                 const percentage = ((item.value / quotaStats.serverReads) * 100).toFixed(1);
                                                 const colors = ['bg-blue-500', 'bg-purple-500', 'bg-pink-500', 'bg-cyan-500', 'bg-green-500'];
                                                 return (
                                                     <div key={idx} className="flex items-center gap-3">
                                                         <div className="flex-1">
                                                             <div className="flex justify-between mb-1">
                                                                 <span className="text-xs font-bold text-white capitalize">{item.name}</span>
                                                                 <span className="text-xs text-purple-300">{item.value.toLocaleString()} ({percentage}%)</span>
                                                             </div>
                                                             <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                                                 <div 
                                                                     className={`h-full ${colors[idx % colors.length]} transition-all`}
                                                                     style={{width: `${percentage}%`}}
                                                                 ></div>
                                                             </div>
                                                         </div>
                                                     </div>
                                                 );
                                             })}
                                         </div>
                                     ) : (
                                         <div className="h-40 flex items-center justify-center text-purple-300 text-sm">
                                             Belum ada server reads
                                         </div>
                                     )}
                                 </div>
                             </div>
                             
                             {/* Collection Breakdown - Writes */}
                             <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 border border-white/20 mt-4">
                                 <h3 className="text-white font-bold mb-3 flex items-center gap-2">
                                     <Edit3 className="w-4 h-4 text-orange-400"/>
                                     Breakdown Writes per Collection
                                 </h3>
                                 {collectionWritesData.length > 0 ? (
                                     <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                         {collectionWritesData.map((item, idx) => {
                                                 const percentage = ((item.value / totalWrites) * 100).toFixed(1);
                                                 const colors = ['bg-orange-500', 'bg-amber-500', 'bg-yellow-500', 'bg-red-500', 'bg-pink-500'];
                                                 return (
                                                     <div key={idx} className="bg-slate-900/50 rounded-lg p-3 border border-slate-700">
                                                         <div className="flex justify-between items-center mb-2">
                                                             <span className="text-sm font-bold text-white capitalize">{item.name}</span>
                                                             <span className={`px-2 py-0.5 rounded text-xs font-bold ${colors[idx % colors.length]} text-white`}>
                                                                 {percentage}%
                                                             </span>
                                                         </div>
                                                         <div className="text-2xl font-black text-orange-400">{item.value.toLocaleString()}</div>
                                                         <div className="text-xs text-slate-400 mt-1">write operations</div>
                                                     </div>
                                                 );
                                             })}
                                     </div>
                                 ) : (
                                     <div className="h-32 flex items-center justify-center text-purple-300 text-sm">
                                         Belum ada write operations
                                     </div>
                                 )}
                             </div>
                             
                             {/* Tips */}
                             <div className="mt-4 bg-blue-500/10 border border-blue-400/30 rounded-lg p-3">
                                 <div className="flex items-start gap-2">
                                     <Info className="w-4 h-4 text-blue-400 mt-0.5 flex-shrink-0"/>
                                     <div className="text-xs text-blue-200">
                                         <strong>üí° Tips:</strong> Free Tier: 50k reads + 20k writes/hari. 
                                         Cache Hits (hijau) tidak mengurangi quota. Overage: Reads $0.36/100k, Writes $1.08/100k.
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                     
                     <main className="p-8 max-w-7xl mx-auto"> <div className="flex justify-between items-end mb-8"><div><h2 className="text-3xl font-bold mb-2">Daftar Tenant (Owner)</h2><p className="text-slate-400">Kelola bisnis dan hak akses setiap owner.</p></div><button onClick={()=>{setModal('create')}} className="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-all hover:scale-105 shadow-lg shadow-purple-900/50"><Plus className="w-5 h-5"/> Buat Owner Baru</button></div> <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"> {owners.map(owner => ( <div key={owner.id} className="bg-slate-800 border border-slate-700 rounded-2xl p-6 hover:border-purple-500 transition-all group relative overflow-hidden flex flex-col"> <div className="flex justify-between items-start mb-4 relative z-10"> <div className="w-12 h-12 rounded-full bg-slate-700 flex items-center justify-center font-bold text-xl text-purple-400 border border-slate-600">{owner.name?.charAt(0)}</div> <div className="flex gap-2"> <button onClick={()=>{handleEditClick(owner)}} className="bg-blue-900/50 hover:bg-blue-800 text-blue-300 p-2 rounded-lg transition-colors"><Pencil className="w-3 h-3"/></button> <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase pt-1.5 border ${owner.plan === 'pro' ? 'bg-purple-900/50 text-purple-300 border-purple-500/30' : 'bg-slate-700 text-slate-400 border-slate-600'}`}>{owner.plan}</span> </div> </div> <h3 className="text-xl font-bold mb-1">{owner.name}</h3><p className="text-slate-400 text-sm mb-6 flex items-center gap-2"><MessageCircle className="w-3 h-3"/> {owner.email}</p> <div className="grid grid-cols-3 gap-2 mb-4"><button onClick={() => { setSelectedOwner(owner); setModal('access'); }} className="bg-slate-700 hover:bg-slate-600 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors border border-slate-600"><Key className="w-3 h-3"/> Akses</button><button onClick={() => { setSelectedOwner(owner); setModal('qcItems'); }} className="bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors"><ShieldCheck className="w-3 h-3"/> QC</button><button onClick={() => { setSelectedOwner(owner); setModal('kelengkapanItems'); }} className="bg-cyan-600 hover:bg-cyan-700 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors"><CheckCircle className="w-3 h-3"/> Lengkap</button></div><button onClick={() => enterTenantContext(owner.id)} className="bg-blue-600 hover:bg-blue-500 text-white py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 transition-colors mb-2"><Eye className="w-3 h-3"/> Masuk (Spy)</button> <button onClick={() => deleteTenant(owner.id, owner.name)} className="mt-auto w-full py-2 bg-red-900/30 text-red-400 border border-red-900/50 hover:bg-red-900/50 rounded-lg text-xs font-bold flex items-center justify-center gap-2"><Trash2 className="w-3 h-3"/> Hapus Tenant</button> </div> ))} </div> </main> { (modal === 'create' || modal === 'edit') && ( <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"> <div className="bg-slate-800 border border-slate-700 w-full max-w-md rounded-2xl p-6 shadow-2xl"> <h3 className="font-bold text-xl mb-6 text-white">{modal === 'create' ? 'Registrasi Owner Baru' : 'Edit Data Owner'}</h3> <form onSubmit={modal === 'create' ? createOwner : updateOwner} className="space-y-4"> <input name="name" defaultValue={selectedOwner?.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Nama Bisnis / Toko" required/> <input name="ownerName" defaultValue={selectedOwnerUser?.name} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Nama Pemilik" required/> <input name="email" type="email" defaultValue={selectedOwner?.email} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Email Login Owner" required/> {modal === 'create' && <input name="password" type="password" className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white placeholder-slate-500 focus:border-purple-500 outline-none" placeholder="Password Login (Min 6 Karakter)" required minLength="6"/>} <div className="grid grid-cols-1 gap-2"> <label className="text-xs text-slate-400 font-bold uppercase">Pilih Paket Langganan</label> <select name="plan" defaultValue={selectedOwner?.plan || 'basic'} className="w-full bg-slate-900 border border-slate-600 rounded-lg p-3 text-white focus:border-purple-500 outline-none"> <option value="basic">Basic Plan (Max 1 Cabang, No Backup)</option> <option value="pro">Pro Plan (Unlimited, Full Akses)</option> </select> </div> <div className="flex gap-3 mt-6"> <button type="button" onClick={()=>{setModal(null); setSelectedOwner(null); setSelectedOwnerUser(null);}} className="flex-1 py-3 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700">Batal</button> <button disabled={loading} className="flex-1 py-3 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 shadow-lg shadow-purple-900/50 flex items-center justify-center gap-2"> {loading && <Loader2 className="w-4 h-4 animate-spin"/>} {modal === 'create' ? 'Buat Tenant' : 'Simpan Perubahan'} </button> </div> </form> </div> </div> ) } {modal === 'access' && selectedOwner && ( <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center p-4"><div className="bg-slate-800 border border-slate-700 w-full max-w-2xl rounded-2xl shadow-2xl max-h-[90vh] overflow-hidden flex flex-col"><div className="flex items-center gap-3 p-6 border-b border-slate-700 bg-slate-750"><div className="w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold text-white text-lg">{selectedOwner.name.charAt(0)}</div><div><h3 className="font-bold text-lg text-white">{selectedOwner.name}</h3><p className="text-xs text-purple-300">Pengaturan Hak Akses Tenant</p></div></div><div className="px-6 pt-4"><p className="text-slate-400 text-sm bg-slate-900/50 p-3 rounded-lg border border-slate-700"><span className="text-yellow-400 font-bold">‚ö†Ô∏è PERHATIAN:</span> Fitur yang Anda matikan akan <strong>terkunci permanen</strong> untuk Owner dan seluruh karyawannya.</p></div><form onSubmit={updateAccess} className="flex-1 overflow-y-auto p-6"><div className="grid grid-cols-2 gap-3">{[{id: 'menu_dashboard', label: 'üìä Dashboard'},{id: 'menu_report', label: 'üìà Laporan'},{id: 'feature_service_edit', label: 'üì± Edit Servis'},{id: 'feature_sales_edit', label: 'üõí Edit Penjualan'},{id: 'feature_inventory_edit', label: 'üì¶ Edit Inventory'},{id: 'feature_customer_edit', label: 'üë• Edit Pelanggan'},{id: 'feature_print', label: 'üñ®Ô∏è Cetak Invoice'},{id: 'feature_share', label: 'üí¨ Share WhatsApp'},{id: 'feature_delete', label: 'üóëÔ∏è Hapus Data'},{id: 'feature_stock_add', label: '‚ûï Tambah Stok'},{id: 'menu_finance', label: 'üí≥ Menu Keuangan'},{id: 'feature_finance_edit', label: 'üìù Edit Keuangan'},{id: 'feature_backup', label: 'üíæ Backup Data'},{id: 'feature_employee_edit', label: 'üë®‚Äçüíº Edit Pegawai'}].map(item => (<label key={item.id} className="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-700 hover:border-slate-500 cursor-pointer group"><span className="text-slate-300 font-medium group-hover:text-white transition-colors text-sm">{item.label}</span><div className="relative flex items-center"><input type="checkbox" name={item.id} defaultChecked={selectedOwner.accessRights?.[item.id] !== false} className="peer sr-only"/><div className="w-10 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-5 peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div></div></label>))}</div><div className="flex gap-3 mt-6 pt-4 border-t border-slate-700"><button type="button" onClick={()=>setModal(null)} className="flex-1 py-2 border border-slate-600 rounded-lg font-bold text-slate-400 hover:bg-slate-700 text-sm">Batal</button><button className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 text-sm">Simpan Akses</button></div></form></div></div> )} {modal === 'plan' && <PlanConfigModal close={()=>setModal(null)} />} {modal === 'masterKelengkapan' && <MasterKelengkapanModal close={()=>setModal(null)} />} {modal === 'qcItems' && <QCFunctionalItemsModal close={()=>setModal(null)} ownerId={selectedOwner?.id} />} {modal === 'kelengkapanItems' && <KelengkapanItemsModal close={()=>setModal(null)} ownerId={selectedOwner?.id} />} </div> );
        };

        const Dashboard = ({setView}) => {
          const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
          
          // Permission check
          if (!checkPermission('menu_dashboard')) {
              return (
                  <div className="p-10 text-center">
                      <div className="bg-red-50 border border-red-200 rounded-lg p-6 inline-block">
                          <Lock className="w-10 h-10 text-red-600 mx-auto mb-3"/>
                          <h2 className="text-lg font-bold text-red-600 mb-2">‚ùå Akses Ditolak</h2>
                          <p className="text-slate-600">Menu Dashboard telah dikunci oleh Superadmin/Owner. Hubungi mereka untuk mendapatkan akses.</p>
                      </div>
                  </div>
              );
          }
          
          useRealtimePlanSync(activeOwner);
          const { data: services, fromCache: servicesFromCache } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
          const { data: transactions, fromCache: transactionsFromCache } = useFirestoreCollection('transactions', activeOwner?.id, null); // Dashboard perlu semua transaksi, tidak filter by storeId
          const { data: sales, fromCache: salesFromCache } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
          const { data: users } = useFirestoreCollection('users', activeOwner?.id, activeStore?.id);
          const [filter, setFilter] = useState('today');
          const [customDateRange, setCustomDateRange] = useState({start: '', end: ''});
          const [detailModal, setDetailModal] = useState(null);
          const [technicianModal, setTechnicianModal] = useState(null);
          
          const getFilteredData = (items, isTransaction = false) => {
              if (filter === 'custom' && customDateRange.start && customDateRange.end) {
                  const startDate = new Date(customDateRange.start);
                  const endDate = new Date(customDateRange.end);
                  endDate.setHours(23, 59, 59, 999);
                  return items.filter(i => {
                      // Untuk transactions, prioritaskan field 'date'
                      const d = isTransaction ? 
                          (i.date?.seconds ? new Date(i.date.seconds * 1000) : (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : null)) :
                          (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : (i.date?.seconds ? new Date(i.date.seconds * 1000) : null));
                      if(!d) return false;
                      return d >= startDate && d <= endDate;
                  });
              }
              if (filter === 'all') return items;
              const now = new Date();
              return items.filter(i => {
                  // Untuk transactions, prioritaskan field 'date'
                  const d = isTransaction ? 
                      (i.date?.seconds ? new Date(i.date.seconds * 1000) : (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : null)) :
                      (i.createdAt?.seconds ? new Date(i.createdAt.seconds * 1000) : (i.date?.seconds ? new Date(i.date.seconds * 1000) : null));
                  if(!d) return false;
                  if (filter === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                  if (filter === 'today') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                  if (filter === 'year') return d.getFullYear() === now.getFullYear();
                  return true;
              });
          };

          const filteredServices = getFilteredData(services, false);
          const filteredTrans = getFilteredData(transactions, true);
          const filteredSales = getFilteredData(sales || [], false);
          
          // Debug log untuk troubleshooting
          React.useEffect(() => {
              if (filter === 'today') {
                  const profitTransactions = filteredTrans.filter(t => t.type === 'profit');
                  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                  console.log('üîç DASHBOARD DEBUG - Filter: HARI INI');
                  console.log('Total transactions:', transactions.length);
                  console.log('Filtered transactions:', filteredTrans.length);
                  console.log('Profit transactions di hari ini:', profitTransactions.length);
                  
                  if (profitTransactions.length > 0) {
                      console.log('\n‚ö†Ô∏è DETAIL PROFIT TRANSACTIONS:');
                      profitTransactions.forEach((t, idx) => {
                          const dateField = t.date?.seconds ? new Date(t.date.seconds * 1000) : null;
                          const createdAtField = t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : null;
                          console.log(`  ${idx + 1}. ${t.category}:`);
                          console.log(`     Amount: Rp ${t.amount?.toLocaleString('id-ID')}`);
                          console.log(`     date field: ${dateField ? dateField.toLocaleString('id-ID') : 'N/A'}`);
                          console.log(`     createdAt field: ${createdAtField ? createdAtField.toLocaleString('id-ID') : 'N/A'}`);
                          console.log(`     serviceId: ${t.serviceId}`);
                      });
                  } else {
                      console.log('‚úÖ Tidak ada profit transactions di hari ini - CORRECT!');
                  }
                  console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
              }
          }, [filter, filteredTrans]);

          const assignTechnician = async (serviceId, technicianName) => {
              if (!technicianName?.trim()) {
                  alert('Nama tekhnisi tidak boleh kosong');
                  return;
              }
              try {
                  const serviceDoc = filteredServices.find(s => s.id === serviceId);
                  const currentTechs = serviceDoc?.technicians || [];
                  
                  // Check if already assigned
                  if (currentTechs.includes(technicianName.trim())) {
                      alert('Tekhnisi ini sudah ditugaskan');
                      return;
                  }
                  
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId), {
                      technicians: [...currentTechs, technicianName.trim()]
                  });
                  setTechnicianModal(null);
                  alert('Tekhnisi berhasil ditambahkan');
              } catch (err) {
                  alert('Gagal tambah tekhnisi: ' + err.message);
              }
          };

          const activeCount = filteredServices.filter(s => !['Selesai','Diambil','Dibatalkan'].includes(s.status)).length;
          const readyCount = filteredServices.filter(s => s.status === 'Selesai').length;
          const completedServices = filteredServices.filter(s => s.status === 'Selesai');
          const sales_total = filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0);
          const income_trans = filteredTrans.filter(t => t.type === 'income');
          const service_income = income_trans.reduce((a,b)=>a+b.amount,0);
          const expense_trans = filteredTrans.filter(t => t.type === 'expense');
          const expense = expense_trans.reduce((a,b)=>a+b.amount,0);
          const profit_trans = filteredTrans.filter(t => t.type === 'profit').reduce((a,b)=>a+b.amount,0);
          const profit_jasa = filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0);
          const profit_penjualan = profit_trans - profit_jasa;
          const loss_trans = filteredTrans.filter(t => t.type === 'loss').reduce((a,b)=>a+b.amount,0);
          const keuntungan = profit_trans;
          const kerugian = loss_trans;
          const netProfit = service_income - expense;
          const totalProfit = netProfit + profit_trans - loss_trans;
          const service_income_only = filteredTrans.filter(t => t.type === 'income' && t.category?.includes('Servis')).reduce((a,b)=>a+b.amount,0);
          
          const statusCounts = filteredServices.reduce((acc, curr) => { acc[curr.status] = (acc[curr.status] || 0) + 1; return acc; }, {});
          const pieData = Object.keys(statusCounts).map(key => ({ name: key, value: statusCounts[key] }));
          const flowData = [{name:'Servis', val:service_income_only}, {name:'Penjualan', val:sales_total}, {name:'Pengeluaran', val:expense}];
          
          const StatCard = ({ title, value, icon: Icon, color, sub, clickable, onClick }) => ( 
            <button onClick={onClick} disabled={!clickable} className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-100 relative overflow-hidden group transition-all duration-300 text-left ${clickable ? 'hover:shadow-md hover:border-blue-200 cursor-pointer' : ''}`}> 
              <div className={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity ${color}`}><Icon className="w-24 h-24" /></div> 
              <div className="relative z-10">
                <div className={`w-10 h-10 rounded-xl flex items-center justify-center mb-2 ${color} text-white shadow-lg shadow-blue-500/20`}><Icon className="w-5 h-5"/></div>
                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">{title}</p>
                <h3 className="font-bold text-slate-800 line-clamp-2 break-words max-w-full" style={{fontSize: '0.875rem', lineHeight: '1.25'}}>{value}</h3>
                {sub && <p className="text-xs text-slate-400 mt-1">{sub}</p>}
              </div> 
            </button> 
          );
          
          return ( 
            <div className="space-y-6"> 
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div className="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
                        <button onClick={() => { sessionStorage.setItem('autoOpenServiceForm', 'true'); setView('service'); }} className="bg-blue-600 text-white px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 shadow-lg shadow-blue-600/20 hover:bg-blue-700 hover:scale-105 transition-all whitespace-nowrap"><Plus className="w-5 h-5"/> Servis Baru</button>
                        <button onClick={() => setView('sales')} className="bg-white text-slate-600 border border-slate-200 px-5 py-3 rounded-xl text-sm font-bold flex items-center gap-2 hover:bg-slate-50 transition-colors whitespace-nowrap"><Store className="w-5 h-5"/> Penjualan</button>
                        {/* Cache Indicator Badge */}
                        {(servicesFromCache || transactionsFromCache || salesFromCache) && (
                            <div className="flex items-center gap-2 px-4 py-2 bg-green-50 border border-green-200 rounded-xl text-xs">
                                <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                                <span className="font-bold text-green-700">üì± Offline Mode - Hemat Quota</span>
                            </div>
                        )}
                    </div> 
                    <div className="flex flex-col gap-3 w-full md:w-auto">
                        <div className="bg-white border border-slate-200 rounded-lg p-1 flex flex-wrap gap-1">
                            {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'},{id:'custom',l:'Custom'}].map(f => (
                                <button key={f.id} onClick={()=>{setFilter(f.id); if(f.id!=='custom') setCustomDateRange({start:'',end:''})}} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filter === f.id ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}>{f.l}</button>
                            ))}
                        </div>
                        {filter === 'custom' && (
                            <div className="flex gap-2 bg-white border border-slate-200 rounded-lg p-2">
                                <input type="date" value={customDateRange.start} onChange={(e)=>setCustomDateRange({...customDateRange, start:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Dari"/>
                                <span className="text-slate-400">-</span>
                                <input type="date" value={customDateRange.end} onChange={(e)=>setCustomDateRange({...customDateRange, end:e.target.value})} className="px-2 py-1 border border-slate-300 rounded text-xs" placeholder="Ke"/>
                            </div>
                        )}
                    </div>
                </div>

                {/* Baris Atas: Service Related */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <StatCard title="Servis Aktif" value={activeCount} icon={Activity} color="bg-blue-500" sub="Sedang dikerjakan" clickable={activeCount > 0} onClick={() => activeCount > 0 && setDetailModal({type:'active_service', title:'Servis Aktif'})} />
                  <StatCard title="Status Selesai" value={readyCount} icon={CheckCircle} color="bg-emerald-500" sub="Servis Selesai" clickable={readyCount > 0} onClick={() => readyCount > 0 && setDetailModal({type:'ready_service', title:'Status Selesai'})} />
                  <StatCard title="Untung Jasa" value={formatCurrency(profit_jasa)} icon={TrendingUp} color="bg-indigo-500" sub="Profit Servis" clickable={profit_jasa > 0} onClick={() => profit_jasa > 0 && setDetailModal({type:'profit', subType:'jasa', title:'Keuntungan Jasa'})} />
                </div>

                {/* Baris Bawah: Financial Related */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <StatCard title="Pemasukan" value={formatCurrency(service_income)} icon={TrendingUp} color="bg-green-500" sub="Total Penjualan" clickable={income_trans.length > 0} onClick={() => income_trans.length > 0 && setDetailModal({type:'income', title:'Pemasukan'})} />
                  <StatCard title="Pengeluaran" value={formatCurrency(expense)} icon={ArrowDownRight} color="bg-red-500" sub="Total Modal" clickable={expense_trans.length > 0} onClick={() => expense_trans.length > 0 && setDetailModal({type:'expense', title:'Pengeluaran'})} />
                  <StatCard title="Untung Jual" value={formatCurrency(profit_penjualan)} icon={TrendingUp} color="bg-cyan-500" sub="Profit Penjualan" clickable={profit_penjualan > 0} onClick={() => profit_penjualan > 0 && setDetailModal({type:'profit', subType:'penjualan', title:'Keuntungan Penjualan'})} />
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                  <button className={`lg:col-span-1 p-6 rounded-2xl shadow-sm border relative overflow-hidden group transition-all duration-300 text-left font-bold text-2xl ${keuntungan >= 0 ? 'bg-blue-50 border-blue-200 text-blue-600' : 'bg-amber-50 border-amber-200 text-amber-600'}`}>
                    <div className="text-xs uppercase mb-2 opacity-75">Total Keuntungan</div>
                    <div>{formatCurrency(keuntungan)}</div>
                  </button>
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6"> 
                  <div className="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80">
                    <h3 className="font-bold text-slate-800 mb-6 flex items-center gap-2"><Wallet className="w-4 h-4 text-slate-400"/> Arus Kas</h3>
                    <ResponsiveContainer width="100%" height="85%">
                      <AreaChart data={flowData}>
                        <defs><linearGradient id="colorInc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#8b5cf6" stopOpacity={0.8}/><stop offset="95%" stopColor="#8b5cf6" stopOpacity={0}/></linearGradient></defs>
                        <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fill:'#94a3b8', fontSize:12}} />
                        <YAxis axisLine={false} tickLine={false} tick={{fill:'#94a3b8', fontSize:12}} />
                        <CartesianGrid vertical={false} stroke="#f1f5f9" />
                        <Tooltip contentStyle={{borderRadius:'12px', border:'none', boxShadow:'0 10px 15px -3px rgba(0,0,0,0.1)'}} />
                        <Area type="monotone" dataKey="val" stroke="#8b5cf6" fillOpacity={1} fill="url(#colorInc)" />
                      </AreaChart>
                    </ResponsiveContainer>
                  </div> 
                  <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 h-80 flex flex-col">
                    <h3 className="font-bold text-slate-800 mb-2 flex items-center gap-2"><Smartphone className="w-4 h-4 text-slate-400"/> Status Servis</h3>
                    <div className="flex-1 w-full flex items-center justify-center">
                      {pieData.length > 0 ? (
                        <ResponsiveContainer width="100%" height="100%">
                          <PieChart>
                            <Pie data={pieData} dataKey="value" nameKey="name" cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5}>
                              {pieData.map((entry, index) => (<Cell key={`cell-${index}`} fill={['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'][index % 6]} />))}
                            </Pie>
                            <Tooltip />
                          </PieChart>
                        </ResponsiveContainer>
                      ) : (
                        <p className="text-slate-400 text-sm text-center">Tidak ada data servis</p>
                      )}
                    </div>
                  </div> 
                </div>
                
                {/* Modal Detail */}
                {detailModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden shadow-2xl flex flex-col">
                            {/* Header */}
                            <div className="flex justify-between items-center border-b border-slate-200 p-6 bg-gradient-to-r from-slate-50 to-slate-100">
                                <div>
                                    <h3 className="font-bold text-2xl text-slate-800">{detailModal.title}</h3>
                                    <p className="text-xs text-slate-500 mt-1">
                                        {detailModal.type === 'active_service' && 'üìã Daftar servis yang sedang dikerjakan'}
                                        {detailModal.type === 'ready_service' && '‚úÖ Daftar servis yang sudah selesai'}
                                        {detailModal.type === 'income' && 'üí∞ Semua transaksi pemasukan'}
                                        {detailModal.type === 'expense' && 'üí∏ Semua transaksi pengeluaran'}
                                        {detailModal.type === 'profit' && detailModal.subType === 'jasa' && 'üíµ Keuntungan dari jasa servis'}
                                        {detailModal.type === 'profit' && detailModal.subType === 'penjualan' && 'üõçÔ∏è Keuntungan dari penjualan sparepart'}
                                    </p>
                                </div>
                                <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-lg transition-all"><X className="w-6 h-6 text-slate-600" /></button>
                            </div>

                            {/* Content */}
                            <div className="overflow-y-auto flex-1 p-6">
                                {detailModal.type === 'active_service' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {filteredServices.filter(s => !['Selesai','Diambil','Dibatalkan'].includes(s.status)).length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            filteredServices.filter(s => !['Selesai','Diambil','Dibatalkan'].includes(s.status)).map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-blue-50 to-blue-100/50 p-4 rounded-xl border border-blue-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.device || s.unitType}</p>
                                                        </div>
                                                        <span className={`text-xs font-bold px-3 py-1 rounded-full ${
                                                            s.status === 'Antri' ? 'bg-amber-100 text-amber-700' :
                                                            s.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                            'bg-purple-100 text-purple-700'
                                                        }`}>{s.status}</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700 bg-white/60 p-2 rounded mb-3">üîß {s.complaint || s.problem}</p>
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-blue-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-slate-500 mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    {/* Technician section */}
                                                    <div className="mb-3 pb-3 border-b border-blue-200">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <p className="text-xs font-bold text-slate-600 uppercase">üë®‚Äçüîß Tekhnisi ({(s.technicians || []).length})</p>
                                                            <button 
                                                                onClick={() => setTechnicianModal({serviceId: s.id, customerName: s.customerName})}
                                                                className="text-blue-600 hover:text-blue-800 text-xs font-bold hover:bg-blue-50 px-2 py-1 rounded transition"
                                                            >
                                                                + Tambah
                                                            </button>
                                                        </div>
                                                        {(s.technicians || []).length > 0 ? (
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.technicians.map((tech, idx) => (
                                                                    <span key={idx} className="bg-blue-600 text-white text-xs px-2.5 py-1 rounded-full font-medium flex items-center gap-1">
                                                                        {tech}
                                                                        <button
                                                                            onClick={async () => {
                                                                                try {
                                                                                    const newTechs = s.technicians.filter((t, i) => i !== idx);
                                                                                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', s.id), {
                                                                                        technicians: newTechs
                                                                                    });
                                                                                } catch (err) {
                                                                                    alert('Gagal hapus tekhnisi');
                                                                                }
                                                                            }}
                                                                            className="hover:text-red-300 ml-1"
                                                                            title="Hapus"
                                                                        >
                                                                            √ó
                                                                        </button>
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        ) : (
                                                            <p className="text-xs text-slate-500 italic">Belum ada tekhnisi yang ditugaskan</p>
                                                        )}
                                                    </div>
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ {formatDate(s.createdAt)}</span>
                                                        {s.estimatedDate && <span>‚è∞ Est: {formatDate(s.estimatedDate)}</span>}
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'ready_service' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {completedServices.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            completedServices.map(s => (
                                                <div key={s.id} className="bg-gradient-to-r from-emerald-50 to-emerald-100/50 p-4 rounded-xl border border-emerald-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{s.customerName}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üì± {s.device}</p>
                                                        </div>
                                                        <span className="text-xs font-bold px-3 py-1 rounded-full bg-emerald-100 text-emerald-700">‚úÖ Siap</span>
                                                    </div>
                                                    <p className="text-sm text-slate-700 bg-white/60 p-2 rounded mb-3">üîß {s.problem}</p>
                                                    
                                                    {/* Sparepart Info */}
                                                    {(s.usedParts && s.usedParts.length > 0) && (
                                                        <div className="mb-3 pb-3 border-b border-emerald-200">
                                                            <p className="text-xs font-bold text-slate-600 uppercase mb-2">üì¶ Sparepart Terpasang ({s.usedParts.length})</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {s.usedParts.map((part, idx) => (
                                                                    <div key={idx} className="bg-white border border-purple-200 rounded-lg px-3 py-1.5 text-xs">
                                                                        <span className="font-bold text-purple-700">{part.name}</span>
                                                                        <span className="text-slate-400 ml-1">x{part.qty}</span>
                                                                        <div className="text-[10px] text-emerald-600 font-semibold mt-0.5">{formatCurrency(part.sellPrice || 0)}</div>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    
                                                    <div className="flex justify-between text-xs text-slate-500">
                                                        <span>üìÖ Selesai: {formatDate(s.updatedAt)}</span>
                                                        <span>üíµ {s.totalPrice ? formatCurrency(s.totalPrice) : 'Belum ditentukan'}</span>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'income' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {income_trans.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            income_trans.map(t => {
                                                const relatedService = services.find(s => s.id === t.serviceId);
                                                return (
                                                <div key={t.id} className="bg-gradient-to-r from-emerald-50 to-emerald-100/50 p-4 rounded-xl border border-emerald-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                        </div>
                                                        <span className="text-lg font-bold text-emerald-600">+{formatCurrency(t.amount)}</span>
                                                    </div>
                                                    {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                        <div className="bg-white/80 p-3 rounded-lg mb-2 border border-emerald-100">
                                                            <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Digunakan:</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {relatedService.usedParts.map((part, idx) => (
                                                                    <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                        {part.name} x{part.qty} - {formatCurrency(part.sellPrice || 0)}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                    <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'expense' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {expense_trans.length === 0 ? (
                                            <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                        ) : (
                                            expense_trans.map(t => {
                                                const relatedService = services.find(s => s.id === t.serviceId);
                                                return (
                                                <div key={t.id} className="bg-gradient-to-r from-rose-50 to-rose-100/50 p-4 rounded-xl border border-rose-200 hover:shadow-md transition-all">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                            <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                        </div>
                                                        <span className="text-lg font-bold text-rose-600">-{formatCurrency(t.amount)}</span>
                                                    </div>
                                                    {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                        <div className="bg-white/80 p-3 rounded-lg mb-2 border border-rose-100">
                                                            <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart Modal:</p>
                                                            <div className="flex flex-wrap gap-2">
                                                                {relatedService.usedParts.map((part, idx) => (
                                                                    <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                        {part.name} x{part.qty} - Modal: {formatCurrency(part.buyPrice || 0)}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                    <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                </div>
                                                );
                                            })
                                        )}
                                    </div>
                                )}
                                
                                {detailModal.type === 'profit' && (
                                    <div className="grid grid-cols-1 gap-3">
                                        {detailModal.subType === 'jasa' ? (
                                            filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).length === 0 ? (
                                                <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                            ) : (
                                                filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).map(t => {
                                                    const relatedService = services.find(s => s.id === t.serviceId);
                                                    return (
                                                    <div key={t.id} className="bg-gradient-to-r from-indigo-50 to-indigo-100/50 p-4 rounded-xl border border-indigo-200 hover:shadow-md transition-all">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                                <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                            </div>
                                                            <span className="text-lg font-bold text-indigo-600">+{formatCurrency(t.amount)}</span>
                                                        </div>
                                                        {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                            <div className="bg-white/80 p-3 rounded-lg mb-2 border border-indigo-100">
                                                                <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart Terpasang:</p>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {relatedService.usedParts.map((part, idx) => (
                                                                        <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                            {part.name} x{part.qty}
                                                                        </span>
                                                                    ))}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                        <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                    </div>
                                                    );
                                                })
                                            )
                                        ) : (
                                            filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).length === 0 ? (
                                                <div className="text-center py-8 text-slate-400">Tidak ada data</div>
                                            ) : (
                                                filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).map(t => {
                                                    const relatedService = services.find(s => s.id === t.serviceId);
                                                    return (
                                                    <div key={t.id} className="bg-gradient-to-r from-cyan-50 to-cyan-100/50 p-4 rounded-xl border border-cyan-200 hover:shadow-md transition-all">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1">
                                                                <p className="font-bold text-lg text-slate-800">{t.description}</p>
                                                                <p className="text-sm text-slate-600 mt-1">üìÇ {t.category}</p>
                                                            </div>
                                                            <span className="text-lg font-bold text-cyan-600">+{formatCurrency(t.amount)}</span>
                                                        </div>
                                                        {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                            <div className="bg-white/80 p-3 rounded-lg mb-2 border border-cyan-100">
                                                                <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Dijual:</p>
                                                                <div className="flex flex-wrap gap-2">
                                                                    {relatedService.usedParts.map((part, idx) => {
                                                                        const profit = (part.sellPrice - part.buyPrice) * part.qty;
                                                                        return (
                                                                        <span key={idx} className="bg-purple-50 border border-purple-200 text-purple-700 text-[10px] px-2 py-1 rounded-md font-bold">
                                                                            {part.name} x{part.qty} - Profit: {formatCurrency(profit)}
                                                                        </span>
                                                                        );
                                                                    })}
                                                                </div>
                                                            </div>
                                                        )}
                                                        {t.note && <p className="text-sm text-slate-600 bg-white/60 p-2 rounded mb-2">üí¨ {t.note}</p>}
                                                        <p className="text-xs text-slate-500">üìÖ {formatDate(t.date || t.createdAt)}</p>
                                                    </div>
                                                    );
                                                })
                                            )
                                        )}
                                    </div>
                                )}
                                
                                {/* Summary Footer */}
                                {(detailModal.type === 'income' || detailModal.type === 'expense' || detailModal.type === 'profit') && (
                                    <div className="mt-6 pt-6 border-t border-slate-200">
                                        {detailModal.type === 'income' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Pemasukan:</p>
                                                <p className="text-2xl font-bold text-emerald-600">{formatCurrency(income_trans.reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'expense' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Pengeluaran:</p>
                                                <p className="text-2xl font-bold text-rose-600">-{formatCurrency(expense_trans.reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'profit' && detailModal.subType === 'jasa' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Keuntungan Jasa:</p>
                                                <p className="text-2xl font-bold text-indigo-600">+{formatCurrency(filteredTrans.filter(t => t.type === 'profit' && t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                        {detailModal.type === 'profit' && detailModal.subType === 'penjualan' && (
                                            <div className="text-right">
                                                <p className="text-sm text-slate-600 mb-1">Total Keuntungan Penjualan:</p>
                                                <p className="text-2xl font-bold text-cyan-600">+{formatCurrency(filteredTrans.filter(t => t.type === 'profit' && !t.category?.includes('Jasa')).reduce((a,b)=>a+b.amount,0))}</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                
                {/* Technician Assignment Modal */}
                {technicianModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[71] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="font-bold text-xl text-slate-800">Assign Tekhnisi</h3>
                                <button onClick={() => setTechnicianModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                            </div>
                            
                            <div className="mb-4">
                                <p className="text-sm font-bold text-slate-700 mb-2">Service: <span className="text-blue-600">{technicianModal.customerName}</span></p>
                                <p className="text-xs text-slate-500">Pilih tekhnisi untuk menugaskan ke service ini:</p>
                            </div>
                            
                            <div className="space-y-2 max-h-64 overflow-y-auto mb-6 border rounded-lg p-3 bg-slate-50">
                                {users?.filter(u => u.role !== 'owner')?.length > 0 ? (
                                    users.filter(u => u.role !== 'owner').map(user => (
                                        <button
                                            key={user.id}
                                            onClick={() => assignTechnician(technicianModal.serviceId, user.name)}
                                            className="w-full text-left px-3 py-2 rounded-lg hover:bg-blue-100 transition-colors border border-slate-200 hover:border-blue-300"
                                        >
                                            <p className="font-bold text-slate-800 text-sm">{user.name}</p>
                                            <p className="text-xs text-slate-500">{user.role} ‚Ä¢ {user.email}</p>
                                        </button>
                                    ))
                                ) : (
                                    <div className="text-center py-6 text-slate-500">
                                        <Lock className="w-8 h-8 mx-auto mb-2 opacity-50"/>
                                        <p className="text-sm">Tidak ada tekhnisi tersedia</p>
                                    </div>
                                )}
                            </div>
                            
                            <div className="flex gap-3">
                                <button onClick={() => setTechnicianModal(null)} className="flex-1 py-2.5 border border-slate-300 rounded-lg font-bold text-slate-600 hover:bg-slate-50 transition">Batal</button>
                            </div>
                        </div>
                    </div>
                )}

                {/* Technician Assignment Modal */}
                {technicianModal && (
                    <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[80] flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl">
                            <div className="flex justify-between items-center mb-6 border-b pb-4">
                                <h3 className="font-bold text-xl text-slate-800">Tambah Tekhnisi</h3>
                                <button onClick={() => setTechnicianModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                            </div>
                            
                            <p className="text-sm text-slate-600 mb-4">Servis: <strong>{technicianModal.customerName}</strong></p>
                            
                            <div className="space-y-3 mb-6">
                                <p className="text-xs font-bold text-slate-500 uppercase">Pilih dari daftar pegawai:</p>
                                {users && users.length > 0 ? (
                                    <div className="grid grid-cols-2 gap-2 max-h-60 overflow-y-auto">
                                        {users.map(user => (
                                            <button
                                                key={user.id}
                                                onClick={() => {
                                                    assignTechnician(technicianModal.serviceId, user.name);
                                                }}
                                                className="p-3 text-left border border-slate-200 rounded-lg hover:bg-blue-50 hover:border-blue-400 transition"
                                            >
                                                <p className="text-sm font-bold text-slate-800">{user.name}</p>
                                                <p className="text-xs text-slate-500">{user.role}</p>
                                            </button>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-sm text-slate-500 text-center py-4">Tidak ada pegawai terdaftar</p>
                                )}
                            </div>
                            
                            <div className="border-t pt-4">
                                <p className="text-xs font-bold text-slate-500 uppercase mb-2">Atau ketik nama manual:</p>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const name = e.target.techName.value;
                                    assignTechnician(technicianModal.serviceId, name);
                                    e.target.techName.value = '';
                                }} className="flex gap-2">
                                    <input
                                        name="techName"
                                        placeholder="Nama tekhnisi..."
                                        className="flex-1 border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    />
                                    <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-blue-700">
                                        Tambah
                                    </button>
                                </form>
                            </div>
                            
                            <button onClick={() => setTechnicianModal(null)} className="w-full mt-4 py-2 border border-slate-300 rounded-lg text-slate-600 font-bold hover:bg-slate-50">
                                Tutup
                            </button>
                        </div>
                    </div>
                )}
            </div> 
          );
        };

        const ReportManager = () => {
            const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            
            // Permission check
            if (!checkPermission('menu_report')) {
                return (
                    <div className="p-10 text-center">
                        <div className="bg-red-50 border border-red-200 rounded-lg p-6 inline-block">
                            <Lock className="w-10 h-10 text-red-600 mx-auto mb-3"/>
                            <h2 className="text-lg font-bold text-red-600 mb-2">‚ùå Akses Ditolak</h2>
                            <p className="text-slate-600">Menu Laporan telah dikunci oleh Superadmin/Owner. Hubungi mereka untuk mendapatkan akses.</p>
                        </div>
                    </div>
                );
            }
            
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            const { data: transactions } = useFirestoreCollection('transactions', activeOwner?.id, null); // Tidak filter by storeId agar konsisten dengan Dashboard dan Finance
            const { data: sales } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
            const [tab, setTab] = useState('summary');
            const [dateRange, setDateRange] = useState('today');

            const getFilteredByDateRange = (items) => {
                const now = new Date();
                return items.filter(i => {
                    const d = i.createdAt ? (i.createdAt.seconds ? new Date(i.createdAt.seconds * 1000) : new Date(i.createdAt)) : (i.date ? (i.date.seconds ? new Date(i.date.seconds * 1000) : new Date(i.date)) : null);
                    if (!d) return false;
                    if (dateRange === 'today') return d.getDate() === now.getDate() && d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (dateRange === 'month') return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                    if (dateRange === 'year') return d.getFullYear() === now.getFullYear();
                    return true;
                });
            };

            const filteredServices = getFilteredByDateRange(services);
            const filteredSales = getFilteredByDateRange(sales || []);
            const filteredTrans = getFilteredByDateRange(transactions);

            const totalServices = filteredServices.length;
            const completedServices = filteredServices.filter(s => s.status === 'Selesai').length;
            const serviceIncome = filteredTrans.filter(t => t.type === 'income').reduce((a, b) => a + b.amount, 0);
            const serviceExpense = filteredTrans.filter(t => t.type === 'expense').reduce((a, b) => a + b.amount, 0);
            const serviceProfitLoss = serviceIncome - serviceExpense;

            const totalSales = filteredSales.reduce((a, b) => a + (parseFloat(b.total) || 0), 0);
            const totalReturns = filteredSales.filter(s => s.type === 'return').reduce((a, b) => a + (parseFloat(b.total) || 0), 0);

            const topItems = inventory.filter(i => i.stock > 0).sort((a, b) => (parseFloat(b.sellPrice) * b.stock) - (parseFloat(a.sellPrice) * a.stock)).slice(0, 5);
            const inventoryValue = inventory.reduce((a, b) => a + (parseFloat(b.sellPrice) * b.stock), 0);

            const handleExportPDF = () => {
                const content = `
LAPORAN ${tab.toUpperCase()} - iFix Pro
Periode: ${dateRange === 'today' ? 'Hari Ini' : dateRange === 'month' ? 'Bulan Ini' : 'Tahun Ini'}
Tanggal: ${new Date().toLocaleDateString('id-ID')}

${tab === 'summary' && `
RINGKASAN KPI:
- Total Servis: ${totalServices}
- Servis Selesai: ${completedServices}
- Pemasukan: ${formatCurrency(serviceIncome)}
- Pengeluaran: ${formatCurrency(serviceExpense)}
- Profit/Loss: ${formatCurrency(serviceProfitLoss)}
- Total Penjualan: ${formatCurrency(totalSales)}
- Total Retur: ${formatCurrency(totalReturns)}
- Nilai Inventaris: ${formatCurrency(inventoryValue)}
`}

`;
                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `laporan-${tab}-${new Date().toISOString().slice(0, 10)}.txt`;
                link.click();
            };

            const handleExportExcel = () => {
                alert('Export Excel akan segera tersedia. Untuk saat ini, gunakan Download PDF dan convert ke Excel.');
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">Laporan</h2>
                        <div className="flex gap-2">
                            <select value={dateRange} onChange={e => setDateRange(e.target.value)} className="border p-2 rounded-lg text-sm font-bold bg-white">
                                <option value="today">Hari Ini</option>
                                <option value="month">Bulan Ini</option>
                                <option value="year">Tahun Ini</option>
                            </select>
                            <button onClick={handleExportPDF} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700 flex items-center gap-2"><Download className="w-4 h-4"/> PDF</button>
                            <button onClick={handleExportExcel} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-green-700 flex items-center gap-2"><FileText className="w-4 h-4"/> Excel</button>
                        </div>
                    </div>

                    <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 w-full overflow-x-auto">
                        {[
                            { id: 'summary', label: 'Ringkasan' },
                            { id: 'sales', label: 'Penjualan' },
                            { id: 'service', label: 'Servis' },
                            { id: 'inventory', label: 'Stok' },
                            { id: 'profitloss', label: 'Profit/Loss' }
                        ].map(t => (
                            <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>{t.label}</button>
                        ))}
                    </div>

                    {tab === 'summary' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <p className="text-xs text-slate-500 font-bold uppercase mb-1">Total Servis</p>
                                    <h3 className="text-2xl font-black text-blue-600">{totalServices}</h3>
                                    <p className="text-xs text-slate-400 mt-1">{completedServices} selesai</p>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <p className="text-xs text-slate-500 font-bold uppercase mb-1">Penjualan</p>
                                    <h3 className="text-2xl font-black text-green-600">{formatCurrency(totalSales)}</h3>
                                    <p className="text-xs text-slate-400 mt-1">Retur: {formatCurrency(totalReturns)}</p>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <p className="text-xs text-slate-500 font-bold uppercase mb-1">Pemasukan</p>
                                    <h3 className="text-2xl font-black text-violet-600">{formatCurrency(serviceIncome)}</h3>
                                </div>
                                <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                    <p className="text-xs text-slate-500 font-bold uppercase mb-1">Pengeluaran</p>
                                    <h3 className="text-2xl font-black text-red-600">{formatCurrency(serviceExpense)}</h3>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <div className="lg:col-span-2 bg-white p-6 rounded-xl border border-slate-200">
                                    <h3 className="font-bold text-slate-800 mb-4">Profit/Loss Periode Ini</h3>
                                    <div className={`text-3xl font-black ${serviceProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(serviceProfitLoss)}</div>
                                </div>
                                <div className="bg-white p-6 rounded-xl border border-slate-200">
                                    <h3 className="font-bold text-slate-800 mb-4">Nilai Stok</h3>
                                    <div className="text-3xl font-black text-orange-600">{formatCurrency(inventoryValue)}</div>
                                </div>
                            </div>

                            <div className="bg-white p-6 rounded-xl border border-slate-200">
                                <h3 className="font-bold text-slate-800 mb-4">Top 5 Produk (Nilai Jual)</h3>
                                <div className="space-y-2">
                                    {topItems.map((item, idx) => (
                                        <div key={item.id} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                                            <div>
                                                <p className="font-bold text-slate-700">{idx + 1}. {item.name}</p>
                                                <p className="text-xs text-slate-500">Stok: {item.stock} pcs</p>
                                            </div>
                                            <p className="font-bold text-green-600">{formatCurrency(parseFloat(item.sellPrice) * item.stock)}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {tab === 'sales' && (
                        <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-slate-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left text-slate-600 font-bold">Tanggal</th>
                                        <th className="p-3 text-left text-slate-600 font-bold">Tipe</th>
                                        <th className="p-3 text-right text-slate-600 font-bold">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredSales.map((s, i) => (
                                        <tr key={i} className="hover:bg-slate-50">
                                            <td className="p-3 text-slate-700">{formatDate(s.createdAt)}</td>
                                            <td className="p-3"><span className={`text-xs font-bold px-2 py-1 rounded ${s.type === 'return' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{s.type === 'return' ? 'RETUR' : 'PENJUALAN'}</span></td>
                                            <td className="p-3 text-right font-bold text-slate-700">{formatCurrency(s.total)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {tab === 'service' && (
                        <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-slate-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left text-slate-600 font-bold">Pelanggan</th>
                                        <th className="p-3 text-left text-slate-600 font-bold">Unit</th>
                                        <th className="p-3 text-left text-slate-600 font-bold">Status</th>
                                        <th className="p-3 text-right text-slate-600 font-bold">Biaya</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {filteredServices.map(s => (
                                        <tr key={s.id} className="hover:bg-slate-50">
                                            <td className="p-3 font-bold text-slate-700">{s.customerName}</td>
                                            <td className="p-3 text-slate-600">{s.unitType}</td>
                                            <td className="p-3"><span className="text-xs font-bold px-2 py-1 bg-blue-100 text-blue-700 rounded">{s.status}</span></td>
                                            <td className="p-3 text-right font-bold text-slate-700">{formatCurrency(s.costEstimate)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {tab === 'inventory' && (
                        <div className="bg-white rounded-xl border border-slate-200 overflow-hidden">
                            <table className="w-full text-sm">
                                <thead className="bg-slate-50 border-b">
                                    <tr>
                                        <th className="p-3 text-left text-slate-600 font-bold">Barang</th>
                                        <th className="p-3 text-center text-slate-600 font-bold">Stok</th>
                                        <th className="p-3 text-right text-slate-600 font-bold">Harga</th>
                                        <th className="p-3 text-right text-slate-600 font-bold">Nilai</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {inventory.map(i => (
                                        <tr key={i.id} className="hover:bg-slate-50">
                                            <td className="p-3 font-bold text-slate-700">{i.name}</td>
                                            <td className="p-3 text-center font-bold text-blue-600">{i.stock}</td>
                                            <td className="p-3 text-right text-slate-600">{formatCurrency(i.sellPrice)}</td>
                                            <td className="p-3 text-right font-bold text-green-600">{formatCurrency(parseFloat(i.sellPrice) * i.stock)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}

                    {tab === 'profitloss' && (
                        <div className="space-y-4">
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div className="bg-green-50 p-6 rounded-xl border border-green-200">
                                    <h3 className="font-bold text-green-900 mb-2">Total Pemasukan</h3>
                                    <p className="text-3xl font-black text-green-600">{formatCurrency(serviceIncome)}</p>
                                </div>
                                <div className="bg-red-50 p-6 rounded-xl border border-red-200">
                                    <h3 className="font-bold text-red-900 mb-2">Total Pengeluaran</h3>
                                    <p className="text-3xl font-black text-red-600">{formatCurrency(serviceExpense)}</p>
                                </div>
                            </div>
                            <div className={`${serviceProfitLoss >= 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-orange-50 border-orange-200'} p-6 rounded-xl border`}>
                                <h3 className={`font-bold mb-2 ${serviceProfitLoss >= 0 ? 'text-emerald-900' : 'text-orange-900'}`}>Profit/Loss Bersih</h3>
                                <p className={`text-4xl font-black ${serviceProfitLoss >= 0 ? 'text-emerald-600' : 'text-orange-600'}`}>{formatCurrency(serviceProfitLoss)}</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ServiceManager = () => {
             const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
             const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
             const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
             const [modal, setModal] = useState(null);
             const [payModal, setPayModal] = useState(null);
             const [addPartModal, setAddPartModal] = useState(null);
             const [printData, setPrint] = useState(null);
             const [store, setStore] = useState(activeStore);
             const [term, setTerm] = useState('');
             const [statusFilter, setStatusFilter] = useState('all');
             const [captureData, setCaptureData] = useState(null);
             const [allKelengkapanItems, setAllKelengkapanItems] = useState([]);
             const [allQCItems, setAllQCItems] = useState([]);
             const [currentPage, setCurrentPage] = useState(1);
             const [itemsPerPage, setItemsPerPage] = useState(10);
             
             useEffect(() => {
                 setStore(activeStore);
             }, [activeStore]);
             
             // Load all Kelengkapan and QC items for invoice display
             useEffect(() => {
                 if (!activeOwner?.id) return;
                 
                 // Load kelengkapan items
                 const masterKelUnsub = onSnapshot(
                     query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items')),
                     (snap) => {
                         const masterItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                         const ownerKelUnsub = onSnapshot(
                             query(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), where('ownerId', '==', activeOwner.id)),
                             (snap) => {
                                 const ownerItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                 const allItems = [...masterItems, ...ownerItems];
                                 const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                 setAllKelengkapanItems(uniqueItems);
                             }
                         );
                         return () => ownerKelUnsub();
                     }
                 );
                 
                 // Load QC items
                 const masterQCUnsub = onSnapshot(
                     query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_qc_functional_items')),
                     (snap) => {
                         const masterItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                         const ownerQCUnsub = onSnapshot(
                             query(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), where('ownerId', '==', activeOwner.id)),
                             (snap) => {
                                 const ownerItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                 const allItems = [...masterItems, ...ownerItems];
                                 const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                 setAllQCItems(uniqueItems);
                             }
                         );
                         return () => ownerQCUnsub();
                     }
                 );
                 
                 return () => {
                     masterKelUnsub();
                     masterQCUnsub();
                 };
             }, [activeOwner?.id]);
             
             // Auto-recalculate profit untuk service yang belum punya profit transactions
             const recalculateRef = useRef(false);
             useEffect(() => {
                 const recalculateAllMissingProfits = async () => {
                     if (recalculateRef.current) return;
                     if (!activeOwner?.id || !activeStore?.id || services.length === 0) return;
                     
                     const recalcFlag = localStorage.getItem('profit_recalculated_date_fix');
                     if (recalcFlag === 'true') {
                         console.log('‚úÖ Profit already recalculated with service dates, skipping...');
                         return;
                     }
                     
                     recalculateRef.current = true;
                     console.log('üîç Recalculating ALL profit transactions with correct service dates...');
                     
                     try {
                         // Recalculate SEMUA service (untuk fix tanggal)
                         const servicesToRecalc = services.filter(s => {
                             const hasParts = (s.usedParts || []).length > 0;
                             const hasFee = parseFloat(s.serviceFee || 0) > 0;
                             return hasParts || hasFee;
                         });
                         
                         if (servicesToRecalc.length === 0) {
                             console.log('‚úÖ No services to recalculate');
                             localStorage.setItem('profit_recalculated_date_fix', 'true');
                             return;
                         }
                         
                         console.log(`üîß Recalculating ${servicesToRecalc.length} services with correct dates...`);
                         
                         for (const service of servicesToRecalc) {
                             await recalculateServiceProfit(
                                 service.id,
                                 service,
                                 service.customerName,
                                 false // Hapus profit lama, buat yang baru dengan tanggal benar
                             );
                         }
                         
                         console.log('‚úÖ All profits recalculated with correct dates!');
                         localStorage.setItem('profit_recalculated_date_fix', 'true');
                         localStorage.removeItem('profit_recalculated_v1');
                         alert(`‚úÖ ${servicesToRecalc.length} profit transactions telah diupdate dengan tanggal yang benar!`);
                         
                     } catch (error) {
                         console.error('‚ùå Error during auto-recalculate:', error);
                         recalculateRef.current = false;
                     }
                 };
                 
                 if (services.length > 0 && !recalculateRef.current) {
                     const timer = setTimeout(() => {
                         recalculateAllMissingProfits();
                     }, 1000);
                     return () => clearTimeout(timer);
                 }
             }, [services.length, activeOwner?.id, activeStore?.id]);
             
             // Check for customer data from CustomerManager
             useEffect(() => {
                 // Small delay to ensure sessionStorage is written
                 const timer = setTimeout(() => {
                     const newServiceData = sessionStorage.getItem('newServiceData');
                     if (newServiceData) {
                         try {
                             const data = JSON.parse(newServiceData);
                             console.log('‚úÖ Loading service data from customer:', data);
                             setModal(data);
                             sessionStorage.removeItem('newServiceData');
                         } catch (e) {
                             console.error('‚ùå Error parsing service data:', e);
                         }
                     }
                     
                     // Check for auto-open from Dashboard
                     const autoOpen = sessionStorage.getItem('autoOpenServiceForm');
                     if (autoOpen === 'true') {
                         console.log('‚úÖ Auto-opening service form from Dashboard');
                         setModal({ownerId: activeOwner?.id});
                         sessionStorage.removeItem('autoOpenServiceForm');
                     }
                 }, 100);
                 return () => clearTimeout(timer);
             }, []);
             const canDelete = checkPermission('feature_delete');
             const canPrint = checkPermission('feature_print');
             const canShare = checkPermission('feature_share');
             
             // Fungsi untuk recalculate profit saat service diupdate
             const recalculateServiceProfit = async (serviceId, serviceData, customerName, skipDelete = false) => {
                 try {
                     console.log('üîÑ Recalculating profit for service:', serviceId);
                     
                     const batch = writeBatch(db);
                     
                     // 1. Delete existing profit/loss transactions for this service (jika bukan batch recalculate)
                     if (!skipDelete) {
                         const transactionsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                         const q = query(
                             transactionsRef, 
                             where('serviceId', '==', serviceId),
                             where('type', 'in', ['profit', 'loss'])
                         );
                         const existingSnapshot = await getDocs(q);
                         
                         let deletedCount = 0;
                         existingSnapshot.forEach((doc) => {
                             batch.delete(doc.ref);
                             deletedCount++;
                         });
                         
                         console.log(`üóëÔ∏è Deleting ${deletedCount} old profit/loss transactions`);
                     }
                     
                     // 2. Calculate new profits
                     const usedParts = serviceData.usedParts || [];
                     const serviceFee = parseFloat(serviceData.serviceFee) || 0;
                     
                     // Profit from spareparts - hitung per part
                     let totalProfitParts = 0;
                     usedParts.forEach(part => {
                         if (!part.isManual) {
                             const buyPrice = parseFloat(part.buyPrice) || 0;
                             const sellPrice = parseFloat(part.sellPrice) || 0;
                             const qty = parseInt(part.qty) || 0;
                             const profitPerUnit = sellPrice - buyPrice;
                             const itemProfit = profitPerUnit * qty;
                             totalProfitParts += itemProfit;
                         }
                     });
                     
                     // Buat transaction untuk profit/loss sparepart (gabungan)
                     if (totalProfitParts !== 0) {
                         const transactionRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'));
                         batch.set(transactionRef, {
                             ownerId: activeOwner.id,
                             storeId: activeStore.id,
                             type: totalProfitParts > 0 ? 'profit' : 'loss',
                             category: totalProfitParts > 0 ? 'Keuntungan Sparepart' : 'Rugi Sparepart',
                             description: `${totalProfitParts > 0 ? 'Profit' : 'Loss'} sparepart untuk ${customerName || 'Customer'}`,
                             amount: Math.abs(totalProfitParts),
                             date: serviceData.createdAt || serverTimestamp(),
                             createdAt: serviceData.createdAt || serverTimestamp(),
                             serviceId: serviceId
                         });
                         console.log(`üí∞ Creating ${totalProfitParts > 0 ? 'profit' : 'loss'} transaction for parts: Rp ${Math.abs(totalProfitParts).toLocaleString('id-ID')}`);
                     }
                     
                     // Profit from service fee
                     // Untung Jasa = Total Biaya - Harga Jual Sparepart
                     const partsJual = usedParts.reduce((acc, part) => acc + (parseFloat(part.sellPrice || 0) * part.qty), 0);
                     const jasaProfit = serviceFee - partsJual;
                     if (jasaProfit > 0) {
                         const transactionRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'));
                         batch.set(transactionRef, {
                             ownerId: activeOwner.id,
                             storeId: activeStore.id,
                             type: 'profit',
                             category: 'Keuntungan Jasa Servis',
                             description: `Profit jasa servis untuk ${customerName || 'Customer'}`,
                             amount: jasaProfit,
                             date: serviceData.createdAt || serverTimestamp(),
                             createdAt: serviceData.createdAt || serverTimestamp(),
                             serviceId: serviceId
                         });
                         console.log(`üí∞ Creating profit transaction for service fee: Rp ${jasaProfit.toLocaleString('id-ID')}`);
                     }
                     
                     // 3. Commit batch
                     await batch.commit();
                     console.log('‚úÖ Profit recalculation completed successfully');
                     
                 } catch (error) {
                     console.error('‚ùå Error recalculating profit:', error);
                     throw error;
                 }
             };
             
             const saveService = async (data) => { 
                const totalBiaya = parseFloat(data.serviceFee) || 0; // Total Biaya sudah termasuk harga jual sparepart
                const partsTotal = (data.usedParts || []).reduce((acc, p) => acc + (parseFloat(p.sellPrice) * p.qty), 0); 
                const paid = parseFloat(data.dp) || 0; 
                let paymentStatus = 'Belum Lunas'; 
                if (paid >= totalBiaya && totalBiaya > 0) paymentStatus = 'Lunas'; 
                else if (paid > 0) paymentStatus = 'DP'; 
                
                const payload = { ...data, costEstimate: totalBiaya, ownerId: activeOwner.id, storeId: activeStore.id, paymentStatus, updatedAt: serverTimestamp(), token: data.token || generateToken() };
                 try { 
                     if (modal.id) { 
                         // UPDATE existing service - compare old vs new parts for stock adjustment
                         const oldService = services.find(s => s.id === modal.id);
                         const oldParts = oldService?.usedParts || [];
                         const newParts = data.usedParts || [];
                         
                         // Batch write for stock adjustments
                         const batch = writeBatch(db);
                         
                         // Restore stock for parts removed in this edit
                         oldParts.forEach(oldPart => {
                             if (!oldPart.isManual && !newParts.some(np => np.id === oldPart.id && np.qty === oldPart.qty)) {
                                 const removedQty = oldPart.qty - (newParts.find(np => np.id === oldPart.id)?.qty || 0);
                                 if (removedQty > 0) {
                                     const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', oldPart.id);
                                     batch.update(ref, { stock: increment(removedQty) });
                                 }
                             }
                         });
                         
                         // Decrease stock for parts added or increased in this edit
                         newParts.forEach(newPart => {
                             if (!newPart.isManual) {
                                 const oldQty = oldParts.find(op => op.id === newPart.id)?.qty || 0;
                                 const decreaseQty = newPart.qty - oldQty;
                                 if (decreaseQty > 0) {
                                     const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', newPart.id);
                                     batch.update(ref, { stock: increment(-decreaseQty) });
                                 }
                             }
                         });
                         
                         await batch.commit();
                         await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', modal.id), payload);
                         
                         // Recalculate and update profit transactions saat EDIT
                         await recalculateServiceProfit(modal.id, data, payload.customerName);
                     } else { 
                         // CREATE new service - DECREASE stock for all used parts
                         const batch = writeBatch(db);
                         
                         // Decrease stock for each part from inventory
                         (data.usedParts || []).forEach(part => {
                             if (!part.isManual) {
                                 const ref = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id);
                                 batch.update(ref, { stock: increment(-part.qty) });
                             }
                         });
                         
                         payload.createdAt = serverTimestamp(); 
                         await batch.commit(); // Commit stock updates first
                         
                         const serviceRef = await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'services'), payload);
                         
                         // CREATE TRANSACTIONS: income for service + expense for modal parts + profit
                         const transactionBatch = writeBatch(db);
                         
                         // 1. INCOME transaction (jasa service)
                         if (paid > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), { 
                                 ownerId: activeOwner.id, 
                                 storeId: activeStore.id, 
                                 type: 'income', 
                                 amount: paid, 
                                 category: 'DP Servis', 
                                 description: `DP ${payload.customerName}`, 
                                 date: serverTimestamp(), 
                                 serviceId: serviceRef.id 
                             }); 
                         }
                         
                         // 2. EXPENSE transaction (modal dari sparepart yang dijual)
                         const modalSparepart = (data.usedParts || []).reduce((acc, p) => {
                             if (!p.isManual) {
                                 acc += (parseFloat(p.buyPrice || 0) * p.qty);
                             }
                             return acc;
                         }, 0);
                         
                         if (modalSparepart > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'expense',
                                 category: 'Modal Sparepart Dijual',
                                 description: `Modal sparepart untuk ${payload.customerName}`,
                                 amount: modalSparepart,
                                 date: serverTimestamp(),
                                 serviceId: serviceRef.id,
                                 items: (data.usedParts || []).filter(p => !p.isManual).map(p => ({
                                     name: p.name,
                                     qty: p.qty,
                                     buyPrice: p.buyPrice,
                                     subtotal: (parseFloat(p.buyPrice || 0) * p.qty)
                                 }))
                             });
                         }
                         
                         // 3. PROFIT/LOSS transaction (keuntungan dari sparepart)
                         let profitSparepart = 0;
                         (data.usedParts || []).forEach(p => {
                             if (!p.isManual) {
                                 const itemProfit = ((parseFloat(p.sellPrice) || 0) - (parseFloat(p.buyPrice) || 0)) * p.qty;
                                 profitSparepart += itemProfit;
                             }
                         });
                         
                         if (profitSparepart !== 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: profitSparepart > 0 ? 'profit' : 'loss',
                                 category: profitSparepart > 0 ? 'Keuntungan Sparepart' : 'Rugi Sparepart',
                                 description: `${profitSparepart > 0 ? 'Profit' : 'Loss'} sparepart untuk ${payload.customerName}`,
                                 amount: Math.abs(profitSparepart),
                                 date: serverTimestamp(),
                                 createdAt: serverTimestamp(),
                                 serviceId: serviceRef.id
                             });
                         }
                         
                         // 4. PROFIT transaction (keuntungan dari jasa service)
                         // Untung Jasa = Total Biaya - Harga Jual Sparepart
                         const partsJualTotal = (data.usedParts || []).reduce((acc, p) => acc + (parseFloat(p.sellPrice || 0) * p.qty), 0);
                         const jasaProfit = (parseFloat(data.serviceFee) || 0) - partsJualTotal;
                         if (jasaProfit > 0) {
                             transactionBatch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                                 ownerId: activeOwner.id,
                                 storeId: activeStore.id,
                                 type: 'profit',
                                 category: 'Keuntungan Jasa Servis',
                                 description: `Profit jasa servis untuk ${payload.customerName}`,
                                 amount: jasaProfit,
                                 date: serverTimestamp(),
                                 createdAt: serverTimestamp(),
                                 serviceId: serviceRef.id
                             });
                         }
                         
                         await transactionBatch.commit();
                     } 
                     setModal(null); 
                 } catch(err) { alert("Gagal simpan: " + err.message); } 
             };
             const handlePay = async (service, amount, method) => { try { const newPaid = (parseFloat(service.dp) || 0) + parseFloat(amount); const isPaidOff = newPaid >= service.costEstimate; await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id), { dp: newPaid, paymentStatus: isPaidOff ? 'Lunas' : 'DP' }); await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), { ownerId: activeOwner.id, storeId: activeStore.id, type: 'income', amount: parseFloat(amount), category: 'Pelunasan Servis', description: `Bayar ${service.customerName} (${method})`, date: serverTimestamp(), serviceId: service.id }); setPayModal(null); } catch(err) { alert("Gagal bayar: " + err.message); } };
             const deleteService = async (id) => { if(confirm("Hapus data servis ini?")) { try { const svc = services.find(s => s.id === id); if (svc && svc.usedParts) { for (const part of svc.usedParts) { const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', part.id); await updateDoc(invRef, {stock: (part.stock + part.qty)}); } } const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'); const tq = query(transRef, where('serviceId', '==', id)); const tSnap = await getDocs(tq); const tbatch = writeBatch(db); tSnap.docs.forEach(d => tbatch.delete(d.ref)); await tbatch.commit(); await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', id)); alert("Servis dihapus. Stok & transaksi sudah dikembalikan."); } catch(err) { alert("Gagal hapus: " + err.message); } } };
             const updateStatus = async (id, newStatus) => { try { await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'services', id), { status: newStatus }); } catch(err) {} };
             const print = (s) => { setPrint(s); setTimeout(() => { window.print(); setPrint(null); }, 500); };
             const shareInvoiceAsImage = async (service) => { 
                const formattedPhone = formatWhatsAppNumber(service.phone);
                if (!formattedPhone) { alert('‚ö†Ô∏è Nomor WA pelanggan kosong!'); return; }
                
                // Generate invoice FIRST
                setCaptureData(service); 
                await new Promise(r => setTimeout(r, 800));
                const element = document.getElementById('invoice-capture'); 
                if (!element) { alert('Gagal membuat invoice'); setCaptureData(null); return; } 
                try { 
                    const canvas = await html2canvas(element, { scale: 2, logging: false, useCORS: true, backgroundColor: '#ffffff' }); 
                    canvas.toBlob(async (blob) => { 
                        setCaptureData(null);
                        
                        // 1. Download File
                        const link = document.createElement('a'); 
                        link.href = URL.createObjectURL(blob); 
                        link.download = `Invoice-${service.token}.jpg`; 
                        document.body.appendChild(link);
                        link.click(); 
                        document.body.removeChild(link);
                        
                        // Wait for download to register
                        await new Promise(r => setTimeout(r, 1500));
                        
                        // 2. Open WhatsApp Direct to Customer Number using wa.me (more compatible)
                        const message = `Halo Kak ${service.customerName}! üëã\n\nBerikut adalah invoice detail servis untuk Kak:\n\nüí∞ *Invoice Servis*\nüÜî Token: ${service.token}\nüìÑ Silakan download file invoice yang telah kami siapkan.\n\nJika ada pertanyaan, silakan hubungi kami. Terimakasih! üôè`
                        const encodedMessage = encodeURIComponent(message);
                        
                        // Use wa.me which works on both mobile apps and desktop
                        window.open(`https://wa.me/${formattedPhone}?text=${encodedMessage}`, '_blank');
                        
                    }, 'image/jpeg', 0.95); 
                } catch (err) { setCaptureData(null); console.error(err); } 
             };
             const filtered = services.filter(s => (s.customerName.toLowerCase().includes(term) || (s.token || s.publicToken || '').includes(term)) && (statusFilter === 'all' || s.status === statusFilter));
             
             // Pagination logic
             const totalItems = filtered.length;
             const totalPages = Math.ceil(totalItems / itemsPerPage);
             const startIndex = (currentPage - 1) * itemsPerPage;
             const endIndex = startIndex + itemsPerPage;
             const paginatedData = filtered.slice(startIndex, endIndex);
             
             // Reset to page 1 when filter changes
             useEffect(() => {
                 setCurrentPage(1);
             }, [statusFilter, term]);
             
             const handlePageChange = (newPage) => {
                 if (newPage >= 1 && newPage <= totalPages) {
                     setCurrentPage(newPage);
                     window.scrollTo({ top: 0, behavior: 'smooth' });
                 }
             };
             
             const handleItemsPerPageChange = (value) => {
                 setItemsPerPage(value);
                 setCurrentPage(1);
             };
             
             return (
                 <div className="space-y-6 no-print">
                     {/* Status Filter */}
                     <div className="flex flex-wrap gap-2 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-16 md:top-0 z-10 overflow-x-auto">
                        {['all', ...STATUS_FLOW].map(status => {
                            const statusEmoji = {
                                'all': 'üìã Semua',
                                'Diterima': 'üì• Diterima',
                                'Diagnosa': 'üîç Diagnosa',
                                'Proses': '‚öôÔ∏è Proses',
                                'Menunggu Sparepart': '‚è≥ Menunggu Spare',
                                'Selesai': '‚úÖ Selesai',
                                'Diambil': 'üì¶ Diambil',
                                'Dibatalkan': '‚ùå Batal',
                                'Garansi': 'üîß Garansi'
                            };
                            return (
                                <button
                                    key={status}
                                    onClick={() => setStatusFilter(status)}
                                    className={`px-3 py-2 rounded-lg font-bold text-xs md:text-sm transition-all whitespace-nowrap ${
                                        statusFilter === status
                                            ? 'bg-blue-600 text-white shadow-lg'
                                            : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                    }`}
                                >
                                    {statusEmoji[status]}
                                </button>
                            );
                        })}
                     </div>

                     <div className="flex flex-col md:flex-row justify-between gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100 sticky top-28 md:top-0 z-10">
                        <div className="relative flex-1"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari pelanggan / token..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                        <button onClick={()=>setModal({ownerId: activeOwner?.id})} className="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-500/30 transition-all hover:scale-105"><Plus className="w-5 h-5"/> Servis Baru</button>
                     </div>

                     <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                        <div className="overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-100 text-slate-600 font-bold border-b border-slate-200 uppercase text-xs tracking-wider"><tr><th className="px-6 py-4">Pelanggan / Unit</th><th className="px-6 py-4 bg-purple-50 text-purple-700">Sparepart</th><th className="px-6 py-4">Status Pengerjaan</th><th className="px-6 py-4">Pembayaran</th><th className="px-6 py-4">Biaya Total</th><th className="px-6 py-4 text-center">Aksi</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {paginatedData.map(s => {
                                        const sisa = (s.costEstimate || 0) - (s.dp || 0);
                                        const statusBgClass = s.status === 'Diterima' ? 'bg-blue-100 hover:bg-blue-200' : 
                                            s.status === 'Diagnosa' ? 'bg-yellow-100 hover:bg-yellow-200' : 
                                            s.status === 'Dikerjakan' ? 'bg-purple-100 hover:bg-purple-200' : 
                                            s.status === 'Menunggu Sparepart' ? 'bg-orange-100 hover:bg-orange-200' : 
                                            s.status === 'Selesai' ? 'bg-green-100 hover:bg-green-200' : 
                                            s.status === 'Diambil' ? 'bg-emerald-100 hover:bg-emerald-200' :
                                            s.status === 'Dibatalkan' ? 'bg-red-100 hover:bg-red-200' : 
                                            'bg-slate-100 hover:bg-slate-200';
                                        return (
                                            <tr key={s.id} className={`transition-colors ${statusBgClass}`}>
                                                <td className="px-6 py-4">
                                                    <div className="font-bold text-slate-800 text-base">{s.customerName}</div>
                                                    <div className="text-xs text-slate-500 font-medium flex items-center gap-1 mt-1"><Smartphone className="w-3 h-3"/> {s.unitType || s.device || s.deviceType}</div>
                                                    <div className="text-[10px] text-slate-400 mt-1">{formatDate(s.createdAt)} ‚Ä¢ {s.token || s.publicToken}</div>
                                                </td>
                                                <td className="px-6 py-4">
                                                    <div className="flex flex-col gap-2">
                                                        {(s.usedParts || []).map((p, idx) => (
                                                            <div key={idx} className="bg-white border border-purple-100 rounded-lg p-2 shadow-sm">
                                                                <div className="flex items-center gap-1.5 mb-1">
                                                                    <Box className="w-3.5 h-3.5 text-purple-500"/>
                                                                    <span className="text-purple-700 text-xs font-bold">{p.name}</span>
                                                                    <span className="text-slate-400 font-normal text-[10px]">x{p.qty}</span>
                                                                </div>
                                                                <div className="text-[10px] text-slate-600 font-semibold ml-5">
                                                                    {formatCurrency(p.sellPrice || 0)} <span className="text-slate-400 font-normal">/ unit</span>
                                                                    {p.qty > 1 && <span className="text-purple-600 ml-2">= {formatCurrency((p.sellPrice || 0) * p.qty)}</span>}
                                                                </div>
                                                            </div>
                                                        ))}
                                                        {(!s.usedParts || s.usedParts.length === 0) && <span className="text-slate-400 italic text-xs">-</span>}
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4"><select value={s.status} onChange={(e) => updateStatus(s.id, e.target.value)} className={`text-xs font-bold border rounded-lg px-2 py-1.5 cursor-pointer outline-none transition-colors ${ s.status === 'Diterima' ? 'bg-blue-100 text-blue-700 border-blue-200' : s.status === 'Diagnosa' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Menunggu Sparepart' ? 'bg-yellow-100 text-yellow-700 border-yellow-200' : s.status === 'Selesai' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200'}`} onClick={(e) => e.stopPropagation()}>{STATUS_FLOW.map(st => <option key={st} value={st}>{st}</option>)}</select></td>
                                                <td className="px-6 py-4"><div className="flex flex-col gap-1 items-start"><span className={`px-2 py-0.5 rounded text-[10px] font-black uppercase tracking-wide border ${s.paymentStatus === 'Lunas' ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : s.paymentStatus === 'DP' ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-slate-100 text-slate-600 border-slate-200'}`}>{s.paymentStatus}</span>{s.paymentStatus !== 'Lunas' && (<button onClick={() => setPayModal(s)} className="flex items-center gap-1 text-xs font-bold text-blue-600 hover:text-blue-800 hover:underline mt-1"><DollarSign className="w-3 h-3"/> Bayar {s.paymentStatus === 'DP' ? 'Sisa' : 'Sekarang'}</button>)}{s.paymentStatus !== 'Lunas' && <span className="text-[10px] text-red-500 font-medium">Sisa: {formatCurrency(sisa)}</span>}</div></td>
                                                <td className="px-6 py-4"><div className="font-bold text-slate-700">{formatCurrency(s.costEstimate)}</div></td>
                                                <td className="px-6 py-4">
                                                    <div className="flex flex-col gap-2">
                                                        {/* Baris 1: Edit, Add Part, Share Progress */}
                                                        <div className="flex justify-center gap-2">
                                                            <button onClick={() => setModal(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-blue-50 hover:text-blue-600 text-slate-500 transition-all shadow-sm" title="Edit Detail"><Settings className="w-4 h-4"/></button>
                                                            <button onClick={() => setAddPartModal(s)} className="p-2 bg-purple-50 border border-purple-200 rounded-lg hover:bg-purple-100 text-purple-600 transition-all shadow-sm" title="Tambah Sparepart"><PackagePlus className="w-4 h-4"/></button>
                                                            {canShare ? <button onClick={() => handleShareProgress(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-green-50 text-green-600 shadow-sm" title="Kirim Progress ke WA"><Share2 className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur SHARE dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                        </div>
                                                        {/* Baris 2: Print, Share Image, Delete */}
                                                        <div className="flex justify-center gap-2">
                                                            {canPrint ? <button onClick={() => print(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-100 text-slate-600 shadow-sm" title="Print"><Printer className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur PRINT dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                            {canShare ? <button onClick={() => shareInvoiceAsImage(s)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-pink-50 text-pink-600 shadow-sm" title="Kirim Invoice JPEG ke WA"><ImageIcon className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur SHARE IMG dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                            {canDelete ? <button onClick={() => deleteService(s.id)} className="p-2 bg-white border border-slate-200 rounded-lg hover:bg-red-50 text-red-500 shadow-sm" title="Hapus"><Trash2 className="w-4 h-4"/></button> : <button onClick={() => showAccessDenied("Fitur HAPUS dikunci")} className="p-2 bg-slate-100 border border-slate-200 rounded-lg text-slate-400 cursor-not-allowed shadow-inner"><Lock className="w-4 h-4"/></button>}
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                            {paginatedData.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada data ditemukan.</div>}
                        </div>
                     </div>
                     
                     {/* Pagination Info & Controls */}
                     <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                     </div>
                     
                     {/* Pagination Navigation */}
                     {totalPages > 1 && (
                         <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <button 
                                onClick={() => handlePageChange(currentPage - 1)} 
                                disabled={currentPage === 1}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                ‚Üê Sebelumnya
                            </button>
                            <div className="flex gap-2 flex-wrap justify-center">
                                {Array.from({ length: Math.min(totalPages, 7) }, (_, i) => {
                                    let pageNum;
                                    if (totalPages <= 7) {
                                        pageNum = i + 1;
                                    } else if (currentPage <= 4) {
                                        pageNum = i + 1;
                                    } else if (currentPage >= totalPages - 3) {
                                        pageNum = totalPages - 6 + i;
                                    } else {
                                        pageNum = currentPage - 3 + i;
                                    }
                                    return (
                                        <button
                                            key={pageNum}
                                            onClick={() => handlePageChange(pageNum)}
                                            className={`w-10 h-10 rounded-lg font-bold text-sm transition-all ${
                                                currentPage === pageNum
                                                    ? 'bg-blue-600 text-white shadow-lg'
                                                    : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
                                            }`}
                                        >
                                            {pageNum}
                                        </button>
                                    );
                                })}
                            </div>
                            <button 
                                onClick={() => handlePageChange(currentPage + 1)} 
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                Selanjutnya ‚Üí
                            </button>
                         </div>
                     )}
                     
                     {modal && <ServiceForm initial={modal} inventory={inventory} close={()=>setModal(null)} save={saveService} allServices={services} />}
                     {addPartModal && <AddPartModal service={addPartModal} inventory={inventory} close={()=>setAddPartModal(null)} />}
                     {payModal && <PaymentModal service={payModal} close={()=>setPayModal(null)} pay={handlePay} />}
                     {printData && <div className="print-only hidden fixed inset-0 bg-white z-[9999]"><Invoice s={printData} store={store} allKelengkapanItems={allKelengkapanItems} allQCItems={allQCItems} /></div>}
                     {captureData && (<div style={{ position: 'fixed', top: 0, left: '-9999px', width: '80mm', zIndex: -1 }}><div id="invoice-capture" className="bg-white"><Invoice s={captureData} store={store} allKelengkapanItems={allKelengkapanItems} allQCItems={allQCItems} /></div></div>)}
                 </div>
             );
        };

        const AddPartModal = ({ service, inventory, close }) => {
            const [partMode, setPartMode] = useState('stock');
            const [selectedPart, setPart] = useState('');
            const [manualPart, setManualPart] = useState({name:'', buyPrice:'', sellPrice:'', qty:1});
            const [loading, setLoading] = useState(false);
            
            const handleSave = async (newPart) => {
                setLoading(true);
                try {
                    const currentParts = service.usedParts || [];
                    const updatedParts = [...currentParts, newPart];
                    
                    // Total Biaya (serviceFee) sudah termasuk harga jual sparepart
                    // Jadi costEstimate = serviceFee (tidak perlu ditambah lagi)
                    const totalBiaya = parseFloat(service.serviceFee || service.costEstimate || 0);

                    // NEW: Atomic Transaction to Update Service & Deduct Stock
                    await runTransaction(db, async (transaction) => {
                         const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', service.id);
                         transaction.update(serviceRef, {
                            usedParts: updatedParts,
                            costEstimate: totalBiaya,
                            updatedAt: serverTimestamp()
                        });

                        // If it's a stock item, decrement inventory by qty
                        if (!newPart.isManual && newPart.id) {
                             const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', newPart.id);
                             transaction.update(invRef, {
                                 stock: increment(-newPart.qty)
                             });
                        }
                    });
                    
                    close();
                } catch(e) {
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            const add = () => {
                 if (partMode === 'stock') {
                    const item = inventory.find(i => i.id === selectedPart);
                    if (item) {
                        if (item.stock <= 0) {
                            alert("Stok barang habis!");
                            return;
                        }
                        // Tambahkan qty (default 1, bisa dimodifikasi jika ada input qty)
                        handleSave({ ...item, qty: 1, isManual: false });
                    }
                } else {
                    if(manualPart.name && manualPart.buyPrice && manualPart.sellPrice && manualPart.qty > 0) {
                        handleSave({ 
                           id: 'man_'+Date.now(), 
                           name: manualPart.name + ' (Manual)', 
                           buyPrice: parseFloat(manualPart.buyPrice),
                           sellPrice: parseFloat(manualPart.sellPrice), 
                           qty: parseInt(manualPart.qty) || 1, 
                           isManual: true 
                        });
                        setManualPart({name:'', buyPrice:'', sellPrice:'', qty:1});
                    } else {
                        alert('Semua field harus diisi!');
                    }
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[80] animate-fade-in">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                             <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><PackagePlus className="w-5 h-5 text-purple-600"/> Tambah Sparepart</h3>
                             <button onClick={close} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="bg-yellow-50 text-yellow-800 p-2 rounded text-xs mb-4 border border-yellow-200">
                           ‚ÑπÔ∏è <b>Info:</b> Stok akan otomatis berkurang jika mengambil dari Inventaris.
                        </div>
                        <div className="flex gap-2 mb-3">
                            <button type="button" onClick={()=>setPartMode('stock')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${partMode==='stock'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>üì¶ Stok Toko</button>
                            <button type="button" onClick={()=>setPartMode('manual')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${partMode==='manual'?'bg-blue-600 text-white shadow-lg':'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>‚úèÔ∏è Input Manual</button>
                        </div>
                        <div className="space-y-3 mb-6">
                            {partMode === 'manual' ? (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Nama Barang *</label>
                                        <input className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Contoh: LCD iPhone 12" value={manualPart.name} onChange={e=>setManualPart({...manualPart, name:e.target.value})}/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-2">
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 block mb-1">Harga Beli (Modal) *</label>
                                            <NumberInput value={manualPart.buyPrice} onChange={(val)=>setManualPart({...manualPart, buyPrice:val})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-slate-600 block mb-1">Harga Jual *</label>
                                            <NumberInput value={manualPart.sellPrice} onChange={(val)=>setManualPart({...manualPart, sellPrice:val})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="0"/>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-600 block mb-1">Jumlah (Qty) *</label>
                                        <NumberInput value={manualPart.qty} onChange={(val)=>setManualPart({...manualPart, qty:val || 1})} className="w-full border border-slate-300 rounded-lg p-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 font-bold" placeholder="1"/>
                                    </div>
                                    {manualPart.buyPrice && manualPart.sellPrice && (
                                        <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                            <p className="text-xs text-slate-600 mb-1">Keuntungan per item:</p>
                                            <p className="text-sm font-bold text-blue-600">{formatCurrency((parseFloat(manualPart.sellPrice) - parseFloat(manualPart.buyPrice)) * (manualPart.qty || 1))}</p>
                                        </div>
                                    )}
                                </>
                            ) : (
                                <select className="w-full border rounded-lg p-3 text-sm bg-white focus:outline-blue-500" value={selectedPart} onChange={e => setPart(e.target.value)}>
                                    <option value="">-- Pilih Barang --</option>
                                    {inventory.map(i => <option key={i.id} value={i.id} disabled={i.stock <= 0}>{i.name} - {formatCurrency(i.sellPrice)} (Stok: {i.stock})</option>)}
                                </select>
                            )}
                        </div>
                        <button onClick={add} disabled={loading} className="w-full py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 shadow-lg shadow-green-200 flex items-center justify-center gap-2">
                            {loading ? "Menyimpan..." : "Tambahkan & Simpan"}
                        </button>
                    </div>
                </div>
            );
        };

        const ServiceForm = ({ initial, inventory, close, save, allServices = [] }) => {
            // Default form structure
            const defaultForm = { 
                customerName:'', phone:'', unitType:'', address:'', imei:'', complaint:'', serviceFee:0, dp:0, 
                status:'Diterima', paymentMethod:'Cash', warranty:'', usedParts:[], paymentStatus:'Belum Lunas',
                qcFunctional: {
                    microphone: false, speaker_bawah: false, touchscreen: false, proximity: false,
                    volume: false, silent: false, bluetooth: false, nfc: false, speaker_atas: false,
                    lcd: false, face_id: false, vibrator: false, power: false, charging: false,
                    wifi: false, flashlight: false, truetone: false,
                    kamera_belakang: { wide: false, ultrawide: false, tele: false },
                    kamera_depan: { wide: false, ultrawide: false }
                },
                kelengkapan: {
                    sim: false, sim_ejector: false, kabel_charger: false, charger_adapter: false,
                    box_dus: false, manual_buku: false, garansi: false, sticker: false,
                    screen_protector: false, case_casing: false
                }
            };
            
            // If initial has customerName, use it (from customer click). Otherwise check for id (edit mode)
            const [form, setForm] = useState(() => {
                if (initial.id) {
                    // Edit mode - use full initial data
                    return initial;
                } else if (initial.customerName) {
                    // New service from customer click - merge with defaults but keep customer data
                    return { ...defaultForm, ...initial };
                } else {
                    // New service - use defaults but preserve ownerId if provided
                    return { ...defaultForm, ownerId: initial.ownerId };
                }
            });
            const [showParts, setShowParts] = useState(!!(form.usedParts && form.usedParts.length > 0));
            const [showQC, setShowQC] = useState(false);
            const [showKelengkapan, setShowKelengkapan] = useState(false);
            const [partMode, setPartMode] = useState('stock');
            const [selectedPart, setPart] = useState('');
            const [manualPart, setManualPart] = useState({name:'', price:''});
            const [saving, setSaving] = useState(false);
            // Master + Owner Kelengkapan Items (Dynamic)
            const [kelengkapanItems, setKelengkapanItems] = useState([]);
            const [customerDropdownOpen, setCustomerDropdownOpen] = useState(false);
            
            // Extract unique customers from allServices for dropdown
            const uniqueCustomers = Array.from(new Map(
                allServices.map(s => [s.customerName?.toLowerCase(), {
                    name: s.customerName,
                    phone: s.phone,
                    address: s.address,
                    phoneType: s.unitType
                }])
            ).values())
            .sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            
            // Riwayat Service Pelanggan
            const serviceHistory = allServices.filter(s => 
                s.customerName?.toLowerCase() === form.customerName.toLowerCase() && 
                s.id !== initial.id
            ).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).slice(0, 5);
            
            const loadFromHistory = (prevService) => {
                setForm(prev => ({
                    ...prev,
                    phone: prevService.phone,
                    unitType: prevService.unitType,
                    address: prevService.address,
                    imei: prevService.imei,
                    complaint: prevService.complaint,
                    warranty: prevService.warranty
                }));
            };

            const partsTotal = (form.usedParts||[]).reduce((a,b) => a + (parseFloat(b.sellPrice) * b.qty), 0);
            const modalSparepart = (form.usedParts||[]).reduce((a,b) => a + ((parseFloat(b.buyPrice)||0) * b.qty), 0);
            const totalBiaya = (parseFloat(form.serviceFee)||0); // Total Biaya sudah termasuk harga jual sparepart
            const total = totalBiaya - modalSparepart; // Laba = Total Biaya - Modal Sparepart
            const untungJual = partsTotal - modalSparepart; // Untung dari jual sparepart
            const untungJasa = totalBiaya - partsTotal; // Untung Jasa = Total Biaya - Harga Jual Sparepart
            const sisa = totalBiaya - (parseFloat(form.dp)||0);

            const addPart = () => {
                if (partMode === 'stock') {
                    const item = inventory.find(i => i.id === selectedPart);
                    if (item) {
                        setForm(p => ({ ...p, usedParts: [...(p.usedParts||[]), { ...item, qty: 1, isManual: false }] }));
                        setPart('');
                    }
                } else {
                    if(manualPart.name && manualPart.price) {
                        setForm(p => ({ ...p, usedParts: [...(p.usedParts||[]), { 
                           id: 'man_'+Date.now(), name: manualPart.name + ' (Manual)', 
                           sellPrice: parseFloat(manualPart.price), qty: 1, isManual: true 
                        }]}));
                        setManualPart({name:'', price:''});
                    }
                }
            };
            
            const handleSave = async () => {
                setSaving(true);
                try {
                     // Just call save - stock adjustment is handled in saveService function
                     await save(form);
                } catch(e) {
                    alert("Error: " + e.message);
                }
                setSaving(false);
            };

            const removePart = async (idx) => {
                const partToRemove = form.usedParts[idx];
                
                // Jika part bukan manual dan sudah tersimpan di database, kembalikan stok
                if (initial.id && !partToRemove.isManual && partToRemove.id) {
                    if (confirm(`Hapus ${partToRemove.name} dari service? Stok akan dikembalikan.`)) {
                        try {
                            await runTransaction(db, async (transaction) => {
                                // Update service - remove part
                                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', initial.id);
                                const newUsedParts = form.usedParts.filter((_, i) => i !== idx);
                                transaction.update(serviceRef, {
                                    usedParts: newUsedParts,
                                    updatedAt: serverTimestamp()
                                });
                                
                                // Return stock
                                const invRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', partToRemove.id);
                                transaction.update(invRef, {
                                    stock: increment(partToRemove.qty)
                                });
                            });
                            
                            // Update local state
                            setForm(p => ({ ...p, usedParts: p.usedParts.filter((_, i) => i !== idx) }));
                            alert('‚úÖ Sparepart dihapus dan stok dikembalikan');
                        } catch (err) {
                            alert('Gagal hapus sparepart: ' + err.message);
                        }
                    }
                } else {
                    // Jika belum tersimpan atau manual, langsung hapus dari state
                    setForm(p => ({ ...p, usedParts: p.usedParts.filter((_, i) => i !== idx) }));
                }
            };

            // Load Master + Owner Kelengkapan Items
            useEffect(() => {
                if (!initial.ownerId) return;
                
                // Real-time listener for Kelengkapan items
                const masterUnsub = onSnapshot(
                    query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_kelengkapan_items')),
                    (masterSnap) => {
                        const masterItems = masterSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'master' }));
                        
                        // Also listen for owner's custom items
                        const ownerUnsub = onSnapshot(
                            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'kelengkapan_items'), where('ownerId', '==', initial.ownerId)),
                            (ownerSnap) => {
                                const ownerItems = ownerSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'owner' }));
                                
                                // Combine and deduplicate by name
                                const allItems = [...masterItems, ...ownerItems];
                                const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                setKelengkapanItems(uniqueItems);

                                // Initialize form.kelengkapan state for each item
                                const newKelengkapan = {};
                                uniqueItems.forEach(item => {
                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                    newKelengkapan[itemKey] = form.kelengkapan[itemKey] || false;
                                });
                                setForm(prev => ({ ...prev, kelengkapan: { ...prev.kelengkapan, ...newKelengkapan } }));
                            }
                        );
                        
                        return () => ownerUnsub();
                    }
                );
                
                return () => masterUnsub();
            }, [initial.ownerId]);
            
            // Load Master + Owner QC Functional Items (Real-time)
            const [qcItems, setQCItems] = useState([]);
            useEffect(() => {
                if (!initial.ownerId) {
                    console.log('No ownerId, skipping QC items load');
                    return;
                }
                
                console.log('Loading QC items for ownerId:', initial.ownerId);
                
                // Real-time listener for Master QC items first
                const masterUnsub = onSnapshot(
                    query(collection(db, APP_COLLECTION_PREFIX, 'public', 'master_qc_functional_items')),
                    (masterSnap) => {
                        const masterItems = masterSnap.docs.map(d => ({ id: d.id, ...d.data(), type: 'master' }));
                        
                        // Also listen for owner's custom QC items
                        const ownerUnsub = onSnapshot(
                            query(collection(db, APP_COLLECTION_PREFIX, 'public', 'qc_functional_items'), 
                                where('ownerId', '==', initial.ownerId)),
                            (snap) => {
                                const ownerItems = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'owner' }));
                                
                                // Combine and deduplicate by name
                                const allItems = [...masterItems, ...ownerItems];
                                const uniqueItems = Array.from(new Map(allItems.map(item => [item.name.toLowerCase(), item])).values());
                                
                                console.log('QC items loaded:', uniqueItems);
                                setQCItems(uniqueItems);
                                
                                // Update form.qcFunctional with all items
                                const newQC = {};
                                uniqueItems.forEach(item => {
                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                    newQC[itemKey] = form.qcFunctional[itemKey] || false;
                                });
                                setForm(prev => ({ ...prev, qcFunctional: { ...prev.qcFunctional, ...newQC } }));
                            },
                            (error) => {
                                console.error('Error loading QC items:', error);
                            }
                        );
                        
                        return () => ownerUnsub();
                    }
                );
                
                return () => masterUnsub();
            }, [initial.ownerId]);

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70] animate-fade-in">
                    <div className="bg-white w-full max-w-4xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-6 border-b pb-4">
                             <div className="flex items-center gap-3">
                                 <h3 className="font-bold text-xl text-slate-800">{initial.id ? 'Edit Servis' : 'Servis Baru'}</h3>
                                 {!initial.id && form.customerName && (
                                     <div className="bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full flex items-center gap-2">
                                         <span>üë§</span>
                                         {form.customerName}
                                     </div>
                                 )}
                             </div>
                             <button onClick={close} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        
                        {/* Riwayat Service Pelanggan */}
                        {!initial.id && serviceHistory.length > 0 && (
                            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6">
                                <p className="text-xs font-bold text-blue-600 uppercase mb-3 flex items-center gap-2">
                                    <History className="w-4 h-4"/> Riwayat Service Pelanggan
                                </p>
                                <div className="space-y-2">
                                    {serviceHistory.map((prev, idx) => (
                                        <button
                                            key={prev.id}
                                            onClick={() => loadFromHistory(prev)}
                                            className="w-full text-left p-3 bg-white border border-blue-100 rounded-lg hover:bg-blue-100 transition-all flex justify-between items-center"
                                        >
                                            <div>
                                                <p className="text-xs font-bold text-slate-600">{formatDate(prev.createdAt)} ‚Ä¢ {prev.unitType}</p>
                                                <p className="text-sm text-slate-700 font-medium">Status: {prev.status}</p>
                                            </div>
                                            <Copy className="w-4 h-4 text-blue-500 flex-shrink-0"/>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* Info: Customer Data Pre-filled */}
                        {!initial.id && form.customerName && (
                            <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg flex items-start gap-2">
                                <CheckCircle className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5"/>
                                <div>
                                    <p className="text-xs font-bold text-green-800">Data Pelanggan Ter-isi Otomatis</p>
                                    <p className="text-xs text-green-700 mt-1">
                                        Nama, nomor HP, alamat, dan tipe HP sudah ter-isi dari data pelanggan. 
                                        Atau klik layanan sebelumnya di bawah untuk auto-fill dari riwayat servis.
                                    </p>
                                </div>
                            </div>
                        )}
                        
                        {/* COMPACT LAYOUT START */}
                        <div className="space-y-4">
                            {/* Baris 1: Info Utama - 4 Kolom */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div className="md:col-span-1 relative">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Nama Pelanggan</label>
                                    <input 
                                        className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" 
                                        value={form.customerName} 
                                        onChange={e=>setForm({...form, customerName:e.target.value})} 
                                        onFocus={() => setCustomerDropdownOpen(true)}
                                        onBlur={() => setTimeout(() => setCustomerDropdownOpen(false), 200)}
                                        required 
                                        placeholder="Ketik nama atau pilih..."
                                    />
                                    
                                    {/* Quick select dropdown untuk customers */}
                                    {customerDropdownOpen && uniqueCustomers.length > 0 && (
                                        <div className="absolute top-full left-0 right-0 bg-white border border-slate-200 rounded-b-md shadow-lg z-20 max-h-60 overflow-y-auto">
                                            {uniqueCustomers
                                                .filter(c => !form.customerName || c.name?.toLowerCase().includes(form.customerName.toLowerCase()))
                                                .slice(0, 5)
                                                .map((c, idx) => (
                                                    <button
                                                        key={idx}
                                                        type="button"
                                                        onClick={() => {
                                                            setForm({
                                                                ...form,
                                                                customerName: c.name,
                                                                phone: c.phone || form.phone,
                                                                address: c.address || form.address,
                                                                unitType: c.phoneType || form.unitType
                                                            });
                                                            setCustomerDropdownOpen(false);
                                                        }}
                                                        className="w-full text-left px-3 py-2 hover:bg-blue-50 border-b last:border-b-0"
                                                    >
                                                        <div className="flex justify-between items-start gap-2">
                                                            <div className="flex-1">
                                                                <div className="font-bold text-sm text-slate-700">{c.name}</div>
                                                                {c.address && (
                                                                    <div className="text-[10px] text-slate-500 mt-0.5 line-clamp-1">
                                                                        üìç {c.address}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <span className="text-slate-600 text-[10px] font-medium whitespace-nowrap">{c.phone}</span>
                                                        </div>
                                                    </button>
                                                ))}
                                        </div>
                                    )}
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">No HP / WA</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.phone} onChange={e=>setForm({...form, phone:e.target.value})} required placeholder="08..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Tipe HP / Unit</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.unitType} onChange={e=>setForm({...form, unitType:e.target.value})} required placeholder="Tipe..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Garansi (Hari)</label>
                                    <NumberInput className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.warranty} onChange={val=>setForm({...form, warranty:val})} placeholder="30"/>
                                </div>
                            </div>

                            {/* Baris 2: Keluhan, Status & Address */}
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="md:col-span-2">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Keluhan / Kerusakan</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.complaint} onChange={e=>setForm({...form, complaint:e.target.value})} placeholder="Deskripsi kerusakan..."/>
                                </div>
                                <div className="md:col-span-1">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Status Saat Ini</label>
                                    <select className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-bold text-blue-600 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.status} onChange={e=>setForm({...form, status:e.target.value})}>{STATUS_FLOW.map(s=><option key={s}>{s}</option>)}</select>
                                </div>
                            </div>

                            {/* Baris 3: Address & IMEI */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">Alamat Pelanggan</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.address || ''} onChange={e=>setForm({...form, address:e.target.value})} placeholder="Alamat rumah atau tempat kerja"/>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase tracking-wider mb-1 block">IMEI / Serial Number</label>
                                    <input className="w-full border-b-2 border-slate-200 bg-slate-50/50 p-2 text-sm font-medium text-slate-700 focus:border-blue-500 focus:outline-none transition-colors rounded-t-md" value={form.imei || ''} onChange={e=>setForm({...form, imei:e.target.value})} placeholder="IMEI atau Serial..."/>
                                </div>
                            </div>

                            {/* QC Functional Check Section */}
                            <div>
                                <button type="button" onClick={() => setShowQC(!showQC)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showQC ? 'bg-purple-50 text-purple-600 border-purple-200' : 'bg-amber-50 text-amber-600 border-amber-300'}`}>{showQC ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showQC ? "Tutup QC Check" : "QC Cek Fungsional (Klik Disini)"}</button>
                                {showQC && (
                                    <div className="bg-amber-50 p-4 rounded-xl border border-amber-200 mb-4 animate-fade-in shadow-inner">
                                        <h4 className="font-bold text-sm text-amber-900 mb-3">‚úì Cek Fungsional Perangkat ({qcItems.length} items)</h4>
                                        {qcItems.length === 0 ? (
                                            <p className="text-xs text-amber-600 text-center py-4">Belum ada item QC. Tambahkan dari Master Data ‚Üí Cek Fungsional.</p>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                {qcItems.map(item => {
                                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                                    return (
                                                        <label key={item.id} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-amber-100 cursor-pointer hover:bg-amber-50 transition-colors">
                                                            <input type="checkbox" checked={form.qcFunctional[itemKey] || false} onChange={(e) => setForm({...form, qcFunctional: {...form.qcFunctional, [itemKey]: e.target.checked}})} className="w-4 h-4 accent-amber-500"/>
                                                            <span className="text-xs font-medium text-slate-700 flex-1">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400 ml-auto">{item.type === 'master' ? 'üì¶' : 'üë§'}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Kelengkapan / Accessories Section */}
                            <div>
                                <button type="button" onClick={() => setShowKelengkapan(!showKelengkapan)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showKelengkapan ? 'bg-green-50 text-green-600 border-green-200' : 'bg-teal-50 text-teal-600 border-teal-300'}`}>{showKelengkapan ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showKelengkapan ? "Tutup Cek Kelengkapan" : "Cek Kelengkapan / Aksesoris (Klik Disini)"}</button>
                                {showKelengkapan && (
                                    <div className="bg-teal-50 p-4 rounded-xl border border-teal-200 mb-4 animate-fade-in shadow-inner">
                                        <h4 className="font-bold text-sm text-teal-900 mb-3">üì¶ Cek Kelengkapan Paket ({kelengkapanItems.length} items)</h4>
                                        {kelengkapanItems.length === 0 ? (
                                            <p className="text-xs text-teal-600 text-center py-4">Belum ada item master atau custom. Hubungi admin untuk setup.</p>
                                        ) : (
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                                                {kelengkapanItems.map(item => {
                                                    const itemKey = item.name.toLowerCase().replace(/\s+/g, '_');
                                                    return (
                                                        <label key={item.id} className="flex items-center gap-2 p-2 bg-white rounded-lg border border-teal-100 cursor-pointer hover:bg-teal-50 transition-colors">
                                                            <input type="checkbox" checked={form.kelengkapan[itemKey] || false} onChange={(e) => setForm({...form, kelengkapan: {...form.kelengkapan, [itemKey]: e.target.checked}})} className="w-4 h-4 accent-teal-500"/>
                                                            <span className="text-xs font-medium text-slate-700">{item.name}</span>
                                                            <span className="text-[10px] text-slate-400 ml-auto">{item.type === 'master' ? 'üì¶' : 'üë§'}</span>
                                                        </label>
                                                    );
                                                })}
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Sparepart Section Compact */}
                            <div>
                                <button type="button" onClick={() => setShowParts(!showParts)} className={`w-full py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-2 border border-dashed transition-all mb-2 ${showParts ? 'bg-red-50 text-red-600 border-red-200' : 'bg-blue-50 text-blue-600 border-blue-300'}`}>{showParts ? <X className="w-3 h-3"/> : <Plus className="w-3 h-3"/>} {showParts ? "Tutup Input Sparepart" : "Tambah Sparepart / Jasa (Klik Disini)"}</button>
                                {showParts && (
                                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 mb-4 animate-fade-in shadow-inner">
                                        <div className="bg-blue-50 text-blue-800 text-[10px] p-2 mb-2 rounded border border-blue-200">
                                            üí° Gunakan tombol <b>+ Sparepart</b> di tabel utama untuk manajemen stok yang lebih akurat.
                                        </div>
                                        <div className="flex gap-2 mb-2 border-b border-slate-200 pb-2">
                                            <button type="button" onClick={()=>setPartMode('stock')} className={`flex-1 py-1 text-[10px] font-bold rounded-lg transition-all ${partMode==='stock'?'bg-white text-blue-600 shadow-sm border border-blue-100':'text-slate-500 hover:bg-gray-200'}`}>üì¶ Dari Stok</button>
                                            <button type="button" onClick={()=>setPartMode('manual')} className={`flex-1 py-1 text-[10px] font-bold rounded-lg transition-all ${partMode==='manual'?'bg-white text-blue-600 shadow-sm border border-blue-100':'text-slate-500 hover:bg-gray-200'}`}>‚úèÔ∏è Manual</button>
                                        </div>
                                        <div className="flex gap-2 mb-2">
                                            {partMode === 'manual' ? (
                                                <>
                                                    <input className="flex-1 border rounded-lg p-2 text-xs focus:outline-blue-500" placeholder="Nama Barang" value={manualPart.name} onChange={e=>setManualPart({...manualPart, name:e.target.value})}/>
                                                    <NumberInput className="w-24 border rounded-lg p-2 text-xs focus:outline-blue-500 font-bold" placeholder="Harga" value={manualPart.price} onChange={val=>setManualPart({...manualPart, price:val})} onFocus={e => e.target.select()}/>
                                                </>
                                            ) : (
                                                <>
                                                    <select className="flex-1 border rounded-lg p-2 text-xs bg-white focus:outline-blue-500" value={selectedPart} onChange={e => setPart(e.target.value)}>
                                                        <option value="">-- Pilih Barang --</option>
                                                        {inventory.map(i => <option key={i.id} value={i.id}>{i.name} - {formatCurrency(i.sellPrice)}</option>)}
                                                    </select>
                                                    {selectedPart && (
                                                        <div className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold border border-blue-200 whitespace-nowrap flex items-center">
                                                            {formatCurrency(inventory.find(i => i.id === selectedPart)?.sellPrice || 0)}
                                                        </div>
                                                    )}
                                                </>
                                            )}
                                            <button type="button" onClick={addPart} className="bg-blue-600 text-white px-3 py-1 rounded-lg font-bold hover:bg-blue-700 shadow-sm"><Plus className="w-4 h-4"/></button>
                                        </div>
                                        <div className="space-y-3 mb-6 text-sm">
                            {(form.usedParts||[]).map((p,i)=>(<div key={i} className="flex justify-between items-center text-xs bg-white p-1.5 rounded border border-slate-200 shadow-sm"><span className="font-medium text-slate-700">{p.name}</span><div className="flex items-center gap-2"><span className="font-bold text-slate-600">{formatCurrency(p.sellPrice)} x {p.qty} = {formatCurrency(p.sellPrice * p.qty)}</span><button type="button" onClick={()=>removePart(i)} className="text-red-400 hover:text-red-600 bg-red-50 p-0.5 rounded"><X className="w-3 h-3"/></button></div></div>))}</div>
                                    </div>
                                )}
                            </div>

                            {/* Biaya Section Compact Horizontal */}
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 pt-4 border-t border-dashed border-slate-200">
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Biaya (Rp)</label>
                                    <NumberInput value={form.serviceFee} onChange={(val)=>setForm({...form, serviceFee:val})} className="w-full bg-slate-50 border border-slate-200 p-2 rounded text-right font-bold text-slate-700 focus:border-blue-500 focus:bg-white focus:outline-none" placeholder="0"/>
                                    <p className="text-[9px] text-slate-500 mt-1">{form.serviceFee ? formatCurrency(parseFloat(form.serviceFee) || 0) : '-'}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Sparepart</label>
                                    <div className="w-full bg-slate-100 border border-slate-200 p-2 rounded text-right font-black text-slate-800">{formatCurrency(partsTotal)}</div>
                                    <p className="text-[9px] text-slate-500 mt-1">Modal: {formatCurrency(modalSparepart)}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Total Laba</label>
                                    <div className="w-full bg-green-100 border border-green-300 p-2 rounded text-right font-black text-green-800 text-lg">{formatCurrency(total)}</div>
                                    <p className="text-[9px] text-slate-600 mt-1">Jual: {formatCurrency(untungJual)} | Jasa: {formatCurrency(untungJasa)}</p>
                                </div>
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Bayar / DP</label>
                                    <NumberInput value={form.dp} onChange={(val)=>setForm({...form, dp:val})} className="w-full bg-green-50 border border-green-200 p-2 rounded text-right font-bold text-green-700 focus:border-green-500 focus:bg-white focus:outline-none" placeholder="0"/>
                                    <p className="text-[9px] text-green-600 mt-1 font-bold">{form.dp ? formatCurrency(parseFloat(form.dp) || 0) : '-'}</p>
                                </div>
                            </div>
                        </div>
                        {/* COMPACT LAYOUT END */}

                        <div className="p-5 border-t bg-gray-50 rounded-b-2xl flex gap-3 mt-6 -mx-6 -mb-6">
                            <button onClick={close} className="flex-1 py-3 border border-gray-300 bg-white rounded-xl font-bold text-slate-600 hover:bg-slate-50 transition-colors">Batal</button>
                            <button onClick={handleSave} disabled={saving} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-600/30 hover:bg-blue-700 transition-colors">{saving ? 'Menyimpan...' : 'Simpan Data'}</button>
                        </div>
                    </div>
                </div>
            )
        };

        const SalesManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const { data: sales } = useFirestoreCollection('sales', activeOwner?.id, activeStore?.id);
            const { data: inventory } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
            const [tab, setTab] = useState('cart');
            const [modal, setModal] = useState(null);
            const [term, setTerm] = useState('');
            const [searchBarang, setSearchBarang] = useState('');
            const [cart, setCart] = useState([]);
            const [customerName, setCustomerName] = useState('');
            const [paymentMethod, setPaymentMethod] = useState('cash');
            const [discount, setDiscount] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            // Calculate cart totals
            const subtotal = cart.reduce((a, b) => a + (b.qty * b.sellPrice), 0);
            const discountAmount = (subtotal * discount) / 100;
            const total = subtotal - discountAmount;

            const addToCart = (item) => {
                const existing = cart.find(c => c.id === item.id);
                if (existing) {
                    if (existing.qty < item.stock) {
                        setCart(cart.map(c => c.id === item.id ? {...c, qty: c.qty + 1} : c));
                    } else {
                        alert(`Stok ${item.name} hanya ${item.stock} unit`);
                    }
                } else {
                    setCart([...cart, {...item, qty: 1}]);
                }
            };

            const removeFromCart = (itemId) => {
                setCart(cart.filter(c => c.id !== itemId));
            };

            const updateCartQty = (itemId, newQty) => {
                if (newQty <= 0) {
                    removeFromCart(itemId);
                } else {
                    const item = inventory.find(i => i.id === itemId);
                    if (newQty <= item.stock) {
                        setCart(cart.map(c => c.id === itemId ? {...c, qty: newQty} : c));
                    } else {
                        alert(`Stok ${item.name} hanya ${item.stock} unit`);
                    }
                }
            };

            const handleSaveSale = async () => {
                if (!customerName.trim()) {
                    alert("Nama pelanggan wajib diisi");
                    return;
                }
                if (cart.length === 0) {
                    alert("Keranjang tidak boleh kosong");
                    return;
                }

                try {
                    const payload = {
                        customerName,
                        items: cart.map(c => ({name: c.name, qty: c.qty, sellPrice: c.sellPrice, buyPrice: c.buyPrice, id: c.id})),
                        subtotal,
                        discount,
                        discountAmount,
                        total,
                        paymentMethod,
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        createdAt: serverTimestamp(),
                        type: 'sale'
                    };
                    
                    // Calculate modal (cost) and profit
                    let totalModal = 0;
                    let totalProfit = 0;
                    
                    // Calculate costs (tidak update stok dulu)
                    for (const item of cart) {
                        // Calculate modal per item
                        const itemModal = (item.buyPrice || 0) * item.qty;
                        totalModal += itemModal;
                        
                        // Calculate profit per item
                        const itemProfit = ((item.sellPrice || 0) - (item.buyPrice || 0)) * item.qty;
                        totalProfit += itemProfit;
                    }
                    
                    // Use transaction to ensure atomicity
                    const saleRef = doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'));
                    
                    await runTransaction(db, async (transaction) => {
                        // 1. Simpan sale
                        transaction.set(saleRef, payload);
                        
                        // 2. Kurangi stok untuk setiap item di cart
                        for (const item of cart) {
                            const itemRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            transaction.update(itemRef, {
                                stock: increment(-item.qty)
                            });
                        }
                    });
                    
                    const saleId = saleRef.id;
                    
                    // Create transaction records
                    const batch = writeBatch(db);
                    
                    // 1. PENGELUARAN (Modal/Cost)
                    if (totalModal > 0) {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'expense',
                            category: 'Modal Barang Terjual',
                            description: `Modal penjualan untuk ${customerName}`,
                            amount: totalModal,
                            date: serverTimestamp(),
                            originalSaleId: saleId
                        });
                    }
                    
                    // 2. PEMASUKAN (Revenue) - Only if not credit
                    if (paymentMethod !== 'credit') {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'income',
                            category: 'Penjualan Barang',
                            description: `Penjualan ${cart.length} item ke ${customerName}`,
                            amount: payload.total,
                            date: serverTimestamp(),
                            originalSaleId: saleId
                        });
                    }
                    
                    // If credit, create receivable (piutang)
                    if (paymentMethod === 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: 'receivable',
                            customerName: customerName,
                            amount: payload.total,
                            paid: 0,
                            remaining: payload.total,
                            description: `Penjualan ${cart.length} item`,
                            dueDate: null,
                            status: 'unpaid',
                            createdAt: serverTimestamp()
                        });
                    }
                    
                    // 3. KEUNTUNGAN (Profit/Loss)
                    if (totalProfit !== 0) {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions')), {
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            type: totalProfit > 0 ? 'profit' : 'loss',
                            category: totalProfit > 0 ? 'Keuntungan Penjualan' : 'Rugi Penjualan',
                            description: `${totalProfit > 0 ? 'Profit' : 'Loss'} dari penjualan ke ${customerName}`,
                            amount: Math.abs(totalProfit),
                            date: serverTimestamp(),
                            originalSaleId: saleId
                        });
                    }
                    
                    await batch.commit();
                    
                    // Reset form
                    setCart([]);
                    setCustomerName('');
                    setDiscount(0);
                    setPaymentMethod('cash');
                    setModal(null);
                    alert('‚úÖ Penjualan berhasil disimpan!');
                } catch (err) {
                    alert("Gagal simpan: " + err.message);
                }
            };

            const handleReturn = async (saleId, returnData) => {
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'sales'), {
                        ...returnData,
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        createdAt: serverTimestamp(),
                        type: 'return',
                        originalSaleId: saleId
                    });
                    alert('‚úÖ Retur berhasil dicatat!');
                } catch (err) {
                    alert("Gagal retur: " + err.message);
                }
            };

            const deleteSale = async (id) => {
                if (confirm("Hapus transaksi penjualan ini? Stok akan dikembalikan dan semua transaksi terkait akan dihapus.")) {
                    try {
                        const saleRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'sales', id);
                        const saleSnap = await getDoc(saleRef);
                        
                        if (!saleSnap.exists()) {
                            alert('Sale tidak ditemukan');
                            return;
                        }
                        
                        const saleData = saleSnap.data();
                        
                        // Get all related transactions first
                        const transRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions');
                        const q = query(transRef, where('originalSaleId', '==', id));
                        const transSnap = await getDocs(q);
                        
                        // Use transaction to ensure atomicity
                        await runTransaction(db, async (transaction) => {
                            // 1. Kembalikan stok untuk setiap item
                            for (const item of (saleData.items || [])) {
                                if (item.id) {
                                    const itemRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                                    transaction.update(itemRef, {
                                        stock: increment(item.qty)
                                    });
                                }
                            }
                            
                            // 2. Hapus semua transactions terkait
                            transSnap.docs.forEach(doc => {
                                transaction.delete(doc.ref);
                            });
                            
                            // 3. Hapus sale
                            transaction.delete(saleRef);
                        });
                        
                        alert('‚úÖ Transaksi dihapus, stok dikembalikan, dan semua data terkait dihapus');
                    } catch (err) {
                        alert("Gagal hapus: " + err.message);
                    }
                }
            };

            const sales_list = (sales || []).filter(s => s.customerName?.toLowerCase().includes(term));
            
            // Pagination logic
            const totalItems = sales_list.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedSales = sales_list.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [term]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200">
                            {[
                                { id: 'cart', label: 'Keranjang' },
                                { id: 'history', label: 'Riwayat' }
                            ].map(t => (
                                <button key={t.id} onClick={() => { setTab(t.id); setTerm(''); }} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>{t.label}</button>
                            ))}
                        </div>
                        <button onClick={() => setTab('cart')} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700"><Plus className="w-5 h-5"/> Penjualan Baru</button>
                    </div>

                    {tab === 'cart' ? (
                        <>
                            {/* Daftar Barang */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div>
                                    <h3 className="font-bold text-lg mb-4 text-slate-800">Daftar Barang</h3>
                                    <div className="bg-white p-3 rounded-xl border border-slate-200 mb-3 sticky top-0 z-10">
                                        <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={searchBarang} onChange={e => setSearchBarang(e.target.value)} placeholder="Cari barang..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                                    </div>
                                    <div className="space-y-2 max-h-96 overflow-y-auto bg-white rounded-xl p-4 border border-slate-200">
                                        {(inventory || []).filter(i => i.stock > 0 && i.name?.toLowerCase().includes(searchBarang.toLowerCase())).map(item => (
                                            <button key={item.id} onClick={() => addToCart(item)} className="w-full text-left p-3 rounded-lg border border-slate-200 hover:border-blue-500 hover:bg-blue-50 transition-all flex items-center justify-between group">
                                                <div>
                                                    <p className="font-bold text-slate-800">{item.name}</p>
                                                    <p className="text-xs text-slate-500">Stok: {item.stock} | Harga: {formatCurrency(item.sellPrice)}</p>
                                                </div>
                                                <Plus className="w-4 h-4 text-slate-400 group-hover:text-blue-600" />
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Keranjang */}
                                <div>
                                    <h3 className="font-bold text-lg mb-4 text-slate-800">Keranjang Belanja</h3>
                                    <div className="bg-white rounded-xl p-4 border border-slate-200 space-y-4">
                                        <div className="space-y-3 max-h-48 overflow-y-auto border-b pb-4">
                                            {cart.length === 0 ? (
                                                <p className="text-center text-slate-400 py-6">Keranjang kosong</p>
                                            ) : (
                                                cart.map(item => (
                                                    <div key={item.id} className="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                                                        <div className="flex-1">
                                                            <p className="font-bold text-sm text-slate-800">{item.name}</p>
                                                            <p className="text-xs text-slate-500">{formatCurrency(item.sellPrice)} √ó {item.qty}</p>
                                                        </div>
                                                        <div className="flex items-center gap-2">
                                                            <button onClick={() => updateCartQty(item.id, item.qty - 1)} className="text-slate-500 hover:text-red-600 p-1"><Minus className="w-4 h-4" /></button>
                                                            <span className="w-6 text-center text-sm font-bold">{item.qty}</span>
                                                            <button onClick={() => updateCartQty(item.id, item.qty + 1)} className="text-slate-500 hover:text-green-600 p-1"><Plus className="w-4 h-4" /></button>
                                                            <button onClick={() => removeFromCart(item.id)} className="text-red-500 hover:bg-red-50 p-1 rounded"><X className="w-4 h-4" /></button>
                                                        </div>
                                                        <p className="text-sm font-bold text-green-600 w-20 text-right">{formatCurrency(item.qty * item.sellPrice)}</p>
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        {/* Ringkasan */}
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between"><span>Subtotal</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                            <div className="flex justify-between"><span>Diskon</span><span className="font-bold text-orange-600">{discount}% ({formatCurrency(discountAmount)})</span></div>
                                            <div className="flex justify-between border-t pt-2"><span className="font-bold">Total</span><span className="font-bold text-lg text-green-600">{formatCurrency(total)}</span></div>
                                        </div>

                                        {cart.length > 0 && (
                                            <button onClick={() => setModal('checkout')} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold transition-all">Checkout</button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </>
                    ) : (
                        <>
                            <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10">
                                <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari berdasarkan pelanggan..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white transition-all" /></div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-50 border-b text-slate-600 font-bold uppercase text-xs">
                                            <tr>
                                                <th className="p-4">Tanggal</th>
                                                <th className="p-4">Pelanggan</th>
                                                <th className="p-4">Item</th>
                                                <th className="p-4 text-right">Subtotal</th>
                                                <th className="p-4 text-right">Diskon</th>
                                                <th className="p-4 text-right">Total</th>
                                                <th className="p-4">Metode</th>
                                                <th className="p-4 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {paginatedSales.map(s => (
                                                <tr key={s.id} className="hover:bg-slate-50">
                                                    <td className="p-4 text-slate-600 text-xs">{formatDate(s.createdAt)}</td>
                                                    <td className="p-4 font-bold text-slate-800">{s.customerName}</td>
                                                    <td className="p-4 text-slate-600 text-xs">{s.items?.length || 0} item(s)</td>
                                                    <td className="p-4 text-right text-slate-600">{formatCurrency(s.subtotal || 0)}</td>
                                                    <td className="p-4 text-right text-orange-600 font-bold">{s.discount || 0}%</td>
                                                    <td className="p-4 text-right font-bold text-green-600">{formatCurrency(s.total || 0)}</td>
                                                    <td className="p-4 text-xs"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded">{s.paymentMethod || '-'}</span></td>
                                                    <td className="p-4 text-center">
                                                        <button onClick={() => deleteSale(s.id)} className="text-red-500 hover:bg-red-50 p-2 rounded transition-all"><Trash2 className="w-4 h-4" /></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {paginatedSales.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada riwayat penjualan.</div>}
                                </div>
                            </div>
                            
                            {/* Pagination Controls */}
                            <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                                <div className="flex items-center gap-3">
                                    <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                                    <div className="flex gap-2">
                                        <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                        <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                                    </div>
                                </div>
                                <div className="text-sm text-slate-600 font-medium">
                                    Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                                </div>
                            </div>
                            
                            {/* Pagination Navigation */}
                            {totalPages > 1 && (
                                <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                                    <button 
                                        onClick={() => handlePageChange(currentPage - 1)} 
                                        disabled={currentPage === 1}
                                        className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                    >
                                        ‚Üê Sebelumnya
                                    </button>
                                    <div className="text-sm text-slate-600 font-medium">
                                        Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                                    </div>
                                    <button 
                                        onClick={() => handlePageChange(currentPage + 1)} 
                                        disabled={currentPage === totalPages}
                                        className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                                    >
                                        Selanjutnya ‚Üí
                                    </button>
                                </div>
                            )}
                        </>
                    )}

                    {/* Modal Checkout */}
                    {modal === 'checkout' && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl space-y-4">
                                <h3 className="font-bold text-xl text-slate-800">Konfirmasi Transaksi</h3>
                                
                                <div className="space-y-3 bg-slate-50 p-4 rounded-lg">
                                    <input type="text" value={customerName} onChange={e => setCustomerName(e.target.value)} placeholder="Nama Pelanggan" className="w-full border border-slate-300 p-2 rounded-lg" />
                                    
                                    <select value={paymentMethod} onChange={e => setPaymentMethod(e.target.value)} className="w-full border border-slate-300 p-2 rounded-lg">
                                        <option value="cash">Tunai</option>
                                        <option value="transfer">Transfer</option>
                                        <option value="card">Kartu Kredit</option>
                                        <option value="credit">üí≥ Kredit (Piutang)</option>
                                    </select>
                                    {paymentMethod === 'credit' && (
                                        <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Akan otomatis dicatat sebagai piutang pelanggan</p>
                                    )}

                                    <div>
                                        <label className="text-xs font-bold text-slate-600">Diskon (%)</label>
                                        <NumberInput value={discount} onChange={val => setDiscount(val || 0)} min="0" max="100" className="w-full border border-slate-300 p-2 rounded-lg mt-1" />
                                    </div>
                                </div>

                                <div className="bg-slate-100 p-3 rounded-lg space-y-1">
                                    <div className="flex justify-between"><span>Subtotal</span><span className="font-bold">{formatCurrency(subtotal)}</span></div>
                                    <div className="flex justify-between"><span>Diskon {discount}%</span><span className="text-orange-600 font-bold">-{formatCurrency(discountAmount)}</span></div>
                                    <div className="flex justify-between border-t pt-1"><span className="font-bold">Total Bayar</span><span className="text-lg font-bold text-green-600">{formatCurrency(total)}</span></div>
                                </div>

                                <div className="flex gap-3">
                                    <button onClick={() => setModal(null)} className="flex-1 py-2 border border-slate-300 rounded-lg font-bold text-slate-600">Batal</button>
                                    <button onClick={handleSaveSale} className="flex-1 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700">Selesai</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CustomerManager = ({ setView }) => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            const { data: customers = [] } = useFirestoreCollection('customers', activeOwner?.id, activeStore?.id);
            const [modal, setModal] = useState(null);
            const [historyModal, setHistoryModal] = useState(null);
            const [term, setTerm] = useState('');
            const [addressFilter, setAddressFilter] = useState('');
            const [typeFilter, setTypeFilter] = useState('');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            
            // Extract unique addresses and phone types for filters
            const uniqueAddresses = [...new Set(customers.map(c => c.address).filter(Boolean))];
            const uniqueTypes = [...new Set(customers.map(c => c.phoneType).filter(Boolean))];
            
            const createServiceFromCustomer = (customer) => {
                // Open service manager dengan data pelanggan ter-fill
                const serviceData = {
                    customerName: customer.name,
                    phone: customer.phone,
                    address: customer.address || '',
                    unitType: '',
                    imei: '',
                    complaint: '',
                    serviceFee: 0,
                    dp: 0,
                    status: 'Diterima',
                    warranty: ''
                };
                
                // Store ke session untuk di-pass ke ServiceManager
                sessionStorage.setItem('newServiceData', JSON.stringify(serviceData));
                setView('service');
            };

            const syncFromServices = async () => {
                const existingEmails = new Set(customers.map(c => c.phone));
                const newCustomers = services
                    .filter(s => s.phone && !existingEmails.has(s.phone))
                    .map(s => ({
                        name: s.customerName,
                        phone: s.phone,
                        address: s.address || '',
                        createdAt: serverTimestamp(),
                        ownerId: activeOwner.id,
                        storeId: activeStore.id
                    }))
                    .slice(0, 10);

                if (newCustomers.length === 0) {
                    alert('Tidak ada pelanggan baru untuk disinkronkan.');
                    return;
                }

                try {
                    const batch = writeBatch(db);
                    newCustomers.forEach(cust => {
                        batch.set(doc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers')), cust);
                    });
                    await batch.commit();
                    alert(`${newCustomers.length} pelanggan baru disinkronkan dari data servis.`);
                } catch (err) {
                    alert("Gagal sinkronisasi: " + err.message);
                }
            };

            const handleSaveCustomer = async (data) => {
                try {
                    if (modal.id) {
                        await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', modal.id), data);
                    } else {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'customers'), {
                            ...data,
                            ownerId: activeOwner.id,
                            storeId: activeStore.id,
                            createdAt: serverTimestamp()
                        });
                    }
                    setModal(null);
                    alert(modal.id ? 'Pelanggan diperbarui' : 'Pelanggan ditambahkan');
                } catch (err) {
                    alert("Gagal simpan: " + err.message);
                }
            };

            const deleteCustomer = async (id) => {
                if (confirm("Hapus pelanggan ini?")) {
                    try {
                        await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'customers', id));
                    } catch (err) {
                        alert("Gagal hapus: " + err.message);
                    }
                }
            };

            const filteredCustomers = customers?.length > 0 ? customers.filter(c => {
                const matchName = (c.name?.toLowerCase().includes(term.toLowerCase()) || false) || (c.phone?.includes(term) || false);
                const matchAddress = !addressFilter || c.address === addressFilter;
                const matchType = !typeFilter || c.phoneType === typeFilter;
                return matchName && matchAddress && matchType;
            }) : [];
            
            // Pagination logic
            const totalItems = filteredCustomers.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedCustomers = filteredCustomers.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [term, addressFilter, typeFilter]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center gap-4">
                        <h2 className="font-bold text-2xl">Daftar Pelanggan</h2>
                        <div className="flex gap-2">
                            <button onClick={syncFromServices} className="bg-purple-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-purple-700 flex items-center gap-2"><RefreshCw className="w-4 h-4" /> Sinkronisasi</button>
                            <button onClick={() => setModal({})} className="bg-blue-600 text-white px-5 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg hover:bg-blue-700"><Plus className="w-5 h-5" /> Pelanggan Baru</button>
                        </div>
                    </div>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 sticky top-0 z-10 space-y-3">
                        <div className="relative"><Search className="absolute left-3 top-3 w-5 h-5 text-gray-400" /><input value={term} onChange={e => setTerm(e.target.value)} placeholder="Cari nama atau nomor WA..." className="pl-10 pr-4 py-2.5 w-full border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50 focus:bg-white" /></div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">Filter Alamat</label>
                                <select value={addressFilter} onChange={e => setAddressFilter(e.target.value)} className="w-full border border-gray-200 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                    <option value="">Semua Alamat</option>
                                    {uniqueAddresses.map(addr => (
                                        <option key={addr} value={addr}>{addr}</option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 mb-1 block">Filter Type HP</label>
                                <select value={typeFilter} onChange={e => setTypeFilter(e.target.value)} className="w-full border border-gray-200 p-2.5 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                                    <option value="">Semua Type</option>
                                    {uniqueTypes.map(type => (
                                        <option key={type} value={type}>{type}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        {(addressFilter || typeFilter || term) && (
                            <div className="text-xs text-slate-600 flex items-center gap-2">
                                <span>Hasil: <strong>{filteredCustomers.length}</strong> pelanggan</span>
                                {(addressFilter || typeFilter || term) && (
                                    <button onClick={() => {setTerm(''); setAddressFilter(''); setTypeFilter('');}} className="text-blue-600 hover:underline text-xs">Bersihkan Filter</button>
                                )}
                            </div>
                        )}
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 border-b text-slate-600 font-bold uppercase text-xs">
                                    <tr>
                                        <th className="p-4">Nama & Alamat</th>
                                        <th className="p-4">No WA</th>
                                        <th className="p-4">Type HP</th>
                                        <th className="p-4">Tgl Terdaftar</th>
                                        <th className="p-4 text-center">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y">
                                    {paginatedCustomers.map(c => (
                                        <tr key={c.id} className="hover:bg-slate-50">
                                            <td className="p-4">
                                                <div className="flex flex-col">
                                                    <button 
                                                        onClick={() => createServiceFromCustomer(c)}
                                                        className="font-bold text-blue-600 hover:text-blue-800 hover:underline cursor-pointer transition text-left"
                                                        title="Klik untuk buat service baru"
                                                    >
                                                        {c.name}
                                                    </button>
                                                    {c.address && (
                                                        <span className="text-xs text-slate-500 mt-1">
                                                            üìç {c.address}
                                                        </span>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="p-4 text-slate-600">{c.phone}</td>
                                            <td className="p-4 text-slate-500 text-xs">{c.phoneType || '-'}</td>
                                            <td className="p-4 text-slate-500">{formatDate(c.createdAt)}</td>
                                            <td className="p-4 text-center flex justify-center gap-2">
                                                <button onClick={() => setHistoryModal(c)} className="text-purple-500 hover:bg-purple-50 p-2 rounded" title="Lihat riwayat service"><History className="w-4 h-4" /></button>
                                                <button onClick={() => setModal(c)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil className="w-4 h-4" /></button>
                                                <button onClick={() => deleteCustomer(c.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4" /></button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            {paginatedCustomers.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada data pelanggan.</div>}
                        </div>
                    </div>
                    
                    {/* Pagination Controls */}
                    <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                            <div className="flex gap-2">
                                <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                                <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                            </div>
                        </div>
                        <div className="text-sm text-slate-600 font-medium">
                            Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                        </div>
                    </div>
                    
                    {/* Pagination Navigation */}
                    {totalPages > 1 && (
                        <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                            <button 
                                onClick={() => handlePageChange(currentPage - 1)} 
                                disabled={currentPage === 1}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                ‚Üê Sebelumnya
                            </button>
                            <div className="text-sm text-slate-600 font-medium">
                                Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                            </div>
                            <button 
                                onClick={() => handlePageChange(currentPage + 1)} 
                                disabled={currentPage === totalPages}
                                className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                            >
                                Selanjutnya ‚Üí
                            </button>
                        </div>
                    )}

                    {modal !== null && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6 border-b pb-4">
                                    <h3 className="font-bold text-xl text-slate-800">{modal.id ? 'Edit Pelanggan' : 'Pelanggan Baru'}</h3>
                                    <button onClick={() => setModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                                </div>
                                <form onSubmit={(e) => {
                                    e.preventDefault();
                                    const formData = new FormData(e.target);
                                    handleSaveCustomer({
                                        name: formData.get('name'),
                                        phone: formData.get('phone'),
                                        address: formData.get('address'),
                                        phoneType: formData.get('phoneType')
                                    });
                                }} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Pelanggan</label>
                                        <input name="name" defaultValue={modal.name || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">No WhatsApp</label>
                                        <input name="phone" defaultValue={modal.phone || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Type HP</label>
                                        <input name="phoneType" defaultValue={modal.phoneType || ''} placeholder="Contoh: iPhone 12, Samsung A50, dll" className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Alamat</label>
                                        <textarea name="address" defaultValue={modal.address || ''} className="w-full border p-2 rounded-lg text-sm focus:outline-blue-500 resize-none" rows="3"></textarea>
                                    </div>
                                    <div className="flex gap-3 mt-6">
                                        <button type="button" onClick={() => setModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button>
                                        <button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg hover:bg-blue-700">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {historyModal !== null && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                            <div className="bg-white w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
                                <div className="flex justify-between items-center mb-6 border-b pb-4 sticky top-0 bg-white">
                                    <h3 className="font-bold text-xl text-slate-800">Riwayat Service: {historyModal.name}</h3>
                                    <button onClick={() => setHistoryModal(null)} className="p-2 hover:bg-gray-100 rounded-full"><X className="w-6 h-6 text-slate-400" /></button>
                                </div>
                                
                                <div className="space-y-3">
                                    {services?.filter(s => s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).length === 0 ? (
                                        <div className="text-center py-8 text-slate-500">
                                            <History className="w-12 h-12 mx-auto mb-3 opacity-50" />
                                            <p>Belum ada riwayat service</p>
                                        </div>
                                    ) : (
                                        <div className="space-y-2">
                                            {services?.filter(s => s.customerName?.toLowerCase() === historyModal.name?.toLowerCase()).sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)).map(svc => (
                                                <div key={svc.id} className="border rounded-lg p-4 hover:bg-slate-50 transition">
                                                    <div className="flex justify-between items-start gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-2">
                                                                <span className="font-bold text-slate-800">{svc.unitType || 'Service'}</span>
                                                                <span className={`text-xs font-bold px-2 py-1 rounded-full ${
                                                                    svc.status === 'Selesai' ? 'bg-green-100 text-green-700' :
                                                                    svc.status === 'Dikerjakan' ? 'bg-blue-100 text-blue-700' :
                                                                    svc.status === 'Diambil' ? 'bg-purple-100 text-purple-700' :
                                                                    svc.status === 'Dibatalkan' ? 'bg-red-100 text-red-700' :
                                                                    'bg-yellow-100 text-yellow-700'
                                                                }`}>{svc.status || 'Antri'}</span>
                                                            </div>
                                                            <p className="text-sm text-slate-600 mb-1">üîß {svc.complaint || 'Tidak ada keluhan'}</p>
                                                            <p className="text-xs text-slate-500">üì± IMEI: {svc.imei || '-'}</p>
                                                            <p className="text-xs text-slate-500">üìÖ {formatDate(svc.createdAt)}</p>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm font-bold text-slate-800 mb-1">Jasa: {formatCurrency(parseFloat(svc.serviceFee) || 0)}</div>
                                                            <div className={`text-xs font-bold px-2 py-1 rounded ${
                                                                svc.paymentStatus === 'Lunas' ? 'bg-green-100 text-green-700' :
                                                                svc.paymentStatus === 'DP' ? 'bg-orange-100 text-orange-700' :
                                                                'bg-red-100 text-red-700'
                                                            }`}>{svc.paymentStatus || 'Belum Bayar'}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const StockManager = () => {
          const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
          const { data: inv } = useFirestoreCollection('inventory', activeOwner?.id, activeStore?.id);
          const [tab, setTab] = useState('barang');
          const [form, setForm] = useState({name:'', category: '', stock:0, buyPrice:0, sellPrice:0});
          const [adjustModal, setAdjustModal] = useState(null);
          const [editModal, setEditModal] = useState(null);
          const [categoryModal, setCategoryModal] = useState(null);
          const [categoryFilter, setCategoryFilter] = useState('');
          const [currentPage, setCurrentPage] = useState(1);
          const [itemsPerPage, setItemsPerPage] = useState(10);
          
          // Get unique categories from inventory
          const categories = [...new Set(inv.map(i => i.category).filter(c => c))];
          const defaultCategories = ['Sparepart', 'Aksesori', 'Tools', 'Lainnya'];
          const allCategories = [...new Set([...categories, ...defaultCategories])];
          
          const add = async (e) => { 
              e.preventDefault(); 
              try {
                  await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory'), {
                      ...form,
                      ownerId: activeOwner.id,
                      storeId: activeStore.id,
                      createdAt: serverTimestamp()
                  });
                  setForm({name:'', category: '', stock:0, buyPrice:0, sellPrice:0});
                  alert('‚úÖ Barang berhasil ditambahkan');
              } catch(err) {
                  alert("Gagal tambah stok: " + err.message);
              }
          };
          
          const canAddStock = checkPermission('feature_stock_add');
          
          // Filter inventory by category
          const filteredInv = categoryFilter ? inv.filter(i => i.category === categoryFilter) : inv;
          
          // Pagination logic
          const totalItems = filteredInv.length;
          const totalPages = Math.ceil(totalItems / itemsPerPage);
          const startIndex = (currentPage - 1) * itemsPerPage;
          const endIndex = startIndex + itemsPerPage;
          const paginatedInv = filteredInv.slice(startIndex, endIndex);
          
          // Reset to page 1 when filter changes
          useEffect(() => {
              setCurrentPage(1);
          }, [categoryFilter]);
          
          const handlePageChange = (newPage) => {
              if (newPage >= 1 && newPage <= totalPages) {
                  setCurrentPage(newPage);
                  window.scrollTo({ top: 0, behavior: 'smooth' });
              }
          };
          
          const handleItemsPerPageChange = (value) => {
              setItemsPerPage(value);
              setCurrentPage(1);
          };

          const handleAdjust = async (itemId, adjustment) => {
              try {
                  const item = inv.find(i => i.id === itemId);
                  const newStock = Math.max(0, (item.stock || 0) + parseInt(adjustment));
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', itemId), {
                      stock: newStock
                  });
                  setAdjustModal(null);
                  alert('Stok diperbarui');
              } catch (err) {
                  alert("Gagal: " + err.message);
              }
          };
          
          const handleEditProduct = async (e) => {
              e.preventDefault();
              try {
                  await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', editModal.id), {
                      name: editModal.name,
                      category: editModal.category,
                      buyPrice: parseFloat(editModal.buyPrice) || 0,
                      sellPrice: parseFloat(editModal.sellPrice) || 0,
                      updatedAt: serverTimestamp()
                  });
                  setEditModal(null);
                  alert('‚úÖ Produk berhasil diupdate');
              } catch (err) {
                  alert('Gagal update: ' + err.message);
              }
          };
          
          const deleteProduct = async (id, name) => {
              if (confirm(`Hapus produk "${name}"? Tindakan ini tidak dapat dibatalkan.`)) {
                  try {
                      await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', id));
                      alert('‚úÖ Produk berhasil dihapus');
                  } catch (err) {
                      alert('Gagal hapus: ' + err.message);
                  }
              }
          };

          const lowStockItems = inv.filter(i => i.stock <= 5 && i.stock > 0);
          
          return (
            <div className="space-y-6">
              <div className="flex justify-between items-center">
                  <h2 className="font-bold text-2xl">Manajemen Stok</h2>
                  <button onClick={() => setCategoryModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-purple-700 text-sm">
                      <Filter className="w-4 h-4" /> Kelola Kategori
                  </button>
              </div>

              <div className="flex gap-2 bg-white rounded-xl p-1 border border-slate-200 w-full overflow-x-auto">
                  {[
                      { id: 'barang', label: 'Daftar Barang' },
                      { id: 'adjustment', label: 'Penyesuaian' },
                      { id: 'opname', label: 'Opname' },
                      { id: 'alerts', label: 'Peringatan Stok' }
                  ].map(t => (
                      <button key={t.id} onClick={() => setTab(t.id)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all whitespace-nowrap ${tab === t.id ? 'bg-blue-600 text-white shadow' : 'text-slate-600 hover:bg-slate-100'}`}>{t.label}</button>
                  ))}
              </div>

              {tab === 'barang' && (
                <>
                  {canAddStock ? (
                      <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                          <h3 className="font-bold text-sm mb-4 text-slate-700">Tambah Barang Baru</h3>
                          <form onSubmit={(e) => {
                              e.preventDefault();
                              addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory'), {
                                  ...form,
                                  ownerId: activeOwner.id,
                                  storeId: activeStore.id,
                                  createdAt: serverTimestamp()
                              }).then(() => {
                                  setForm({name:'', category: '', stock:0, buyPrice:0, sellPrice:0});
                              });
                          }} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                              <div className="md:col-span-4">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Barang</label>
                                  <input className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.name} onChange={e => setForm({...form, name:e.target.value})} required placeholder="Contoh: LCD Samsung A50"/>
                              </div>
                              <div className="md:col-span-3">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Kategori</label>
                                  <select className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500" value={form.category} onChange={e => setForm({...form, category:e.target.value})} required>
                                      <option value="">-- Pilih Kategori --</option>
                                      {allCategories.map(cat => (
                                          <option key={cat} value={cat}>{cat}</option>
                                      ))}
                                  </select>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Stok Awal</label>
                                  <NumberInput value={form.stock} onChange={(val) => setForm({...form, stock:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Modal</label>
                                  <NumberInput value={form.buyPrice} onChange={(val) => setForm({...form, buyPrice:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-2">
                                  <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Harga Jual</label>
                                  <NumberInput value={form.sellPrice} onChange={(val) => setForm({...form, sellPrice:val})} className="w-full border p-2.5 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                              </div>
                              <div className="md:col-span-1">
                                  <button className="w-full bg-blue-600 text-white p-2.5 rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center justify-center"><Plus className="w-5 h-5"/></button>
                              </div>
                          </form>
                      </div>
                  ) : (
                      <div onClick={() => showAccessDenied("Fitur TAMBAH STOK dikunci")} className="bg-red-50 text-red-600 p-4 rounded border border-red-200 flex items-center gap-2 cursor-pointer hover:bg-red-100">
                          <Lock className="w-4 h-4"/> Akses Tambah Stok dikunci.
                      </div>
                  )}
                  
                  <div className="bg-white p-4 rounded-xl border border-slate-200">
                      <div className="flex items-center gap-2 mb-4">
                          <Filter className="w-4 h-4 text-slate-600" />
                          <label className="text-xs font-bold text-slate-500 uppercase">Filter Kategori:</label>
                          <select value={categoryFilter} onChange={e => setCategoryFilter(e.target.value)} className="border p-2 rounded-lg text-sm">
                              <option value="">üìä Semua Kategori ({inv.length})</option>
                              {allCategories.map(cat => (
                                  <option key={cat} value={cat}>
                                      {cat} ({inv.filter(i => i.category === cat).length})
                                  </option>
                              ))}
                          </select>
                      </div>
                  </div>
                  
                  <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                      <div className="overflow-x-auto">
                          <table className="w-full text-sm text-left">
                              <thead className="bg-slate-50 border-b text-slate-500 font-bold uppercase text-xs">
                                  <tr>
                                      <th className="p-4 w-10 text-center">No</th>
                                      <th className="p-4">Barang</th>
                                      <th className="p-4">Kategori</th>
                                      <th className="p-4 text-center">Stok</th>
                                      <th className="p-4 text-right">Harga Modal</th>
                                      <th className="p-4 text-right">Harga Jual</th>
                                      <th className="p-4 text-right">Margin</th>
                                      <th className="p-4 text-center">Aksi</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-slate-100">
                                  {paginatedInv.map((i, idx) => {
                                      const margin = i.buyPrice > 0 ? ((i.sellPrice - i.buyPrice) / i.buyPrice * 100).toFixed(0) : '‚Äî';
                                      const marginColor = margin !== '‚Äî' && margin >= 30 ? 'text-green-600' : margin !== '‚Äî' && margin >= 15 ? 'text-yellow-600' : 'text-red-600';
                                      return (
                                      <tr key={i.id} className="hover:bg-slate-50 transition-colors">
                                          <td className="p-4 text-center text-slate-400 font-bold">{startIndex + idx + 1}</td>
                                          <td className="p-4 font-bold text-slate-700">{i.name}</td>
                                          <td className="p-4">
                                              <span className="inline-block bg-blue-100 text-blue-800 text-xs font-bold px-3 py-1 rounded-full">
                                                  {i.category || '‚Äî'}
                                              </span>
                                          </td>
                                          <td className="p-4 text-center font-bold text-blue-600 bg-blue-50/50 rounded-lg">{i.stock}</td>
                                          <td className="p-4 text-right font-medium text-slate-600">{formatCurrency(i.buyPrice || 0)}</td>
                                          <td className="p-4 text-right font-medium text-slate-600">{formatCurrency(i.sellPrice)}</td>
                                          <td className={`p-4 text-right font-bold ${marginColor}`}>{margin}%</td>
                                          <td className="p-4 text-center">
                                              <div className="flex items-center justify-center gap-2">
                                                  <button onClick={() => setEditModal(i)} className="text-blue-500 hover:bg-blue-50 p-2 rounded" title="Edit Produk"><Pencil className="w-4 h-4" /></button>
                                                  <button onClick={() => setAdjustModal(i)} className="text-orange-500 hover:bg-orange-50 p-2 rounded" title="Sesuaikan Stok"><PenTool className="w-4 h-4" /></button>
                                                  <button onClick={() => deleteProduct(i.id, i.name)} className="text-red-500 hover:bg-red-50 p-2 rounded" title="Hapus Produk"><Trash2 className="w-4 h-4" /></button>
                                              </div>
                                          </td>
                                      </tr>
                                      );
                                  })}
                              </tbody>
                          </table>
                          {paginatedInv.length === 0 && (
                              <div className="p-6 text-center text-slate-500">
                                  üì¶ Tidak ada barang{categoryFilter ? ` dalam kategori "${categoryFilter}"` : ''}
                              </div>
                          )}
                      </div>
                  </div>
                  
                  {/* Pagination Controls */}
                  <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                      <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                          <div className="flex gap-2">
                              <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                              <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                          </div>
                      </div>
                      <div className="text-sm text-slate-600 font-medium">
                          Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                      </div>
                  </div>
                  
                  {/* Pagination Navigation */}
                  {totalPages > 1 && (
                      <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <button 
                              onClick={() => handlePageChange(currentPage - 1)} 
                              disabled={currentPage === 1}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              ‚Üê Sebelumnya
                          </button>
                          <div className="text-sm text-slate-600 font-medium">
                              Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                          </div>
                          <button 
                              onClick={() => handlePageChange(currentPage + 1)} 
                              disabled={currentPage === totalPages}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              Selanjutnya ‚Üí
                          </button>
                      </div>
                  )}
                </>
              )}

              {tab === 'adjustment' && (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b bg-slate-50">
                        <h3 className="font-bold text-slate-800 mb-2">Penyesuaian Stok</h3>
                        <p className="text-sm text-slate-600">Sesuaikan stok untuk koreksi atau pindah lokasi.</p>
                    </div>
                    <div className="divide-y max-h-96 overflow-y-auto">
                        {inv.map(i => (
                            <div key={i.id} className="p-4 flex justify-between items-center hover:bg-slate-50">
                                <div>
                                    <p className="font-bold text-slate-800">{i.name}</p>
                                    <p className="text-xs text-slate-500">Stok saat ini: {i.stock}</p>
                                </div>
                                <button onClick={() => setAdjustModal(i)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700">Sesuaikan</button>
                            </div>
                        ))}
                    </div>
                </div>
              )}

              {tab === 'opname' && (
                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-6 border-b bg-blue-50">
                        <h3 className="font-bold text-blue-900 mb-2">Stock Opname</h3>
                        <p className="text-sm text-blue-700">Periksa dan verifikasi seluruh stok fisik Anda</p>
                    </div>
                    <div className="p-6">
                        <button className="w-full bg-blue-600 text-white px-6 py-3 rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2 mb-4">
                            <Upload className="w-5 h-5" /> Mulai Opname
                        </button>
                        <p className="text-sm text-slate-500 text-center">Fitur opname menyederhanakan proses penghitungan stok fisik dengan form interaktif.</p>
                    </div>
                </div>
              )}

              {tab === 'alerts' && (
                <div className="space-y-4">
                    <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                        <h3 className="font-bold text-red-900 mb-3 flex items-center gap-2"><AlertTriangle className="w-5 h-5" /> Peringatan Stok Rendah</h3>
                        {lowStockItems.length === 0 ? (
                            <p className="text-red-700 text-sm">‚úì Semua stok dalam kondisi normal</p>
                        ) : (
                            <div className="space-y-2">
                                {lowStockItems.map(item => (
                                    <div key={item.id} className="bg-white p-3 rounded-lg border border-red-100 flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-slate-800">{item.name}</p>
                                            <p className="text-xs text-red-600">Stok: {item.stock} unit</p>
                                        </div>
                                        <button onClick={() => setAdjustModal(item)} className="bg-blue-600 text-white px-3 py-1 rounded text-xs font-bold">Tambah</button>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
              )}

              {adjustModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl">
                        <h3 className="font-bold text-xl text-slate-800 mb-2">{adjustModal.name}</h3>
                        <p className="text-sm text-slate-600 mb-6">Stok saat ini: <span className="font-bold text-blue-600">{adjustModal.stock}</span></p>
                        <div className="space-y-3">
                            <NumberInput id="adjustment" placeholder="Masukkan jumlah penyesuaian (+/-)" className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" />
                            <div className="flex gap-2">
                                <button onClick={() => {
                                    const val = parseNumberFromInput(document.getElementById('adjustment').value);
                                    if (val) handleAdjust(adjustModal.id, val);
                                }} className="flex-1 bg-blue-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-blue-700">Simpan</button>
                                <button onClick={() => setAdjustModal(null)} className="flex-1 border py-3 rounded-lg font-bold">Batal</button>
                            </div>
                        </div>
                    </div>
                </div>
              )}
              
              {editModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">Edit Produk</h3>
                            <button onClick={() => setEditModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <form onSubmit={handleEditProduct} className="space-y-4">
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-2">Nama Produk *</label>
                                <input className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500" value={editModal.name} onChange={e => setEditModal({...editModal, name: e.target.value})} required />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-600 block mb-2">Kategori *</label>
                                <select className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 bg-white" value={editModal.category} onChange={e => setEditModal({...editModal, category: e.target.value})} required>
                                    <option value="">-- Pilih Kategori --</option>
                                    {allCategories.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Harga Modal *</label>
                                    <NumberInput value={editModal.buyPrice} onChange={(val) => setEditModal({...editModal, buyPrice: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-600 block mb-2">Harga Jual *</label>
                                    <NumberInput value={editModal.sellPrice} onChange={(val) => setEditModal({...editModal, sellPrice: val})} className="w-full border p-3 rounded-lg text-sm focus:outline-blue-500 font-bold" placeholder="0"/>
                                </div>
                            </div>
                            <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                                <p className="text-xs text-slate-600 mb-1">Margin Keuntungan:</p>
                                <p className="text-lg font-bold text-blue-600">{editModal.buyPrice > 0 ? ((editModal.sellPrice - editModal.buyPrice) / editModal.buyPrice * 100).toFixed(1) : '0'}%</p>
                            </div>
                            <div className="flex gap-2 pt-2">
                                <button type="button" onClick={() => setEditModal(null)} className="flex-1 border py-3 rounded-lg font-bold hover:bg-slate-50">Batal</button>
                                <button type="submit" className="flex-1 bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">üíæ Simpan</button>
                            </div>
                        </form>
                    </div>
                </div>
              )}
              
              {categoryModal && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                    <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <h3 className="font-bold text-xl text-slate-800">Kelola Kategori</h3>
                            <button onClick={() => setCategoryModal(null)} className="p-1 hover:bg-gray-100 rounded-full"><X className="w-5 h-5 text-slate-400"/></button>
                        </div>
                        <div className="space-y-3 max-h-96 overflow-y-auto">
                            {allCategories.map(cat => (
                                <div key={cat} className="flex justify-between items-center p-3 bg-slate-50 rounded-lg">
                                    <div>
                                        <p className="font-bold text-slate-700">{cat}</p>
                                        <p className="text-xs text-slate-500">{inv.filter(i => i.category === cat).length} produk</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                        <button onClick={() => setCategoryModal(null)} className="w-full mt-4 py-3 border rounded-lg font-bold hover:bg-slate-50">Tutup</button>
                    </div>
                </div>
              )}
            </div>
          );
        };

        const PaymentModal = ({ service, close, pay }) => {
           const sisa = (service.costEstimate || 0) - (service.dp || 0);
           const [amount, setAmount] = useState(sisa);
           const [method, setMethod] = useState('Cash');
           return (
             <div className="fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 animate-fade-in">
                <div className="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6">
                   <h3 className="font-bold text-lg mb-4 text-slate-800">Pembayaran Cepat</h3>
                   <div className="bg-slate-50 p-3 rounded-lg mb-4 border border-slate-100">
                      <p className="text-xs text-slate-500 mb-1">Pelanggan: <span className="font-bold text-slate-700">{service.customerName}</span></p>
                      <p className="text-xs text-slate-500">Sisa Tagihan: <span className="font-bold text-red-600">{formatCurrency(sisa)}</span></p>
                   </div>
                   <div className="space-y-3">
                      <div><label className="text-xs font-bold text-slate-500 uppercase">Jumlah Bayar</label><NumberInput className="w-full border p-2 rounded font-bold text-lg text-slate-800" value={amount} onChange={val=>setAmount(val)} /></div>
                      <div><label className="text-xs font-bold text-slate-500 uppercase">Metode</label><select className="w-full border p-2 rounded bg-white" value={method} onChange={e=>setMethod(e.target.value)}><option>Cash</option><option>Transfer</option></select></div>
                   </div>
                   <div className="mt-6 flex gap-2">
                      <button onClick={close} className="flex-1 py-2 border rounded hover:bg-slate-50 font-medium">Batal</button>
                      <button onClick={() => pay(service, amount, method)} className="flex-1 py-2 bg-green-600 text-white rounded font-bold hover:bg-green-700 shadow-lg shadow-green-200">Bayar</button>
                   </div>
                </div>
             </div>
           );
        };

        const Invoice = ({ s, store, allKelengkapanItems = [], allQCItems = [] }) => {
          const sisa = (s.costEstimate || 0) - (s.dp || 0);
          
          const getSelectedItems = (obj, allItems = []) => {
            if (!obj) return [];
            return Object.entries(obj).filter(([k, v]) => v === true).map(([k]) => {
              const found = allItems.find(item => item.name.toLowerCase().replace(/\s+/g, '_') === k);
              return found ? found.name : k.replace(/_/g, ' ');
            });
          };
          
          const kelengkapanList = getSelectedItems(s.kelengkapan, allKelengkapanItems);
          const qcFunctionalList = getSelectedItems(s.qcFunctional, allQCItems);
          
          return (
            <div className="w-[80mm] mx-auto bg-white p-6 text-slate-800 shadow-lg" style={{ fontFamily: 'Inter, sans-serif' }}>
                {/* Header */}
                <div className="flex flex-col items-center border-b-2 border-slate-100 pb-4 mb-4">
                    {store?.logo ? <img src={store.logo} alt="Logo" className="w-20 h-20 object-contain mb-2 rounded-lg" /> : <div className="w-16 h-16 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-2xl mb-2">{store?.name?.[0] || 'i'}</div>}
                    <h2 className="font-bold text-lg uppercase tracking-wider text-slate-900">{store?.name || 'iFix Pro'}</h2>
                    <p className="text-[10px] text-slate-500 text-center mt-1 px-4 leading-tight">{store?.address}</p>
                    <p className="text-[10px] text-slate-500 mt-0.5">{store?.phone}</p>
                </div>
                
                {/* Customer & Invoice Info */}
                <div className="flex justify-between items-end mb-6">
                    <div>
                        <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Kepada</p>
                        <h3 className="font-bold text-sm text-slate-800">{s.customerName}</h3>
                        <p className="text-xs text-slate-500">{s.phone}</p>
                    </div>
                    <div className="text-right">
                        <p className="text-[10px] text-slate-400 uppercase font-bold tracking-wider">Invoice</p>
                        <h3 className="font-bold text-sm text-blue-600">#{s.token}</h3>
                        <p className="text-[10px] text-slate-500">{formatDate(s.createdAt)}</p>
                    </div>
                </div>
                
                {/* Unit & Status Info */}
                <div className="bg-slate-50 p-3 rounded-lg border border-slate-100 mb-6">
                    <div className="flex justify-between text-xs mb-1">
                        <span className="text-slate-500 font-medium">Unit</span>
                        <span className="font-bold text-slate-700">{s.unitType}</span>
                    </div>
                    <div className="flex justify-between text-xs mb-1">
                        <span className="text-slate-500 font-medium">Status</span>
                        <span className="font-bold text-slate-700">{s.status}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                        <span className="text-slate-500 font-medium">Keluhan</span>
                        <span className="font-medium text-slate-700 text-right max-w-[55%] text-[9px]">{s.complaint}</span>
                    </div>
                </div>
                
                {/* Sparepart List */}
                <div className="mb-4">
                    <h3 className="font-bold text-xs text-slate-800 uppercase tracking-wider mb-2 border-b border-slate-200 pb-1">Sparepart</h3>
                    {s.usedParts && s.usedParts.length > 0 ? (
                        <table className="w-full text-xs">
                            <tbody className="divide-y divide-slate-50">
                                {s.usedParts.map((p, i) => (
                                    <tr key={i}>
                                        <td className="py-1 text-slate-700">{p.name}</td>
                                        <td className="py-1 text-right text-slate-500 text-[9px]">x{p.qty}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    ) : (
                        <p className="text-xs text-slate-400 italic">-</p>
                    )}
                </div>
                
                {/* Kelengkapan Section */}
                {allKelengkapanItems.length > 0 && (
                    <div className="mb-3 border-b border-slate-200 pb-2">
                        <h3 className="font-bold text-xs text-slate-800 mb-1 uppercase">‚òë Kelengkapan</h3>
                        <div className="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[8px]">
                            {allKelengkapanItems.map((item, i) => {
                              const isSelected = kelengkapanList.includes(item.name);
                              return (
                                <div key={i} className="flex items-center">
                                    <span className={`font-bold mr-1 ${isSelected ? 'text-cyan-600' : 'text-slate-300'}`}>{isSelected ? '‚òë' : '‚òê'}</span>
                                    <span className={isSelected ? 'text-slate-700 font-medium' : 'text-slate-400'}>{item.name}</span>
                                </div>
                              );
                            })}
                        </div>
                    </div>
                )}
                
                {/* QC Cek Fungsional Section */}
                {allQCItems.length > 0 && (
                    <div className="mb-4 border-b border-slate-200 pb-2">
                        <h3 className="font-bold text-xs text-slate-800 mb-1 uppercase">‚òë QC Cek</h3>
                        <div className="grid grid-cols-2 gap-x-2 gap-y-0.5 text-[8px]">
                            {allQCItems.map((item, i) => {
                              const isSelected = qcFunctionalList.includes(item.name);
                              return (
                                <div key={i} className="flex items-center">
                                    <span className={`font-bold mr-1 ${isSelected ? 'text-green-600' : 'text-slate-300'}`}>{isSelected ? '‚òë' : '‚òê'}</span>
                                    <span className={isSelected ? 'text-slate-700 font-medium' : 'text-slate-400'}>{item.name}</span>
                                </div>
                              );
                            })}
                        </div>
                    </div>
                )}
                
                {/* Billing Summary */}
                <div className="space-y-2 border-t border-slate-200 pt-4 mb-4">
                    <div className="flex justify-between text-xs">
                        <span className="text-slate-500 font-medium">Subtotal</span>
                        <span className="font-bold text-slate-700">{formatCurrency(s.costEstimate)}</span>
                    </div>
                    <div className="flex justify-between text-xs">
                        <span className="text-slate-500 font-medium">Pembayaran (DP/Lunas)</span>
                        <span className="font-bold text-green-600">-{formatCurrency(s.dp)}</span>
                    </div>
                    <div className="flex justify-between items-center pt-2 border-t border-slate-100 mt-2">
                        <span className="text-sm font-bold text-slate-800">Sisa Tagihan</span>
                        <span className="text-lg font-black text-red-600">{formatCurrency(sisa < 0 ? 0 : sisa)}</span>
                    </div>
                </div>
                
                {/* Footer */}
                <div className="text-center border-t-2 border-slate-100 pt-3">
                    {s.warranty && <div className="inline-block bg-blue-50 text-blue-700 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-wider mb-2 border border-blue-100">Garansi: {s.warranty}</div>}
                    <p className="text-[10px] text-slate-400">Terima kasih telah mempercayakan servis kepada kami.</p>
                </div>
            </div>
          );
        };
        
        const FinanceManager = () => { 
            const { activeOwner, activeStore, checkPermission } = useContext(SessionContext);
            
            // State untuk filter bulan (default: bulan saat ini)
            const now = new Date();
            const defaultMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            const [selectedMonth, setSelectedMonth] = useState(defaultMonth);
            
            // Load ALL transactions (untuk cache, query sekali saja)
            const { data: allTransactions } = useFirestoreCollection('transactions', activeOwner?.id, null);
            const { data: services } = useFirestoreCollection('services', activeOwner?.id, activeStore?.id);
            
            // Filter transactions by selectedMonth di client-side
            const transactions = useMemo(() => {
                if (!selectedMonth) return allTransactions;
                
                const [year, month] = selectedMonth.split('-').map(Number);
                const startDate = new Date(year, month - 1, 1);
                const endDate = new Date(year, month, 0, 23, 59, 59, 999);
                
                return allTransactions.filter(t => {
                    const tDate = t.createdAt?.seconds 
                        ? new Date(t.createdAt.seconds * 1000) 
                        : (t.date?.seconds ? new Date(t.date.seconds * 1000) : null);
                    
                    if (!tDate) return false;
                    return tDate >= startDate && tDate <= endDate;
                });
            }, [allTransactions, selectedMonth]);
            
            const [editModal, setEditModal] = useState(null);
            const [expenseModal, setExpenseModal] = useState(false);
            const [detailModal, setDetailModal] = useState(null);
            const [filter, setFilter] = useState('today');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            
            const canEdit = checkPermission('feature_finance_edit');

            if (!checkPermission('menu_finance')) return <div className="p-20 text-center text-slate-400 flex flex-col items-center"><Lock className="w-12 h-12 mb-4 text-slate-300"/>Akses Menu Keuangan Dikunci oleh Superadmin</div>;

            // Filter transactions by date
            const getFilteredTrans = (trans, f) => {
                if (f === 'all') return trans;
                const now = new Date();
                return trans.filter(t => {
                    if (!t.date && !t.createdAt) return true; // Jika tidak ada tanggal, tetap tampilkan
                    const tDate = t.date?.toDate?.() || (t.date ? new Date(t.date) : null) || (t.createdAt?.seconds ? new Date(t.createdAt.seconds * 1000) : null);
                    if (!tDate) return true;
                    if (f === 'today') return tDate.toDateString() === now.toDateString();
                    if (f === 'month') return tDate.getMonth() === now.getMonth() && tDate.getFullYear() === now.getFullYear();
                    if (f === 'year') return tDate.getFullYear() === now.getFullYear();
                    return true;
                });
            };
            
            const filteredTrans = getFilteredTrans(transactions, filter);
            
            // Pagination logic
            const totalItems = filteredTrans.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTrans = filteredTrans.slice(startIndex, endIndex);
            
            // Reset to page 1 when filter changes
            useEffect(() => {
                setCurrentPage(1);
            }, [filter]);
            
            const handlePageChange = (newPage) => {
                if (newPage >= 1 && newPage <= totalPages) {
                    setCurrentPage(newPage);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            };
            
            const handleItemsPerPageChange = (value) => {
                setItemsPerPage(value);
                setCurrentPage(1);
            };

            // Calculate summary by type
            const totalExpense = filteredTrans.filter(t => t.type === 'expense').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalIncome = filteredTrans.filter(t => t.type === 'income').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalProfit = filteredTrans.filter(t => t.type === 'profit').reduce((sum, t) => sum + (t.amount || 0), 0);
            const totalLoss = filteredTrans.filter(t => t.type === 'loss').reduce((sum, t) => sum + (t.amount || 0), 0);
            const netProfit = totalIncome - totalExpense;
            
            // Debug log untuk troubleshooting - lebih detail
            useEffect(() => {
                console.log('üí∞ Finance Data Debug:', {
                    rawTransactions: transactions.length,
                    filteredCount: filteredTrans.length,
                    expense: { count: filteredTrans.filter(t => t.type === 'expense').length, total: totalExpense },
                    income: { count: filteredTrans.filter(t => t.type === 'income').length, total: totalIncome },
                    profit: { count: filteredTrans.filter(t => t.type === 'profit').length, total: totalProfit },
                    loss: { count: filteredTrans.filter(t => t.type === 'loss').length, total: totalLoss },
                    filter: filter,
                    activeOwner: activeOwner?.id,
                    transactions: transactions.slice(0, 3) // Sample 3 transactions
                });
            }, [transactions, filter]);

            const deleteTransaction = async (t) => {
                if(!confirm(`Hapus transaksi ${t.description}? \nJika ini pembayaran servis, data servis akan disinkronkan.`)) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', t.id));
                    if(t.serviceId) {
                        await recalculateServicePayment(t.serviceId, activeOwner.id);
                    }
                    alert("Transaksi dihapus.");
                } catch(e) {
                    alert("Gagal hapus: " + e.message);
                }
            };

            const updateTransaction = async (e) => {
                e.preventDefault();
                const amount = parseFloat(e.target.amount.value);
                const desc = e.target.description.value;
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'transactions', editModal.id), {
                        amount: amount,
                        description: desc
                    });
                    if(editModal.serviceId) {
                        await recalculateServicePayment(editModal.serviceId, activeOwner.id);
                    }
                    setEditModal(null);
                    alert("Transaksi diperbarui.");
                } catch(e) {
                    alert("Gagal update: " + e.message);
                }
            };
            
            const addExpense = async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore.id,
                        type: 'expense',
                        category: 'Pengeluaran Operasional',
                        description: formData.get('description'),
                        amount: parseFloat(formData.get('amount')),
                        date: serverTimestamp()
                    });
                    setExpenseModal(false);
                    e.target.reset();
                } catch(e) { alert("Error: " + e.message); }
            };

            return (
                <div className="space-y-6">
                  <div className="flex justify-between items-center gap-4 flex-wrap">
                    <h2 className="font-bold text-2xl">Keuangan</h2>
                    <div className="flex gap-2 items-center">
                        {/* Month Picker untuk hemat quota */}
                        <div className="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 flex items-center gap-2">
                            <Calendar className="w-4 h-4 text-blue-600"/>
                            <input 
                                type="month" 
                                value={selectedMonth} 
                                onChange={(e) => setSelectedMonth(e.target.value)}
                                className="text-sm font-bold text-blue-700 bg-transparent border-none outline-none cursor-pointer"
                                max={defaultMonth}
                            />
                        </div>
                        <div className="bg-white border border-slate-200 rounded-lg p-1 flex">
                            {[{id:'today',l:'Hari Ini'},{id:'month',l:'Bulan Ini'},{id:'year',l:'Tahun Ini'},{id:'all',l:'Semua'}].map(f => (
                                <button key={f.id} onClick={()=>setFilter(f.id)} className={`px-4 py-1.5 rounded-md text-xs font-bold transition-all ${filter === f.id ? 'bg-slate-900 text-white shadow' : 'text-slate-500 hover:bg-slate-100'}`}>{f.l}</button>
                            ))}
                        </div>
                    </div>
                    <button onClick={()=>setExpenseModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold text-sm hover:bg-red-700 flex items-center gap-2 shadow-lg"><MinusCircle className="w-4 h-4"/> Catat Pengeluaran</button>
                  </div>

                  {/* Summary Cards */}
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <button onClick={() => setDetailModal({type: 'expense', title: 'Pengeluaran (Modal)', data: filteredTrans.filter(t => t.type === 'expense')})} className="bg-red-50 border border-red-200 rounded-xl p-6 text-left hover:bg-red-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-red-600 text-sm font-bold uppercase mb-2">Pengeluaran (Modal)</div>
                        <div className="text-3xl font-bold text-red-600">{formatCurrency(totalExpense)}</div>
                        <div className="text-xs text-red-500 mt-2">{filteredTrans.filter(t => t.type === 'expense').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'income', title: 'Pemasukan (Penjualan)', data: filteredTrans.filter(t => t.type === 'income')})} className="bg-green-50 border border-green-200 rounded-xl p-6 text-left hover:bg-green-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-green-600 text-sm font-bold uppercase mb-2">Pemasukan (Penjualan)</div>
                        <div className="text-3xl font-bold text-green-600">{formatCurrency(totalIncome)}</div>
                        <div className="text-xs text-green-500 mt-2">{filteredTrans.filter(t => t.type === 'income').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'profit', title: 'Keuntungan', data: filteredTrans.filter(t => t.type === 'profit')})} className="bg-blue-50 border border-blue-200 rounded-xl p-6 text-left hover:bg-blue-100 hover:shadow-lg transition-all cursor-pointer">
                        <div className="text-blue-600 text-sm font-bold uppercase mb-2">Keuntungan</div>
                        <div className="text-3xl font-bold text-blue-600">{formatCurrency(totalProfit)}</div>
                        <div className="text-xs text-blue-500 mt-2">{filteredTrans.filter(t => t.type === 'profit').length} transaksi ‚Ä¢ Klik untuk detail</div>
                    </button>
                    <button onClick={() => setDetailModal({type: 'net', title: 'Bersih (Pemasukan - Pengeluaran)', data: [...filteredTrans.filter(t => t.type === 'income'), ...filteredTrans.filter(t => t.type === 'expense')]})} className={`border rounded-xl p-6 text-left hover:shadow-lg transition-all cursor-pointer ${netProfit >= 0 ? 'bg-emerald-50 border-emerald-200 hover:bg-emerald-100' : 'bg-amber-50 border-amber-200 hover:bg-amber-100'}`}>
                        <div className={`text-sm font-bold uppercase mb-2 ${netProfit >= 0 ? 'text-emerald-600' : 'text-amber-600'}`}>Bersih (Pemasukan - Pengeluaran)</div>
                        <div className={`text-3xl font-bold ${netProfit >= 0 ? 'text-emerald-600' : 'text-amber-600'}`}>{formatCurrency(Math.abs(netProfit))}</div>
                        <div className={`text-xs mt-2 ${netProfit >= 0 ? 'text-emerald-500' : 'text-amber-500'}`}>{netProfit >= 0 ? '‚úÖ Untung' : '‚ö†Ô∏è Rugi'} ‚Ä¢ Klik untuk detail</div>
                    </button>
                  </div>

                  {/* Transactions Table */}
                  <div className="bg-white rounded shadow overflow-hidden overflow-x-auto">
                      <table className="w-full text-sm text-left"><thead className="bg-gray-50"><tr><th className="p-3">Tgl</th><th className="p-3">Jenis</th><th className="p-3">Ket</th><th className="p-3 text-right">Jml</th><th className="p-3 text-center">Aksi</th></tr></thead>
                      <tbody className="divide-y">{paginatedTrans.map((t,i) => {
                          let typeColor = 'text-slate-600';
                          let typeLabel = t.type;
                          if(t.type === 'expense') { typeColor = 'text-red-600'; typeLabel = '‚ùå Pengeluaran'; }
                          else if(t.type === 'income') { typeColor = 'text-green-600'; typeLabel = '‚úÖ Pemasukan'; }
                          else if(t.type === 'profit') { typeColor = 'text-blue-600'; typeLabel = 'üìà Keuntungan'; }
                          else if(t.type === 'loss') { typeColor = 'text-amber-600'; typeLabel = 'üìâ Rugi'; }
                          return (
                          <tr key={i}>
                              <td className="p-3 text-gray-500">{formatDate(t.date)}</td>
                              <td className={`p-3 font-bold text-sm ${typeColor}`}>{typeLabel}</td>
                              <td className="p-3">
                                  <div className="font-medium">{t.category}</div>
                                  <div className="text-xs text-gray-400">{t.description}</div>
                                  {t.serviceId && <span className="text-[9px] bg-blue-50 text-blue-600 px-1 rounded border border-blue-100">Linked Service</span>}
                              </td>
                              <td className={`p-3 text-right font-bold text-sm`}>{formatCurrency(t.amount)}</td>
                              <td className="p-3 text-center">
                                  {canEdit ? (
                                      <div className="flex justify-center gap-2">
                                          <button onClick={()=>setEditModal(t)} className="text-blue-500 hover:bg-blue-50 p-1 rounded"><Pencil className="w-4 h-4"/></button>
                                          <button onClick={()=>deleteTransaction(t)} className="text-red-500 hover:bg-red-50 p-1 rounded"><Trash2 className="w-4 h-4"/></button>
                                      </div>
                                  ) : (
                                      <span className="text-xs text-slate-300 italic">Locked</span>
                                  )}
                              </td>
                          </tr>
                          );
                      })}</tbody></table>
                      {paginatedTrans.length === 0 && <div className="p-8 text-center text-slate-400">Tidak ada transaksi.</div>}
                  </div>
                  
                  {/* Pagination Controls */}
                  <div className="flex flex-col sm:flex-row justify-between items-center gap-4 bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl border border-blue-100">
                      <div className="flex items-center gap-3">
                          <span className="text-sm text-slate-600 font-medium">Tampilkan:</span>
                          <div className="flex gap-2">
                              <button onClick={() => handleItemsPerPageChange(10)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 10 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>10</button>
                              <button onClick={() => handleItemsPerPageChange(25)} className={`px-3 py-1.5 rounded-lg text-sm font-bold transition-all ${itemsPerPage === 25 ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100'}`}>25</button>
                          </div>
                      </div>
                      <div className="text-sm text-slate-600 font-medium">
                          Menampilkan <span className="text-blue-600 font-bold">{startIndex + 1}</span> - <span className="text-blue-600 font-bold">{Math.min(endIndex, totalItems)}</span> dari <span className="text-purple-600 font-bold">{totalItems}</span> data
                      </div>
                  </div>
                  
                  {/* Pagination Navigation */}
                  {totalPages > 1 && (
                      <div className="flex justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                          <button 
                              onClick={() => handlePageChange(currentPage - 1)} 
                              disabled={currentPage === 1}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              ‚Üê Sebelumnya
                          </button>
                          <div className="text-sm text-slate-600 font-medium">
                              Halaman <span className="text-blue-600 font-bold">{currentPage}</span> dari <span className="text-purple-600 font-bold">{totalPages}</span>
                          </div>
                          <button 
                              onClick={() => handlePageChange(currentPage + 1)} 
                              disabled={currentPage === totalPages}
                              className="px-4 py-2 rounded-lg font-bold text-sm transition-all disabled:opacity-50 disabled:cursor-not-allowed bg-slate-100 text-slate-700 hover:bg-slate-200 disabled:hover:bg-slate-100"
                          >
                              Selanjutnya ‚Üí
                          </button>
                      </div>
                  )}

                  {expenseModal && (
                      <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                          <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                              <h3 className="font-bold text-lg mb-4 text-red-600 flex items-center gap-2"><ArrowDownRight className="w-5 h-5"/> Catat Pengeluaran</h3>
                              <form onSubmit={addExpense} className="space-y-4">
                                  <div><label className="text-xs font-bold text-slate-500">Keterangan</label><input name="description" placeholder="Contoh: Bayar Listrik, Beli Kopi" className="w-full border p-2 rounded" required/></div>
                                  <div><label className="text-xs font-bold text-slate-500">Jumlah (Rp)</label><NumberInput name="amount" className="w-full border p-2 rounded font-bold" required/></div>
                                  <div className="flex gap-2 pt-2">
                                      <button type="button" onClick={()=>setExpenseModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                      <button className="flex-1 bg-red-600 text-white p-2 rounded font-bold">Simpan</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  )}

                  {editModal && (
                      <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                          <div className="bg-white p-6 rounded-2xl w-full max-w-sm shadow-xl">
                              <h3 className="font-bold text-lg mb-4">Edit Transaksi</h3>
                              <form onSubmit={updateTransaction} className="space-y-4">
                                  <div><label className="text-xs font-bold text-slate-500">Keterangan</label><input name="description" defaultValue={editModal.description} className="w-full border p-2 rounded" required/></div>
                                  <div><label className="text-xs font-bold text-slate-500">Jumlah (Rp)</label><NumberInput name="amount" defaultValue={editModal.amount} className="w-full border p-2 rounded font-bold" required/></div>
                                  <div className="flex gap-2 pt-2">
                                      <button type="button" onClick={()=>setEditModal(null)} className="flex-1 border p-2 rounded">Batal</button>
                                      <button className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                  </div>
                              </form>
                          </div>
                      </div>
                  )}
                  
                  {detailModal && (
                      <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-[70]">
                          <div className="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden shadow-2xl flex flex-col">
                              <div className="flex justify-between items-center border-b border-slate-200 p-6 bg-gradient-to-r from-slate-50 to-slate-100">
                                  <div>
                                      <h3 className="font-bold text-2xl text-slate-800">{detailModal.title}</h3>
                                      <p className="text-xs text-slate-500 mt-1">
                                          {detailModal.type === 'expense' && 'üí∏ Semua transaksi pengeluaran & modal'}
                                          {detailModal.type === 'income' && 'üí∞ Semua transaksi pemasukan'}
                                          {detailModal.type === 'profit' && 'üìà Semua transaksi keuntungan'}
                                          {detailModal.type === 'net' && 'üìä Perhitungan pemasukan dikurangi pengeluaran'}
                                      </p>
                                  </div>
                                  <button onClick={() => setDetailModal(null)} className="p-2 hover:bg-slate-200 rounded-lg transition-all"><X className="w-6 h-6 text-slate-600" /></button>
                              </div>
                              
                              <div className="overflow-y-auto flex-1 p-6">
                                  {detailModal.data.length === 0 ? (
                                      <div className="text-center py-12 text-slate-400">
                                          <FileText className="w-16 h-16 mx-auto mb-4 text-slate-300" />
                                          <p>Tidak ada transaksi</p>
                                      </div>
                                  ) : (
                                      <div className="space-y-3">
                                          {detailModal.data.map((t, idx) => {
                                              const isExpense = t.type === 'expense';
                                              const isIncome = t.type === 'income';
                                              const isProfit = t.type === 'profit';
                                              const bgColor = isExpense ? 'bg-red-50 border-red-200' : isIncome ? 'bg-green-50 border-green-200' : isProfit ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200';
                                              const textColor = isExpense ? 'text-red-700' : isIncome ? 'text-green-700' : isProfit ? 'text-blue-700' : 'text-slate-700';
                                              const relatedService = services.find(s => s.id === t.serviceId);
                                              
                                              return (
                                                  <div key={idx} className={`border rounded-xl p-4 ${bgColor} hover:shadow-md transition-all`}>
                                                      <div className="flex justify-between items-start mb-2">
                                                          <div className="flex-1">
                                                              <div className="flex items-center gap-2 mb-1">
                                                                  {isExpense && <span className="text-red-600 font-bold text-xs bg-red-100 px-2 py-0.5 rounded">‚ùå KELUAR</span>}
                                                                  {isIncome && <span className="text-green-600 font-bold text-xs bg-green-100 px-2 py-0.5 rounded">‚úÖ MASUK</span>}
                                                                  {isProfit && <span className="text-blue-600 font-bold text-xs bg-blue-100 px-2 py-0.5 rounded">üìà PROFIT</span>}
                                                                  {t.type === 'loss' && <span className="text-amber-600 font-bold text-xs bg-amber-100 px-2 py-0.5 rounded">üìâ LOSS</span>}
                                                                  <span className="text-[10px] text-slate-400">{formatDate(t.date || t.createdAt)}</span>
                                                              </div>
                                                              <h4 className={`font-bold text-sm ${textColor} mb-1`}>{t.category}</h4>
                                                              <p className="text-xs text-slate-600">{t.description}</p>
                                                              {t.serviceId && <span className="text-[9px] bg-blue-50 text-blue-600 px-1.5 py-0.5 rounded border border-blue-100 inline-block mt-1">üîó Linked Service</span>}
                                                              
                                                              {/* Sparepart Info */}
                                                              {relatedService && relatedService.usedParts && relatedService.usedParts.length > 0 && (
                                                                  <div className="bg-white/80 p-3 rounded-lg mt-3 border border-purple-100">
                                                                      <p className="text-xs font-bold text-purple-700 mb-2">üì¶ Sparepart yang Digunakan:</p>
                                                                      <div className="flex flex-wrap gap-2">
                                                                          {relatedService.usedParts.map((part, pidx) => {
                                                                              const profit = (part.sellPrice - part.buyPrice) * part.qty;
                                                                              return (
                                                                              <div key={pidx} className="bg-purple-50 border border-purple-200 rounded-md px-2 py-1.5 text-[10px]">
                                                                                  <div className="font-bold text-purple-700">{part.name} x{part.qty}</div>
                                                                                  {isExpense && <div className="text-red-600">Modal: {formatCurrency(part.buyPrice * part.qty)}</div>}
                                                                                  {isIncome && <div className="text-green-600">Jual: {formatCurrency(part.sellPrice * part.qty)}</div>}
                                                                                  {isProfit && <div className="text-blue-600">Profit: {formatCurrency(profit)}</div>}
                                                                              </div>
                                                                              );
                                                                          })}
                                                                      </div>
                                                                  </div>
                                                              )}
                                                          </div>
                                                          <div className={`text-right font-bold text-lg ${textColor}`}>
                                                              {formatCurrency(t.amount)}
                                                          </div>
                                                      </div>
                                                  </div>
                                              );
                                          })}
                                          
                                          <div className="mt-6 pt-4 border-t-2 border-slate-200">
                                              <div className="flex justify-between items-center bg-gradient-to-r from-slate-100 to-slate-50 p-4 rounded-xl">
                                                  <span className="font-bold text-slate-700">TOTAL {detailModal.title.toUpperCase()}</span>
                                                  <span className="font-bold text-2xl text-slate-800">
                                                      {formatCurrency(detailModal.data.reduce((sum, t) => {
                                                          if (detailModal.type === 'net') {
                                                              return sum + (t.type === 'income' ? t.amount : -t.amount);
                                                          }
                                                          return sum + (t.amount || 0);
                                                      }, 0))}
                                                  </span>
                                              </div>
                                          </div>
                                      </div>
                                  )}
                              </div>
                              
                              <div className="border-t border-slate-200 p-4 bg-slate-50">
                                  <button onClick={() => setDetailModal(null)} className="w-full py-3 bg-slate-600 text-white rounded-xl font-bold hover:bg-slate-700 transition-all">
                                      Tutup
                                  </button>
                              </div>
                          </div>
                      </div>
                  )}
                </div>
            ); 
        };
        
        const Sidebar = ({ setView, view, isOpen, close }) => {
            const { user, activeOwner, activeStore, availableStores, switchStore, logout, checkPermission } = useContext(SessionContext);
            const [storeMenuOpen, setStoreMenuOpen] = useState(false);
            const [expandedGroups, setExpandedGroups] = useState({ operations: true, finance: false, inventory: false });
            const effectiveRole = user.role === 'superadmin' ? 'owner' : user.role;
            
            const toggleGroup = (group) => {
                setExpandedGroups(prev => ({ ...prev, [group]: !prev[group] }));
            };
            
            const menuGroups = [
                {
                    id: 'main',
                    items: [
                        { id: 'dashboard', label: 'Dashboard', icon: LayoutDashboard, permission: 'menu_dashboard' }
                    ]
                },
                {
                    id: 'operations',
                    label: 'üìã Transaksi',
                    expandable: true,
                    items: [
                        { id: 'service', label: 'Servis HP', icon: Smartphone },
                        { id: 'sales', label: 'Penjualan', icon: Store },
                        { id: 'purchase', label: 'Pembelian', icon: ShoppingCart },
                        { id: 'return-sales', label: 'Retur Penjualan', icon: RotateCcw },
                        { id: 'return-purchase', label: 'Retur Pembelian', icon: RotateCw }
                    ]
                },
                {
                    id: 'finance',
                    label: 'üí∞ Keuangan',
                    expandable: true,
                    items: [
                        { id: 'payable', label: 'Utang', icon: ArrowUpRight },
                        { id: 'receivable', label: 'Piutang', icon: ArrowDownRight },
                        { id: 'cash', label: 'Kas', icon: Banknote },
                        { id: 'finance', label: 'Laporan Keuangan', icon: Wallet, permission: 'menu_finance' }
                    ]
                },
                {
                    id: 'inventory',
                    label: 'üì¶ Inventory',
                    expandable: true,
                    items: [
                        { id: 'inventory', label: 'Stok', icon: Box },
                        { id: 'supplier', label: 'Supplier', icon: Truck }
                    ]
                },
                {
                    id: 'other',
                    items: [
                        { id: 'customers', label: 'Pelanggan', icon: Users },
                        { id: 'report', label: 'Laporan', icon: FileText, permission: 'menu_report' }
                    ]
                }
            ];
            
            if(effectiveRole === 'owner') {
                menuGroups.push({
                    id: 'admin',
                    items: [
                        { id: 'users', label: 'Pegawai', icon: Users },
                        { id: 'settings', label: 'Pengaturan', icon: Settings }
                    ]
                });
            }
            
            return (
                <aside className={`bg-slate-900 text-slate-300 flex flex-col fixed left-0 top-0 bottom-0 z-50 shadow-2xl transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0`} style={{width: '256px'}}>
                    <div className="md:hidden absolute top-4 right-4 z-10"><button onClick={close} className="text-slate-400 hover:text-white"><X className="w-6 h-6"/></button></div>
                    {user.role === 'superadmin' && activeOwner && <div className="bg-purple-900 px-4 py-2 text-xs text-purple-200 font-bold flex justify-between items-center border-b border-purple-800 flex-shrink-0"><span>üëÅÔ∏è View: {activeOwner.name}</span><button onClick={()=>window.location.reload()} className="underline hover:text-white">Exit</button></div>}
                    <div className="p-6 flex-1 overflow-y-auto sidebar-scroll bg-slate-900">
                        <div className="flex items-center gap-3 text-white mb-6"><div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-xl">iF</div><div><h1 className="font-bold text-lg leading-tight">iFix Pro</h1><p className="text-[10px] text-blue-400 uppercase tracking-widest">{activeOwner?.plan || 'Cloud'} Edition</p></div></div>
                        <div className="relative mb-6">
                            <button onClick={() => effectiveRole === 'owner' && setStoreMenuOpen(!storeMenuOpen)} className={`w-full bg-slate-800 p-3 rounded-xl flex items-center gap-3 border border-slate-700 ${effectiveRole === 'owner' ? 'hover:border-blue-500 cursor-pointer' : ''}`}>
                                <div className="bg-blue-900 p-2 rounded-lg text-blue-400"><Store className="w-4 h-4"/></div><div className="flex-1 min-w-0 text-left"><p className="text-[10px] text-slate-500 uppercase font-bold">Lokasi Aktif</p><p className="text-sm font-bold text-white truncate">{activeStore?.id === 'all' ? 'üìä Semua Toko' : (activeStore?.name || 'Loading...')}</p></div>{effectiveRole === 'owner' ? <ChevronDown className="w-4 h-4"/> : <Lock className="w-3 h-3"/>}
                            </button>
                            {storeMenuOpen && <div className="absolute top-full left-0 w-full mt-2 bg-slate-800 rounded-xl border border-slate-700 shadow-xl overflow-hidden z-50">
                                <button onClick={()=>{switchStore(null); setStoreMenuOpen(false);}} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 flex justify-between border-b border-slate-700 text-slate-300 font-bold text-blue-400 bg-slate-700/50">
                                    <span className="truncate">üìä Semua Toko (Full Database)</span>
                                    {!activeStore?.id && <Check className="w-4 h-4 text-blue-500"/>}
                                </button>
                                {availableStores.map(s => <button key={s.id} onClick={()=>{switchStore(s.id); setStoreMenuOpen(false);}} className="w-full text-left px-4 py-3 text-sm hover:bg-slate-700 flex justify-between border-b border-slate-700 last:border-0 text-slate-300"><span className="truncate">{s.name}</span>{s.id === activeStore?.id && <Check className="w-4 h-4 text-blue-500"/>}</button>)}</div>}
                        </div>
                        <nav className="space-y-1">
                            {menuGroups.map(group => (
                                <div key={group.id}>
                                    {group.label && (
                                        <button
                                            onClick={() => group.expandable && toggleGroup(group.id)}
                                            className="w-full flex items-center justify-between px-3 py-2 text-xs font-bold text-slate-400 uppercase tracking-wider hover:text-slate-200 transition-colors"
                                        >
                                            <span>{group.label}</span>
                                            {group.expandable && (
                                                <ChevronDown className={`w-3 h-3 transition-transform ${expandedGroups[group.id] ? 'rotate-180' : ''}`} />
                                            )}
                                        </button>
                                    )}
                                    <div className={`space-y-1 ${group.expandable && !expandedGroups[group.id] ? 'hidden' : ''}`}>
                                        {group.items.map(m => {
                                            const isLocked = m.permission && !checkPermission(m.permission);
                                            return (
                                                <button 
                                                    key={m.id} 
                                                    onClick={()=>{ 
                                                        if(isLocked) { 
                                                            alert("‚ùå Menu ini dikunci oleh Superadmin/Owner"); 
                                                        } else { 
                                                            setView(m.id); 
                                                            if(window.innerWidth < 768) close(); 
                                                        } 
                                                    }} 
                                                    className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-medium transition-all ${view === m.id ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' : 'hover:bg-slate-800 hover:text-white'} ${isLocked ? 'text-slate-500 cursor-not-allowed hover:bg-transparent' : ''} ${group.label ? 'ml-2' : ''}`}
                                                > 
                                                    {isLocked ? <Lock className="w-4 h-4"/> : <m.icon className="w-4 h-4"/>} 
                                                    <span className="text-xs">{m.label}</span>
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </nav>
                    </div>
                    <div className="p-4 border-t border-slate-800 flex-shrink-0 bg-slate-900"><div className="flex items-center gap-3 px-2"><div className="w-8 h-8 rounded-full bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center text-white font-bold text-xs">{user.name.charAt(0)}</div><div className="flex-1 min-w-0"><p className="text-sm font-bold text-white truncate">{user.name}</p><p className="text-[10px] text-slate-500 uppercase font-bold">{user.role}</p></div></div></div>
                </aside>
            );
        };
        
        const SettingsManager = () => {
             const { user, activeOwner, activeStore, checkPermission, ownerAccess, storeConfig, availableStores } = useContext(SessionContext);
             const { data: users } = useFirestoreCollection('users', activeOwner?.id);
             const [storeData, setStoreData] = useState(activeStore || {});
             const [config, setConfig] = useState(storeConfig || {});
             const [saving, setSaving] = useState(false);
             const [restoring, setRestoring] = useState(false);
             const [isBranchModalOpen, setBranchModalOpen] = useState(false);
             const [modal, setModal] = useState(null);

             useEffect(() => { setStoreData(activeStore || {}); setConfig(storeConfig || {}); }, [activeStore, storeConfig]);
             const effectiveRole = user.role === 'superadmin' ? 'owner' : user.role;
             if (effectiveRole !== 'owner') return <div className="p-10 text-center text-red-500 font-bold"><Lock className="w-10 h-10 mx-auto mb-2"/>Akses Ditolak: Hanya Owner</div>;
             
             // NEW: Image Processor (Optimized for Spark Plan)
             const processImage = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            // Resize logic: Max width 300px (Sangat cukup untuk logo thermal)
                            const MAX_WIDTH = 300;
                            let width = img.width;
                            let height = img.height;

                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }

                            canvas.width = width;
                            canvas.height = height;
                            ctx.drawImage(img, 0, 0, width, height);
                            // Compress to WEBP quality 0.5 (Sangat hemat size)
                            resolve(canvas.toDataURL('image/webp', 0.5));
                        };
                        img.onerror = reject;
                        img.src = e.target.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
             };

             const handleLogo = async (e) => { 
                 const file = e.target.files[0]; 
                 if(file) { 
                     // Check max size 2MB for input
                     if (file.size > 2 * 1024 * 1024) {
                         alert("File terlalu besar! Maksimal 2MB.");
                         return;
                     }
                     try {
                        const compressed = await processImage(file);
                        setStoreData(prev => ({...prev, logo: compressed}));
                     } catch (err) {
                        alert("Gagal memproses gambar: " + err.message);
                     }
                 } 
             };

             const saveProfile = async (e) => { 
                e.preventDefault(); 
                setSaving(true); 
                try { 
                    if(!activeStore?.id) throw new Error("Data toko tidak ditemukan.");
                    
                    // Explicitly update only relevant fields
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', activeStore.id), {
                        name: storeData.name || '',
                        address: storeData.address || '',
                        phone: storeData.phone || '',
                        logo: storeData.logo || null
                    }); 
                    alert("Profil Toko Disimpan!"); 
                } catch(err) { 
                    alert("Gagal: " + err.message); 
                } finally { 
                    setSaving(false); 
                } 
             };
             
             const handleCreateBranch = async (e) => {
                 e.preventDefault();
                 
                 // LIMITATION CHECK: BASIC PLAN MAX 1 STORE
                 if (activeOwner.plan === 'basic' && availableStores.length >= 1) {
                     alert("üö´ AKSES DITOLAK: Basic Plan hanya diizinkan memiliki 1 cabang (Toko Pusat).\n\nSilakan hubungi Superadmin untuk upgrade ke PRO Plan agar bisa membuka cabang tak terbatas.");
                     return;
                 }

                 setSaving(true);
                 const formData = new FormData(e.target);
                 try {
                     await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'stores'), {
                         ownerId: activeOwner.id,
                         name: formData.get('name'),
                         address: formData.get('address'),
                         phone: formData.get('phone'),
                         createdAt: serverTimestamp()
                     });
                     alert("Cabang baru berhasil dibuka!");
                     setBranchModalOpen(false);
                 } catch(e) {
                     alert("Error: " + e.message);
                 } finally {
                     setSaving(false);
                 }
             };

             const toggleConfig = async (key) => {
                 if (ownerAccess[key] === false) { showAccessDenied("Fitur ini dimatikan dari pusat (Superadmin), Anda tidak bisa mengaktifkannya."); return; }
                 const newVal = config[key] === false ? true : false;
                 try {
                    const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), where('storeId', '==', activeStore.id));
                    const snap = await getDocs(q); 
                    if (snap.empty) { await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'store_configs'), { storeId: activeStore.id, [key]: newVal }); } else { await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'store_configs', snap.docs[0].id), { [key]: newVal }); }
                    setConfig({...config, [key]: newVal});
                 } catch(err) { console.error(err); }
             };

             const handleBackup = async () => {
                 if (!checkPermission('feature_backup')) { showAccessDenied('Fitur Backup hanya tersedia untuk PRO Plan.'); return; }
                 const backupData = { version: '1.0', timestamp: new Date().toISOString(), services: [], inventory: [], transactions: [], customers: [] };
                 const fetchCol = async (name) => { const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', name), where('ownerId', '==', activeOwner.id)); const snap = await getDocs(q); return snap.docs.map(d => ({id: d.id, ...d.data()})); }
                 try { setSaving(true); backupData.services = await fetchCol('services'); backupData.inventory = await fetchCol('inventory'); backupData.transactions = await fetchCol('transactions'); backupData.customers = await fetchCol('customers'); const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `ifix_backup_${new Date().toISOString().slice(0,10)}.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); } catch(e) { alert("Gagal backup: " + e.message); } finally { setSaving(false); }
             };

             const handleRestore = async (e) => {
                 const file = e.target.files[0]; if (!file) return;
                 if (!checkPermission('feature_backup')) { showAccessDenied('Fitur Restore hanya tersedia untuk PRO Plan.'); return; }
                 if (!confirm("PERINGATAN: Restore akan menimpa/menambah data yang ada. Apakah Anda yakin ingin melanjutkannya?")) return;
                 const reader = new FileReader();
                 reader.onload = async (event) => {
                     try {
                         setRestoring(true);
                         const json = JSON.parse(event.target.result);
                         const collectionsToRestore = ['services', 'inventory', 'transactions', 'customers'];
                         let totalItems = 0;
                         for (const key of collectionsToRestore) {
                             if (json[key] && Array.isArray(json[key])) {
                                 const batchArray = []; let currentBatch = writeBatch(db); let count = 0;
                                 for (const item of json[key]) {
                                     const cleanItem = normalizeFirestoreData(item);
                                     cleanItem.ownerId = activeOwner.id; cleanItem.storeId = activeStore.id; 
                                     const docRef = cleanItem.id ? doc(db, APP_COLLECTION_PREFIX, 'public', key, cleanItem.id) : doc(collection(db, APP_COLLECTION_PREFIX, 'public', key));
                                     currentBatch.set(docRef, cleanItem, { merge: true });
                                     count++; totalItems++;
                                     if (count >= 400) { batchArray.push(currentBatch); currentBatch = writeBatch(db); count = 0; }
                                 }
                                 if (count > 0) batchArray.push(currentBatch);
                                 for (const batch of batchArray) { await batch.commit(); }
                             }
                         }
                         alert(`Restore Berhasil! Total ${totalItems} data dipulihkan.`); window.location.reload();
                     } catch (err) { alert("Gagal restore: " + err.message); console.error(err); } finally { setRestoring(false); }
                 };
                 reader.readAsText(file);
             };

             return (
                 <div className="space-y-8 max-w-4xl">
                     <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                         <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl flex items-center gap-2 text-slate-800"><Store className="w-6 h-6 text-blue-600"/> Profil Toko</h3><button onClick={()=>setBranchModalOpen(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-700 flex items-center gap-2"><Plus className="w-4 h-4"/> Buka Cabang Baru</button></div>
                         <form onSubmit={saveProfile} className="space-y-6"><div className="flex items-center gap-6">
                            
                            {/* FIX: LOGO UPLOADER */}
                            <div className="w-24 h-24 rounded-2xl border-2 border-dashed border-slate-300 flex items-center justify-center bg-slate-50 overflow-hidden relative group cursor-pointer hover:border-blue-500 transition-colors">
                                {storeData.logo ? <img src={storeData.logo} className="w-full h-full object-contain pointer-events-none"/> : <ImageIcon className="w-8 h-8 text-slate-300 pointer-events-none"/>}
                                <div className="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-white text-xs font-bold pointer-events-none">Ganti Logo</div>
                                <input type="file" className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-50" accept="image/*" onChange={handleLogo} title="Ganti Logo Toko"/>
                            </div>

                            <div><h4 className="font-bold text-slate-700">Logo Struk</h4><p className="text-xs text-slate-500 mb-2">Format: JPG/PNG, Max 2MB</p></div></div><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Nama Toko</label><input className="w-full border border-slate-300 p-3 rounded-lg font-bold text-slate-800" value={storeData.name||''} onChange={e=>setStoreData({...storeData, name:e.target.value})}/></div><div><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">No Telepon</label><input className="w-full border border-slate-300 p-3 rounded-lg" value={storeData.phone||''} onChange={e=>setStoreData({...storeData, phone:e.target.value})}/></div><div className="md:col-span-2"><label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Alamat</label><input className="w-full border border-slate-300 p-3 rounded-lg" value={storeData.address||''} onChange={e=>setStoreData({...storeData, address:e.target.value})}/></div></div><div className="flex justify-end"><button disabled={saving} className="bg-blue-600 text-white px-8 py-3 rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-600/30 transition-all">{saving?'Saving...':'Simpan Perubahan'}</button></div></form>
                     </div>
                     {isBranchModalOpen && (
                         <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
                             <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                 <h3 className="font-bold text-xl mb-6 text-slate-800">Buka Cabang Baru</h3>
                                 <form onSubmit={handleCreateBranch} className="space-y-4">
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama Cabang</label>
                                         <input name="name" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="Contoh: iFix Jakarta Selatan" required/>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Alamat Cabang</label>
                                         <input name="address" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="Alamat lengkap..." required/>
                                     </div>
                                     <div>
                                         <label className="text-xs font-bold uppercase text-slate-500 mb-1 block">No Telepon</label>
                                         <input name="phone" className="w-full border p-3 rounded-lg focus:outline-blue-500" placeholder="08..." required/>
                                     </div>
                                     <div className="flex gap-3 mt-6">
                                         <button type="button" onClick={()=>setBranchModalOpen(false)} className="flex-1 py-3 border rounded-xl font-bold hover:bg-slate-50">Batal</button>
                                         <button disabled={saving} className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 flex items-center justify-center gap-2">
                                             {saving && <Loader2 className="w-4 h-4 animate-spin"/>} Buat Cabang
                                         </button>
                                     </div>
                                 </form>
                             </div>
                         </div>
                     )}

                     {/* MASTER DATA MANAGEMENT */}
                     <div className="bg-gradient-to-br from-purple-50 to-blue-50 p-8 rounded-2xl border border-purple-200 shadow-sm">
                         <h3 className="font-bold text-xl mb-6 flex items-center gap-2 text-slate-800"><Settings className="w-6 h-6 text-purple-600"/> Master Data</h3>
                         <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                             {[
                                 {
                                     title: '‚úì Cek Fungsional',
                                     desc: 'Kelola item QC fungsional',
                                     icon: <CheckCircle className="w-6 h-6 text-green-600"/>,
                                     onClick: () => setModal('qcItems'),
                                     color: 'from-green-50 to-green-100'
                                 },
                                 {
                                     title: 'üì¶ Kelengkapan',
                                     desc: 'Kelola item kelengkapan',
                                     icon: <Box className="w-6 h-6 text-blue-600"/>,
                                     onClick: () => setModal('kelengkapanItems'),
                                     color: 'from-blue-50 to-blue-100'
                                 },
                                 {
                                     title: 'üè∑Ô∏è Kategori Stok',
                                     desc: 'Kelola kategori barang',
                                     icon: <Tag className="w-6 h-6 text-orange-600"/>,
                                     onClick: () => setModal('categoryItems'),
                                     color: 'from-orange-50 to-orange-100'
                                 }
                             ].map((item, idx) => (
                                 <button
                                     key={idx}
                                     onClick={item.onClick}
                                     className={`bg-gradient-to-br ${item.color} p-4 rounded-xl border border-slate-200 hover:shadow-md transition-all text-left group`}
                                 >
                                     <div className="flex items-center gap-3 mb-2">
                                         {item.icon}
                                         <h4 className="font-bold text-slate-800 group-hover:text-slate-900">{item.title}</h4>
                                     </div>
                                     <p className="text-xs text-slate-600">{item.desc}</p>
                                 </button>
                             ))}
                         </div>
                     </div>

                     <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm border-l-4 border-l-orange-500">
                         <div className="flex justify-between items-start">
                             <div>
                                 <h3 className="font-bold text-xl mb-2 flex items-center gap-2 text-slate-800"><Database className="w-6 h-6 text-orange-600"/> Backup & Restore Data</h3>
                                 <p className="text-sm text-slate-500 mb-6">Simpan data toko Anda secara berkala atau pindahkan data dari perangkat lain. File backup berformat .json.</p>
                             </div>
                             {activeOwner.plan === 'basic' && <span className="bg-slate-100 text-slate-500 px-3 py-1 rounded text-xs font-bold border border-slate-200">BASIC PLAN: LOCKED</span>}
                             {activeOwner.plan === 'pro' && <span className="bg-purple-100 text-purple-600 px-3 py-1 rounded text-xs font-bold border border-purple-200 flex items-center gap-1"><Crown className="w-3 h-3"/> PRO PLAN</span>}
                         </div>
                         
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div className={`bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center ${activeOwner.plan === 'basic' ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                 <div className="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mb-4"><HardDriveDownload className="w-6 h-6"/></div>
                                 <h4 className="font-bold text-slate-800">Download Backup</h4>
                                 <p className="text-xs text-slate-500 mt-2 mb-4">Simpan seluruh data servis, pelanggan, dan stok ke komputer Anda.</p>
                                 <button onClick={handleBackup} disabled={saving} className="mt-auto w-full py-2 bg-blue-600 text-white rounded-lg text-sm font-bold hover:bg-blue-700">{saving ? 'Memproses...' : 'Download JSON'}</button>
                             </div>
                             <div className={`bg-slate-50 p-6 rounded-xl border border-slate-200 flex flex-col items-center text-center ${activeOwner.plan === 'basic' ? 'opacity-50 pointer-events-none grayscale' : ''}`}>
                                 <div className="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-4"><HardDriveUpload className="w-6 h-6"/></div>
                                 <h4 className="font-bold text-slate-800">Restore Database</h4>
                                 <p className="text-xs text-slate-500 mt-2 mb-4">Upload file backup (.json) untuk mengembalikan data.</p>
                                 <label className={`mt-auto w-full py-2 bg-green-600 text-white rounded-lg text-sm font-bold hover:bg-green-700 cursor-pointer flex items-center justify-center gap-2 ${restoring ? 'opacity-50 cursor-wait' : ''}`}>{restoring ? <Loader2 className="w-4 h-4 animate-spin"/> : <Upload className="w-4 h-4"/>} {restoring ? 'Merestore...' : 'Pilih File JSON'} <input type="file" accept=".json" onChange={handleRestore} disabled={restoring} className="hidden"/></label>
                             </div>
                         </div>
                     </div>
                     <div className="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
                         <h3 className="font-bold text-xl mb-6 flex items-center gap-2 text-slate-800"><ShieldCheck className="w-6 h-6 text-purple-600"/> Hak Akses Karyawan</h3>
                         <div className="grid grid-cols-1 md:grid-cols-2 gap-4">{[{k: 'feature_delete', l: 'Hapus Data Servis', d: 'Izinkan admin menghapus data.'},{k: 'feature_print', l: 'Cetak Invoice', d: 'Akses ke printer thermal.'},{k: 'feature_share', l: 'Share WhatsApp', d: 'Kirim invoice via WA.'},{k: 'feature_stock_add', l: 'Tambah Stok', d: 'Input barang baru ke inventory.'}].map(item => { const isPlatformLocked = ownerAccess[item.k] === false; return ( <button key={item.k} onClick={()=>toggleConfig(item.k)} className={`flex justify-between items-center p-4 border rounded-xl transition-all ${isPlatformLocked ? 'bg-slate-100 border-slate-200 cursor-not-allowed opacity-70' : (config[item.k] !== false ? 'border-green-200 bg-green-50' : 'border-slate-200 hover:border-slate-300')}`}> <div className="text-left"><p className={`font-bold text-sm ${isPlatformLocked ? 'text-slate-500' : (config[item.k] !== false ? 'text-green-800' : 'text-slate-700')}`}>{item.l} {isPlatformLocked && <span className="ml-2 text-[9px] bg-red-100 text-red-600 px-1.5 py-0.5 rounded border border-red-200">LOCKED BY PLATFORM</span>}</p><p className="text-xs text-slate-500">{item.d}</p></div> <div className={`w-12 h-6 rounded-full relative transition-colors ${isPlatformLocked ? 'bg-slate-300' : (config[item.k] !== false ? 'bg-green-500' : 'bg-slate-300')}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-all shadow-sm ${!isPlatformLocked && config[item.k] !== false ? 'left-7' : 'left-1'}`}>{isPlatformLocked && <Lock className="w-2.5 h-2.5 text-slate-400 absolute top-0.5 left-0.5"/>}</div></div> </button> ); })}</div>
                     </div>
                     
                     {/* MODAL RENDERING */}
                     {modal === 'qcItems' && <QCFunctionalItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'kelengkapanItems' && <KelengkapanItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} />}
                     {modal === 'categoryItems' && <CategoryItemsModal close={()=>setModal(null)} ownerId={activeOwner?.id} storeId={activeStore?.id} />}
                 </div>
             );
        };
        const UserManager = () => {
             const { user, activeOwner, activeStore, checkPermission } = useContext(SessionContext);
             const { data: users } = useFirestoreCollection('users', activeOwner?.id);
             const { data: stores } = useFirestoreCollection('stores', activeOwner?.id);
             const [modal, setModal] = useState(null);
             const [editUserModal, setEditUserModal] = useState(null);
             
             const effectiveRole = user.role === 'superadmin' ? 'owner' : user.role;
             if (effectiveRole !== 'owner') return null;
             
             // Check permission for editing employee
             const canEditEmployee = checkPermission('feature_employee_edit');

             const addUser = async (userData) => { try { await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'users'), { ...userData, ownerId: activeOwner.id, createdAt: serverTimestamp() }); setModal(null); alert("User berhasil ditambahkan! Silakan minta user untuk REGISTER dengan email ini untuk mengakses sistem."); } catch(e) { alert(e.message); } };
             const deleteUser = async (id) => { if(confirm("Hapus akses user ini?")) { await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', id)); } };
             
             const handleEditUser = async (e) => {
                 e.preventDefault();
                 const newName = e.target.name.value;
                 const newRole = e.target.role.value;
                 const newStore = e.target.storeId.value;
                 try {
                     await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'users', editUserModal.id), {
                         name: newName,
                         role: newRole,
                         storeId: newStore
                     });
                     setEditUserModal(null);
                     alert("Data Pegawai Diperbarui");
                 } catch(err) {
                     alert("Gagal update: " + err.message);
                 }
             };

             return (
                 <div className="space-y-6">
                    <div className="flex justify-between items-center"><h2 className="text-2xl font-bold text-slate-800">Pegawai & Akses</h2><button onClick={()=>setModal({})} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-bold flex items-center gap-2 text-sm shadow-lg hover:bg-blue-700"><Plus className="w-4 h-4"/> Tambah Pegawai</button></div>
                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto"><table className="w-full text-sm text-left"><thead className="bg-slate-50 border-b border-slate-200 text-slate-500 font-bold uppercase text-xs tracking-wider"><tr><th className="p-4">Nama</th><th className="p-4">Email</th><th className="p-4">Role</th><th className="p-4">Penempatan Toko</th><th className="p-4">Aksi</th></tr></thead><tbody className="divide-y divide-slate-100">{users.map(u => { const storeName = stores.find(s => s.id === u.storeId)?.name || 'Semua (Owner)'; return (<tr key={u.id} className="hover:bg-slate-50"><td className="p-4 font-bold text-slate-700">{u.name} {u.role === 'owner' && <span className="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded ml-2">OWNER</span>}</td><td className="p-4 text-slate-500">{u.email}</td><td className="p-4"><span className="uppercase text-xs font-bold bg-slate-100 px-2 py-1 rounded border border-slate-200">{u.role}</span></td><td className="p-4 text-slate-500 font-medium">{storeName}</td><td className="p-4"><div className="flex gap-2">{u.role !== 'owner' && canEditEmployee && (<button onClick={()=>setEditUserModal(u)} className="text-blue-500 hover:bg-blue-50 p-2 rounded"><Pencil className="w-4 h-4"/></button>)}{u.role !== 'owner' && (<button onClick={()=>deleteUser(u.id)} className="text-red-500 hover:bg-red-50 p-2 rounded"><Trash2 className="w-4 h-4"/></button>)}</div></td></tr>); })}</tbody></table></div>
                    
                    {modal && (<div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50"><div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl"><h3 className="font-bold text-xl mb-6">Tambah Karyawan Baru</h3><form onSubmit={(e) => { e.preventDefault(); const formData = new FormData(e.target); addUser(Object.fromEntries(formData)); }} className="space-y-4"><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama</label><input name="name" className="w-full border p-2.5 rounded-lg" required/></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Email</label><input name="email" type="email" className="w-full border p-2.5 rounded-lg" required/></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Role</label><select name="role" className="w-full border p-2.5 rounded-lg"><option value="admin">Admin</option><option value="kasir">Kasir</option><option value="teknisi">Teknisi</option></select></div><div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Penempatan Toko</label><select name="storeId" className="w-full border p-2.5 rounded-lg">{stores.map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div><div className="flex gap-3 mt-8"><button type="button" onClick={()=>setModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Simpan</button></div></form></div></div>)}

                    {editUserModal && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
                            <div className="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <h3 className="font-bold text-xl mb-6">Edit Data Pegawai</h3>
                                <form onSubmit={handleEditUser} className="space-y-4">
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Nama</label><input name="name" defaultValue={editUserModal.name} className="w-full border p-2.5 rounded-lg" required/></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Email (Tidak bisa diubah)</label><input value={editUserModal.email} disabled className="w-full border p-2.5 rounded-lg bg-gray-100 text-gray-500"/></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Role</label><select name="role" defaultValue={editUserModal.role} className="w-full border p-2.5 rounded-lg"><option value="admin">Admin</option><option value="kasir">Kasir</option><option value="teknisi">Teknisi</option></select></div>
                                    <div><label className="text-xs font-bold uppercase text-slate-500 mb-1 block">Penempatan Toko</label><select name="storeId" defaultValue={editUserModal.storeId} className="w-full border p-2.5 rounded-lg">{stores.map(s => (<option key={s.id} value={s.id}>{s.name}</option>))}</select></div>
                                    <div className="flex gap-3 mt-8"><button type="button" onClick={()=>setEditUserModal(null)} className="flex-1 py-3 border rounded-xl font-bold">Batal</button><button className="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg">Update</button></div>
                                </form>
                            </div>
                        </div>
                    )}
                 </div>
             );
        };

        // ==========================================
        // üí∞ PURCHASE MANAGER (Pembelian)
        // ==========================================
        const PurchaseManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [purchases, setPurchases] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [inventory, setInventory] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ supplierId: '', items: [], paymentMethod: 'cash', notes: '' });
            const [items, setItems] = useState([{ productId: '', productName: '', qty: 0, price: 0 }]);
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const purchasesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases');
                let q = query(purchasesRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(purchasesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const suppliersRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers');
                const qSupplier = query(suppliersRef, where('ownerId', '==', activeOwner.id));
                const unsubSupplier = onSnapshot(qSupplier, (snapshot) => {
                    setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const inventoryRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'inventory');
                const qInv = activeStore?.id && activeStore.id !== 'all' 
                    ? query(inventoryRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id))
                    : query(inventoryRef, where('ownerId', '==', activeOwner.id));
                const unsubInv = onSnapshot(qInv, (snapshot) => {
                    setInventory(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubscribe(); unsubSupplier(); unsubInv(); };
            }, [activeOwner?.id, activeStore?.id]);

            const addItem = () => setItems([...items, { productId: '', productName: '', qty: 0, price: 0 }]);
            const removeItem = (idx) => setItems(items.filter((_, i) => i !== idx));
            const updateItem = (idx, field, value) => {
                const newItems = [...items];
                newItems[idx][field] = value;
                if (field === 'productId') {
                    const product = inventory.find(p => p.id === value);
                    if (product) {
                        newItems[idx].productName = product.name;
                        newItems[idx].price = product.buyPrice || 0;
                    }
                }
                setItems(newItems);
            };

            const submitPurchase = async (e) => {
                e.preventDefault();
                if (items.length === 0 || items.some(i => !i.productId || i.qty <= 0)) {
                    alert('Isi semua item dengan benar!');
                    return;
                }

                try {
                    const total = items.reduce((sum, item) => sum + (item.qty * item.price), 0);
                    const purchaseData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        supplierId: form.supplierId,
                        supplierName: suppliers.find(s => s.id === form.supplierId)?.name || 'Unknown',
                        items: items,
                        total: total,
                        paymentMethod: form.paymentMethod,
                        notes: form.notes,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases'), purchaseData);

                    // Update stock for each item
                    for (const item of items) {
                        const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                        await runTransaction(db, async (transaction) => {
                            const productSnap = await transaction.get(productRef);
                            if (productSnap.exists()) {
                                transaction.update(productRef, {
                                    stock: increment(item.qty)
                                });
                            }
                        });
                    }

                    // Add to expense transactions (only if not kredit)
                    if (form.paymentMethod !== 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore?.id || 'all',
                            type: 'expense',
                            category: 'Pembelian Barang',
                            description: `Pembelian dari ${purchaseData.supplierName}`,
                            amount: total,
                            date: serverTimestamp()
                        });
                    }

                    // If credit, create payable (debt)
                    if (form.paymentMethod === 'credit') {
                        await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                            ownerId: activeOwner.id,
                            storeId: activeStore?.id || 'all',
                            type: 'payable',
                            customerName: purchaseData.supplierName,
                            amount: total,
                            paid: 0,
                            remaining: total,
                            description: `Pembelian barang - ${items.map(i => i.productName).join(', ')}`,
                            dueDate: null,
                            status: 'unpaid',
                            createdAt: serverTimestamp()
                        });
                    }

                    alert('‚úÖ Pembelian berhasil dicatat!');
                    setModal(false);
                    setForm({ supplierId: '', items: [], paymentMethod: 'cash', notes: '' });
                    setItems([{ productId: '', productName: '', qty: 0, price: 0 }]);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = purchases.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedPurchases = purchases.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üì¶ Pembelian</h2>
                        <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Pembelian
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-left">Pembayaran</th>
                                    <th className="p-3 text-left">Catatan</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedPurchases.map(p => (
                                    <tr key={p.id}>
                                        <td className="p-3 text-gray-500">{formatDate(p.createdAt)}</td>
                                        <td className="p-3 font-medium">{p.supplierName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {p.items.map((item, idx) => (
                                                    <div key={idx}>{item.productName} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(p.total)}</td>
                                        <td className="p-3">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${p.paymentMethod === 'cash' ? 'bg-green-100 text-green-700' : p.paymentMethod === 'credit' ? 'bg-orange-100 text-orange-700' : 'bg-blue-100 text-blue-700'}`}>
                                                {p.paymentMethod === 'cash' ? 'Tunai' : p.paymentMethod === 'credit' ? 'üí≥ Kredit' : 'Transfer'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-xs text-gray-500">{p.notes || '-'}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {purchases.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data pembelian</div>}
                    </div>

                    {purchases.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Pembelian</h3>
                                <form onSubmit={submitPurchase} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Supplier</label>
                                        <select value={form.supplierId} onChange={e => setForm({ ...form, supplierId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Supplier --</option>
                                            {suppliers.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                        </select>
                                    </div>

                                    <div>
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-bold text-slate-500">Item Pembelian</label>
                                            <button type="button" onClick={addItem} className="text-xs bg-green-600 text-white px-3 py-1 rounded">+ Item</button>
                                        </div>
                                        {items.map((item, idx) => (
                                            <div key={idx} className="flex gap-2 mb-2">
                                                <select value={item.productId} onChange={e => updateItem(idx, 'productId', e.target.value)} className="flex-1 border p-2 rounded text-sm" required>
                                                    <option value="">-- Pilih Produk --</option>
                                                    {inventory.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}
                                                </select>
                                                <NumberInput value={item.qty} onChange={val => updateItem(idx, 'qty', val)} placeholder="Qty" className="w-20 border p-2 rounded text-sm" required />
                                                <NumberInput value={item.price} onChange={val => updateItem(idx, 'price', val)} placeholder="Harga" className="w-32 border p-2 rounded text-sm" required />
                                                {items.length > 1 && <button type="button" onClick={() => removeItem(idx)} className="text-red-600 px-2"><Trash2 className="w-4 h-4" /></button>}
                                            </div>
                                        ))}
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Total</label>
                                        <div className="text-2xl font-bold text-blue-600">{formatCurrency(items.reduce((sum, i) => sum + (i.qty * i.price), 0))}</div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Metode Pembayaran</label>
                                        <select value={form.paymentMethod} onChange={e => setForm({ ...form, paymentMethod: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="cash">Tunai</option>
                                            <option value="transfer">Transfer</option>
                                            <option value="credit">üí≥ Kredit (Hutang)</option>
                                        </select>
                                        {form.paymentMethod === 'credit' && (
                                            <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Akan otomatis dicatat sebagai utang ke supplier</p>
                                        )}
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Catatan</label>
                                        <textarea value={form.notes} onChange={e => setForm({ ...form, notes: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Catatan tambahan..."></textarea>
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üöö SUPPLIER MANAGER
        // ==========================================
        const SupplierManager = () => {
            const { activeOwner } = useContext(SessionContext);
            const [suppliers, setSuppliers] = useState([]);
            const [modal, setModal] = useState(false);
            const [editModal, setEditModal] = useState(null);
            const [form, setForm] = useState({ name: '', phone: '', address: '', email: '' });

            useEffect(() => {
                if (!activeOwner?.id) return;
                const q = query(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), where('ownerId', '==', activeOwner.id));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setSuppliers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id]);

            const addSupplier = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'suppliers'), {
                        ownerId: activeOwner.id,
                        name: form.name,
                        phone: form.phone,
                        address: form.address,
                        email: form.email,
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Supplier berhasil ditambahkan!');
                    setModal(false);
                    setForm({ name: '', phone: '', address: '', email: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const updateSupplier = async (e) => {
                e.preventDefault();
                try {
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'suppliers', editModal.id), {
                        name: form.name,
                        phone: form.phone,
                        address: form.address,
                        email: form.email
                    });
                    alert('‚úÖ Supplier berhasil diperbarui!');
                    setEditModal(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteSupplier = async (supplier) => {
                if (!confirm(`Hapus supplier "${supplier.name}"?`)) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'suppliers', supplier.id));
                    alert('‚úÖ Supplier berhasil dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üöö Supplier</h2>
                        <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Supplier
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {suppliers.map(s => (
                            <div key={s.id} className="bg-white border rounded-lg p-4 hover:shadow-lg transition-shadow">
                                <div className="flex justify-between items-start mb-3">
                                    <h3 className="font-bold text-lg">{s.name}</h3>
                                    <div className="flex gap-1">
                                        <button onClick={() => { setForm(s); setEditModal(s); }} className="text-blue-600 p-1 hover:bg-blue-50 rounded"><Pencil className="w-4 h-4" /></button>
                                        <button onClick={() => deleteSupplier(s)} className="text-red-600 p-1 hover:bg-red-50 rounded"><Trash2 className="w-4 h-4" /></button>
                                    </div>
                                </div>
                                <div className="space-y-2 text-sm text-gray-600">
                                    <div className="flex items-center gap-2"><Phone className="w-3 h-3" /> {s.phone || '-'}</div>
                                    <div className="flex items-center gap-2"><Mail className="w-3 h-3" /> {s.email || '-'}</div>
                                    <div className="flex items-start gap-2"><MapPin className="w-3 h-3 mt-1" /> <span className="flex-1">{s.address || '-'}</span></div>
                                </div>
                            </div>
                        ))}
                    </div>
                    {suppliers.length === 0 && <div className="bg-white rounded-lg p-8 text-center text-gray-400">Belum ada data supplier</div>}

                    {(modal || editModal) && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">{editModal ? 'Edit Supplier' : 'Tambah Supplier'}</h3>
                                <form onSubmit={editModal ? updateSupplier : addSupplier} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Supplier</label>
                                        <input value={form.name} onChange={e => setForm({ ...form, name: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">No. Telepon</label>
                                        <input value={form.phone} onChange={e => setForm({ ...form, phone: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Email</label>
                                        <input type="email" value={form.email} onChange={e => setForm({ ...form, email: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alamat</label>
                                        <textarea value={form.address} onChange={e => setForm({ ...form, address: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => { setModal(false); setEditModal(null); setForm({ name: '', phone: '', address: '', email: '' }); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîÑ RETURN SALES MANAGER (Retur Penjualan)
        // ==========================================
        const ReturnSalesManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [returns, setReturns] = useState([]);
            const [sales, setSales] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ saleId: '', reason: '', items: [] });
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const returnsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'return_sales');
                let qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubReturns = onSnapshot(qReturns, (snapshot) => {
                    setReturns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const salesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'sales');
                let qSales = query(salesRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'sale'), orderBy('createdAt', 'desc'), limit(50));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qSales = query(salesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'sale'), orderBy('createdAt', 'desc'), limit(50));
                }
                const unsubSales = onSnapshot(qSales, (snapshot) => {
                    setSales(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubReturns(); unsubSales(); };
            }, [activeOwner?.id, activeStore?.id]);

            const submitReturn = async (e) => {
                e.preventDefault();
                if (!form.saleId) {
                    alert('Pilih transaksi penjualan!');
                    return;
                }

                try {
                    const sale = sales.find(s => s.id === form.saleId);
                    if (!sale) {
                        alert('Transaksi tidak ditemukan');
                        return;
                    }

                    const returnData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        saleId: form.saleId,
                        customerName: sale.customerName,
                        items: sale.items || [],
                        total: sale.total,
                        reason: form.reason,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'return_sales'), returnData);

                    for (const item of (sale.items || [])) {
                        if (item.id) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.id);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(item.qty)
                                    });
                                }
                            });
                        }
                    }

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: 'expense',
                        category: 'Retur Penjualan',
                        description: `Retur dari ${sale.customerName} - ${form.reason}`,
                        amount: sale.total,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Retur berhasil diproses!');
                    setModal(false);
                    setForm({ saleId: '', reason: '', items: [] });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = returns.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReturns = returns.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üîÑ Retur Penjualan</h2>
                        <button onClick={() => setModal(true)} className="bg-orange-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-orange-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Proses Retur
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Pelanggan</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-left">Alasan</th>
                                    <th className="p-3 text-right">Total Refund</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReturns.map(r => (
                                    <tr key={r.id}>
                                        <td className="p-3 text-gray-500">{formatDate(r.createdAt)}</td>
                                        <td className="p-3 font-medium">{r.customerName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.name} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-xs text-gray-600">{r.reason}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{formatCurrency(r.total)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur penjualan</div>}
                    </div>

                    {returns.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-2xl p-6">
                                <h3 className="font-bold text-xl mb-4">Proses Retur Penjualan</h3>
                                <form onSubmit={submitReturn} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Pilih Transaksi Penjualan</label>
                                        <select value={form.saleId} onChange={e => setForm({ ...form, saleId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Penjualan --</option>
                                            {sales.map(s => (
                                                <option key={s.id} value={s.id}>
                                                    {formatDate(s.createdAt)} - {s.customerName} - {formatCurrency(s.total)}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {form.saleId && (() => {
                                        const sale = sales.find(s => s.id === form.saleId);
                                        return sale ? (
                                            <div className="bg-blue-50 p-3 rounded border border-blue-200">
                                                <div className="text-xs font-bold text-blue-700 mb-2">Detail Penjualan:</div>
                                                <div className="space-y-1 text-xs">
                                                    {(sale.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between">
                                                            <span>{item.name} x{item.qty}</span>
                                                            <span className="font-bold">{formatCurrency(item.sellPrice * item.qty)}</span>
                                                        </div>
                                                    ))}
                                                    <div className="border-t border-blue-300 pt-1 flex justify-between font-bold">
                                                        <span>Total:</span>
                                                        <span>{formatCurrency(sale.total)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })()}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alasan Retur</label>
                                        <textarea value={form.reason} onChange={e => setForm({ ...form, reason: e.target.value })} className="w-full border p-2 rounded" rows="3" placeholder="Contoh: Barang rusak, salah item, dll" required></textarea>
                                    </div>

                                    <div className="bg-orange-50 border border-orange-200 p-3 rounded text-xs text-orange-700">
                                        ‚ö†Ô∏è <strong>Perhatian:</strong> Stok akan dikembalikan dan refund akan dicatat sebagai pengeluaran
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-orange-600 text-white p-2 rounded font-bold">Proses Retur</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîô RETURN PURCHASE MANAGER (Retur Pembelian)
        // ==========================================
        const ReturnPurchaseManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [returns, setReturns] = useState([]);
            const [purchases, setPurchases] = useState([]);
            const [modal, setModal] = useState(false);
            const [form, setForm] = useState({ purchaseId: '', reason: '' });
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                
                const returnsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'return_purchases');
                let qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qReturns = query(returnsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'));
                }
                const unsubReturns = onSnapshot(qReturns, (snapshot) => {
                    setReturns(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                const purchasesRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'purchases');
                let qPurchases = query(purchasesRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'), limit(50));
                if (activeStore?.id && activeStore.id !== 'all') {
                    qPurchases = query(purchasesRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'), limit(50));
                }
                const unsubPurchases = onSnapshot(qPurchases, (snapshot) => {
                    setPurchases(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => { unsubReturns(); unsubPurchases(); };
            }, [activeOwner?.id, activeStore?.id]);

            const submitReturn = async (e) => {
                e.preventDefault();
                if (!form.purchaseId) {
                    alert('Pilih transaksi pembelian!');
                    return;
                }

                try {
                    const purchase = purchases.find(p => p.id === form.purchaseId);
                    if (!purchase) {
                        alert('Transaksi tidak ditemukan');
                        return;
                    }

                    const returnData = {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        purchaseId: form.purchaseId,
                        supplierName: purchase.supplierName,
                        items: purchase.items || [],
                        total: purchase.total,
                        reason: form.reason,
                        createdAt: serverTimestamp()
                    };

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'return_purchases'), returnData);

                    for (const item of (purchase.items || [])) {
                        if (item.productId) {
                            const productRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'inventory', item.productId);
                            await runTransaction(db, async (transaction) => {
                                const productSnap = await transaction.get(productRef);
                                if (productSnap.exists()) {
                                    transaction.update(productRef, {
                                        stock: increment(-item.qty)
                                    });
                                }
                            });
                        }
                    }

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: 'income',
                        category: 'Retur Pembelian',
                        description: `Retur ke ${purchase.supplierName} - ${form.reason}`,
                        amount: purchase.total,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Retur berhasil diproses!');
                    setModal(false);
                    setForm({ purchaseId: '', reason: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = returns.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReturns = returns.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üîô Retur Pembelian</h2>
                        <button onClick={() => setModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Proses Retur
                        </button>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier</th>
                                    <th className="p-3 text-left">Item</th>
                                    <th className="p-3 text-left">Alasan</th>
                                    <th className="p-3 text-right">Total Refund</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReturns.map(r => (
                                    <tr key={r.id}>
                                        <td className="p-3 text-gray-500">{formatDate(r.createdAt)}</td>
                                        <td className="p-3 font-medium">{r.supplierName}</td>
                                        <td className="p-3">
                                            <div className="text-xs space-y-1">
                                                {(r.items || []).map((item, idx) => (
                                                    <div key={idx}>{item.productName} x{item.qty}</div>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-xs text-gray-600">{r.reason}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{formatCurrency(r.total)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {returns.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada retur pembelian</div>}
                    </div>

                    {returns.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-2xl p-6">
                                <h3 className="font-bold text-xl mb-4">Proses Retur Pembelian</h3>
                                <form onSubmit={submitReturn} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Pilih Transaksi Pembelian</label>
                                        <select value={form.purchaseId} onChange={e => setForm({ ...form, purchaseId: e.target.value })} className="w-full border p-2 rounded" required>
                                            <option value="">-- Pilih Pembelian --</option>
                                            {purchases.map(p => (
                                                <option key={p.id} value={p.id}>
                                                    {formatDate(p.createdAt)} - {p.supplierName} - {formatCurrency(p.total)}
                                                </option>
                                            ))}
                                        </select>
                                    </div>

                                    {form.purchaseId && (() => {
                                        const purchase = purchases.find(p => p.id === form.purchaseId);
                                        return purchase ? (
                                            <div className="bg-purple-50 p-3 rounded border border-purple-200">
                                                <div className="text-xs font-bold text-purple-700 mb-2">Detail Pembelian:</div>
                                                <div className="space-y-1 text-xs">
                                                    {(purchase.items || []).map((item, idx) => (
                                                        <div key={idx} className="flex justify-between">
                                                            <span>{item.productName} x{item.qty}</span>
                                                            <span className="font-bold">{formatCurrency(item.price * item.qty)}</span>
                                                        </div>
                                                    ))}
                                                    <div className="border-t border-purple-300 pt-1 flex justify-between font-bold">
                                                        <span>Total:</span>
                                                        <span>{formatCurrency(purchase.total)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        ) : null;
                                    })()}

                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Alasan Retur</label>
                                        <textarea value={form.reason} onChange={e => setForm({ ...form, reason: e.target.value })} className="w-full border p-2 rounded" rows="3" placeholder="Contoh: Barang cacat, salah kirim, dll" required></textarea>
                                    </div>

                                    <div className="bg-purple-50 border border-purple-200 p-3 rounded text-xs text-purple-700">
                                        ‚ö†Ô∏è <strong>Perhatian:</strong> Stok akan dikurangi dan refund akan dicatat sebagai pemasukan
                                    </div>

                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-purple-600 text-white p-2 rounded font-bold">Proses Retur</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩ PAYABLE MANAGER (Utang - Yang Harus Kita Bayar)
        // ==========================================
        const PayableManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [payables, setPayables] = useState([]);
            const [modal, setModal] = useState(false);
            const [paymentModal, setPaymentModal] = useState(null);
            const [form, setForm] = useState({ customerName: '', amount: 0, description: '', dueDate: '' });
            const [paymentAmount, setPaymentAmount] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                let q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'payable'), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'payable'), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setPayables(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addPayable = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: 'payable',
                        customerName: form.customerName,
                        amount: parseNumberFromInput(form.amount.toString()),
                        paid: 0,
                        remaining: parseNumberFromInput(form.amount.toString()),
                        description: form.description,
                        dueDate: form.dueDate ? new Date(form.dueDate) : null,
                        status: 'unpaid',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Data utang berhasil ditambahkan!');
                    setModal(false);
                    setForm({ customerName: '', amount: 0, description: '', dueDate: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const recordPayment = async (debt) => {
                if (paymentAmount <= 0 || paymentAmount > debt.remaining) {
                    alert('Jumlah pembayaran tidak valid!');
                    return;
                }
                try {
                    const newPaid = debt.paid + paymentAmount;
                    const newRemaining = debt.amount - newPaid;
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'debts', debt.id), {
                        paid: newPaid,
                        remaining: newRemaining,
                        status: newRemaining === 0 ? 'paid' : 'partial'
                    });

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: 'expense',
                        category: 'Pembayaran Utang',
                        description: `${debt.customerName} - ${debt.description}`,
                        amount: paymentAmount,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Pembayaran berhasil dicatat!');
                    setPaymentModal(null);
                    setPaymentAmount(0);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = payables.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedPayables = payables.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">ÔøΩ Utang (Yang Harus Kita Bayar)</h2>
                        <button onClick={() => setModal(true)} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Utang
                        </button>
                    </div>

                    <div className="bg-red-50 border border-red-200 rounded-xl p-6">
                        <h3 className="text-red-700 font-bold mb-2">Total Utang</h3>
                        <div className="text-4xl font-bold text-red-600 mb-2">
                            {formatCurrency(payables.reduce((sum, d) => sum + d.remaining, 0))}
                        </div>
                        <div className="text-sm text-red-600">{payables.filter(d => d.status !== 'paid').length} transaksi belum lunas</div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Supplier/Vendor</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-right">Dibayar</th>
                                    <th className="p-3 text-right">Sisa</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedPayables.map(d => (
                                    <tr key={d.id}>
                                        <td className="p-3 text-gray-500">{formatDate(d.createdAt)}</td>
                                        <td className="p-3 font-medium">{d.customerName}</td>
                                        <td className="p-3 text-xs text-gray-500">{d.description}</td>
                                        <td className="p-3 text-right font-bold text-red-600">{formatCurrency(d.amount)}</td>
                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid)}</td>
                                        <td className="p-3 text-right font-bold text-orange-600">{formatCurrency(d.remaining)}</td>
                                        <td className="p-3 text-center">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${d.status === 'paid' ? 'bg-green-100 text-green-700' : d.status === 'partial' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}`}>
                                                {d.status === 'paid' ? '‚úÖ Lunas' : d.status === 'partial' ? '‚è≥ Dicicil' : '‚ùå Belum Bayar'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-center">
                                            {d.status !== 'paid' && (
                                                <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold">
                                                    üí∞ Bayar
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {payables.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data utang</div>}
                    </div>

                    {payables.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4 text-red-600">üì§ Tambah Data Utang</h3>
                                <form onSubmit={addPayable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Supplier/Vendor</label>
                                        <input value={form.customerName} onChange={e => setForm({ ...form, customerName: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <input type="date" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {paymentModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Catat Pembayaran</h3>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-xs text-gray-500">Nama</div>
                                        <div className="font-bold">{paymentModal.customerName}</div>
                                        <div className="text-xs text-gray-500 mt-2">Sisa</div>
                                        <div className="text-2xl font-bold text-orange-600">{formatCurrency(paymentModal.remaining)}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah Bayar</label>
                                        <NumberInput value={paymentAmount} onChange={val => setPaymentAmount(val)} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { setPaymentModal(null); setPaymentAmount(0); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button onClick={() => recordPayment(paymentModal)} className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Bayar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩ RECEIVABLE MANAGER (Piutang - Yang Harus Dibayar ke Kita)
        // ==========================================
        const ReceivableManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [receivables, setReceivables] = useState([]);
            const [modal, setModal] = useState(false);
            const [paymentModal, setPaymentModal] = useState(null);
            const [form, setForm] = useState({ customerName: '', amount: 0, description: '', dueDate: '' });
            const [paymentAmount, setPaymentAmount] = useState(0);
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);

            useEffect(() => {
                if (!activeOwner?.id) return;
                const debtsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'debts');
                let q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('type', '==', 'receivable'), orderBy('createdAt', 'desc'));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(debtsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), where('type', '==', 'receivable'), orderBy('createdAt', 'desc'));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setReceivables(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addReceivable = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'debts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: 'receivable',
                        customerName: form.customerName,
                        amount: parseNumberFromInput(form.amount.toString()),
                        paid: 0,
                        remaining: parseNumberFromInput(form.amount.toString()),
                        description: form.description,
                        dueDate: form.dueDate ? new Date(form.dueDate) : null,
                        status: 'unpaid',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Data piutang berhasil ditambahkan!');
                    setModal(false);
                    setForm({ customerName: '', amount: 0, description: '', dueDate: '' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const recordPayment = async (debt) => {
                if (paymentAmount <= 0 || paymentAmount > debt.remaining) {
                    alert('Jumlah pembayaran tidak valid!');
                    return;
                }
                try {
                    const newPaid = debt.paid + paymentAmount;
                    const newRemaining = debt.amount - newPaid;
                    await updateDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'debts', debt.id), {
                        paid: newPaid,
                        remaining: newRemaining,
                        status: newRemaining === 0 ? 'paid' : 'partial'
                    });

                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'transactions'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: 'income',
                        category: 'Pembayaran Piutang',
                        description: `${debt.customerName} - ${debt.description}`,
                        amount: paymentAmount,
                        date: serverTimestamp()
                    });

                    alert('‚úÖ Pembayaran berhasil dicatat!');
                    setPaymentModal(null);
                    setPaymentAmount(0);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const totalItems = receivables.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            const paginatedReceivables = receivables.slice(startIndex, endIndex);
            
            const handlePageChange = (newPage) => setCurrentPage(newPage);
            const handleItemsPerPageChange = (newItemsPerPage) => {
                setItemsPerPage(newItemsPerPage);
                setCurrentPage(1);
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üì• Piutang (Yang Harus Dibayar ke Kita)</h2>
                        <button onClick={() => setModal(true)} className="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 flex items-center gap-2">
                            <Plus className="w-4 h-4" /> Tambah Piutang
                        </button>
                    </div>

                    <div className="bg-green-50 border border-green-200 rounded-xl p-6">
                        <h3 className="text-green-700 font-bold mb-2">Total Piutang</h3>
                        <div className="text-4xl font-bold text-green-600 mb-2">
                            {formatCurrency(receivables.reduce((sum, d) => sum + d.remaining, 0))}
                        </div>
                        <div className="text-sm text-green-600">{receivables.filter(d => d.status !== 'paid').length} transaksi belum lunas</div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal</th>
                                    <th className="p-3 text-left">Nama Pelanggan</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Total</th>
                                    <th className="p-3 text-right">Dibayar</th>
                                    <th className="p-3 text-right">Sisa</th>
                                    <th className="p-3 text-center">Status</th>
                                    <th className="p-3 text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {paginatedReceivables.map(d => (
                                    <tr key={d.id}>
                                        <td className="p-3 text-gray-500">{formatDate(d.createdAt)}</td>
                                        <td className="p-3 font-medium">{d.customerName}</td>
                                        <td className="p-3 text-xs text-gray-500">{d.description}</td>
                                        <td className="p-3 text-right font-bold text-green-600">{formatCurrency(d.amount)}</td>
                                        <td className="p-3 text-right text-blue-600">{formatCurrency(d.paid)}</td>
                                        <td className="p-3 text-right font-bold text-orange-600">{formatCurrency(d.remaining)}</td>
                                        <td className="p-3 text-center">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${d.status === 'paid' ? 'bg-green-100 text-green-700' : d.status === 'partial' ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-700'}`}>
                                                {d.status === 'paid' ? '‚úÖ Lunas' : d.status === 'partial' ? '‚è≥ Dicicil' : '‚ùå Belum Bayar'}
                                            </span>
                                        </td>
                                        <td className="p-3 text-center">
                                            {d.status !== 'paid' && (
                                                <button onClick={() => { setPaymentModal(d); setPaymentAmount(d.remaining); }} className="text-blue-600 hover:bg-blue-50 px-2 py-1 rounded text-xs font-bold">
                                                    üí∞ Terima Bayar
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {receivables.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada data piutang</div>}
                    </div>

                    {receivables.length > 0 && (
                        <Pagination 
                            currentPage={currentPage}
                            totalPages={totalPages}
                            totalItems={totalItems}
                            startIndex={startIndex + 1}
                            endIndex={endIndex}
                            onPageChange={handlePageChange}
                            itemsPerPage={itemsPerPage}
                            onItemsPerPageChange={handleItemsPerPageChange}
                        />
                    )}

                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4 text-green-600">üì• Tambah Data Piutang</h3>
                                <form onSubmit={addReceivable} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Pelanggan</label>
                                        <input value={form.customerName} onChange={e => setForm({ ...form, customerName: e.target.value })} className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2"></textarea>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jatuh Tempo (Opsional)</label>
                                        <input type="date" value={form.dueDate} onChange={e => setForm({ ...form, dueDate: e.target.value })} className="w-full border p-2 rounded" />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-green-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {paymentModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Catat Pembayaran</h3>
                                <div className="space-y-4">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-xs text-gray-500">Nama</div>
                                        <div className="font-bold">{paymentModal.customerName}</div>
                                        <div className="text-xs text-gray-500 mt-2">Sisa</div>
                                        <div className="text-2xl font-bold text-orange-600">{formatCurrency(paymentModal.remaining)}</div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah Diterima</label>
                                        <NumberInput value={paymentAmount} onChange={val => setPaymentAmount(val)} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button onClick={() => { setPaymentModal(null); setPaymentAmount(0); }} className="flex-1 border p-2 rounded">Batal</button>
                                        <button onClick={() => recordPayment(paymentModal)} className="flex-1 bg-green-600 text-white p-2 rounded font-bold">Terima</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // ÔøΩüíµ CASH MANAGER (Uang Kas)
        // ==========================================
        const CashManager = () => {
            const { activeOwner, activeStore } = useContext(SessionContext);
            const [cashFlow, setCashFlow] = useState([]);
            const [cashAccounts, setCashAccounts] = useState([]);
            const [modal, setModal] = useState(false);
            const [accountModal, setAccountModal] = useState(false);
            const [form, setForm] = useState({ type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
            const [newAccount, setNewAccount] = useState({ name: '', type: 'bank', color: '#3B82F6' });
            const [filterAccount, setFilterAccount] = useState('all');

            // Load cash accounts
            useEffect(() => {
                if (!activeOwner?.id) return;
                const accountsRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts');
                let q = query(accountsRef, where('ownerId', '==', activeOwner.id));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(accountsRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setCashAccounts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            // Load cash flow
            useEffect(() => {
                if (!activeOwner?.id) return;
                const cashRef = collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow');
                let q = query(cashRef, where('ownerId', '==', activeOwner.id), orderBy('createdAt', 'desc'), limit(100));
                if (activeStore?.id && activeStore.id !== 'all') {
                    q = query(cashRef, where('ownerId', '==', activeOwner.id), where('storeId', '==', activeStore.id), orderBy('createdAt', 'desc'), limit(100));
                }
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setCashFlow(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return unsubscribe;
            }, [activeOwner?.id, activeStore?.id]);

            const addAccount = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        name: newAccount.name,
                        type: newAccount.type,
                        color: newAccount.color,
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Akun berhasil ditambahkan!');
                    setAccountModal(false);
                    setNewAccount({ name: '', type: 'bank', color: '#3B82F6' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const deleteAccount = async (id) => {
                if (!confirm('Hapus akun ini? Transaksi tetap tersimpan.')) return;
                try {
                    await deleteDoc(doc(db, APP_COLLECTION_PREFIX, 'public', 'cash_accounts', id));
                    alert('‚úÖ Akun dihapus!');
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const addCashFlow = async (e) => {
                e.preventDefault();
                try {
                    await addDoc(collection(db, APP_COLLECTION_PREFIX, 'public', 'cash_flow'), {
                        ownerId: activeOwner.id,
                        storeId: activeStore?.id || 'all',
                        type: form.type,
                        amount: parseNumberFromInput(form.amount.toString()),
                        category: form.category,
                        description: form.description,
                        account: form.account || 'Kas Tunai',
                        createdAt: serverTimestamp()
                    });
                    alert('‚úÖ Kas berhasil dicatat!');
                    setModal(false);
                    setForm({ type: 'in', amount: 0, category: '', description: '', account: 'Kas Tunai' });
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            // Filter by account
            const filteredCashFlow = filterAccount === 'all' 
                ? cashFlow 
                : cashFlow.filter(c => (c.account || 'Kas Tunai') === filterAccount);

            // Get all unique accounts (from cash_accounts + default)
            const allAccountNames = ['Kas Tunai', ...cashAccounts.map(a => a.name)];
            
            // Calculate balance per account
            const accountBalances = allAccountNames.map(accName => {
                const flows = cashFlow.filter(c => (c.account || 'Kas Tunai') === accName);
                const totalIn = flows.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
                const totalOut = flows.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
                const accountInfo = cashAccounts.find(a => a.name === accName);
                return { 
                    account: accName, 
                    balance: totalIn - totalOut, 
                    totalIn, 
                    totalOut,
                    type: accountInfo?.type || 'cash',
                    color: accountInfo?.color || '#10B981'
                };
            });

            const totalIn = filteredCashFlow.filter(c => c.type === 'in').reduce((sum, c) => sum + c.amount, 0);
            const totalOut = filteredCashFlow.filter(c => c.type === 'out').reduce((sum, c) => sum + c.amount, 0);
            const balance = totalIn - totalOut;
            const grandTotal = accountBalances.reduce((sum, a) => sum + a.balance, 0);

            const getAccountIcon = (type) => {
                switch(type) {
                    case 'bank': return 'üè¶';
                    case 'ewallet': return 'üì±';
                    case 'cash': return 'üíµ';
                    default: return 'üí∞';
                }
            };

            return (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h2 className="font-bold text-2xl">üíµ Uang Kas & Bank</h2>
                        <div className="flex gap-2">
                            <button onClick={() => setAccountModal(true)} className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 flex items-center gap-2">
                                <Plus className="w-4 h-4" /> Tambah Akun
                            </button>
                            <button onClick={() => setModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 flex items-center gap-2">
                                <Plus className="w-4 h-4" /> Catat Transaksi
                            </button>
                        </div>
                    </div>

                    {/* Saldo Per Akun */}
                    <div className="bg-gradient-to-r from-purple-50 to-blue-50 border border-purple-200 rounded-xl p-4">
                        <div className="flex justify-between items-center mb-3">
                            <h3 className="font-bold text-purple-800 flex items-center gap-2">
                                <Banknote className="w-5 h-5" />
                                Saldo Per Akun ({accountBalances.length} Akun)
                            </h3>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {accountBalances.map(acc => {
                                const accountData = cashAccounts.find(a => a.name === acc.account);
                                return (
                                    <div key={acc.account} className="bg-white rounded-lg p-3 border border-gray-200 relative group">
                                        {accountData && (
                                            <button 
                                                onClick={() => deleteAccount(accountData.id)}
                                                className="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-red-100 hover:bg-red-200 text-red-600 rounded p-1"
                                                title="Hapus akun"
                                            >
                                                <Trash2 className="w-3 h-3" />
                                            </button>
                                        )}
                                        <div className="text-xs text-gray-600 mb-1 flex items-center gap-1">
                                            <span>{getAccountIcon(acc.type)}</span>
                                            <span className="truncate">{acc.account}</span>
                                        </div>
                                        <div className={`text-lg font-bold ${acc.balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                            {formatCurrency(acc.balance)}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="mt-3 pt-3 border-t border-purple-200 flex justify-between items-center">
                            <span className="text-sm font-bold text-purple-800">Total Semua Akun:</span>
                            <span className="text-2xl font-bold text-purple-600">{formatCurrency(grandTotal)}</span>
                        </div>
                    </div>

                    {/* Filter Akun */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <label className="text-xs font-bold text-slate-500 uppercase mb-2 block">Filter Akun:</label>
                        <select 
                            value={filterAccount} 
                            onChange={e => setFilterAccount(e.target.value)} 
                            className="w-full md:w-64 border border-gray-300 p-2 rounded-lg text-sm font-medium focus:outline-blue-500"
                        >
                            <option value="all">üìä Semua Akun</option>
                            {allAccountNames.map(acc => {
                                const accountInfo = cashAccounts.find(a => a.name === acc);
                                const icon = getAccountIcon(accountInfo?.type || 'cash');
                                return <option key={acc} value={acc}>{icon} {acc}</option>;
                            })}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-blue-50 border border-blue-200 rounded-xl p-4">
                            <h3 className="text-blue-700 font-bold mb-2 text-sm">üí∞ Saldo {filterAccount === 'all' ? 'Total' : filterAccount}</h3>
                            <div className="text-3xl font-bold text-blue-600">{formatCurrency(balance)}</div>
                        </div>
                        <div className="bg-green-50 border border-green-200 rounded-xl p-4">
                            <h3 className="text-green-700 font-bold mb-2 text-sm">üì• Kas Masuk</h3>
                            <div className="text-2xl font-bold text-green-600">{formatCurrency(totalIn)}</div>
                        </div>
                        <div className="bg-red-50 border border-red-200 rounded-xl p-4">
                            <h3 className="text-red-700 font-bold mb-2 text-sm">üì§ Kas Keluar</h3>
                            <div className="text-2xl font-bold text-red-600">{formatCurrency(totalOut)}</div>
                        </div>
                    </div>

                    <div className="bg-white rounded-lg shadow overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50">
                                <tr>
                                    <th className="p-3 text-left">Tanggal & Waktu</th>
                                    <th className="p-3 text-left">Akun</th>
                                    <th className="p-3 text-left">Jenis</th>
                                    <th className="p-3 text-left">Kategori</th>
                                    <th className="p-3 text-left">Keterangan</th>
                                    <th className="p-3 text-right">Jumlah</th>
                                    <th className="p-3 text-right">Saldo</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y">
                                {filteredCashFlow.reduce((acc, c, idx) => {
                                    const runningBalance = acc.balance + (c.type === 'in' ? c.amount : -c.amount);
                                    const accountInfo = cashAccounts.find(a => a.name === c.account);
                                    acc.rows.push(
                                        <tr key={c.id}>
                                            <td className="p-3 text-gray-500 text-xs">{formatDate(c.createdAt)}</td>
                                            <td className="p-3">
                                                <span className="text-xs font-bold text-purple-600 bg-purple-50 px-2 py-1 rounded flex items-center gap-1 w-fit">
                                                    <span>{getAccountIcon(accountInfo?.type || 'cash')}</span>
                                                    <span>{c.account || 'Kas Tunai'}</span>
                                                </span>
                                            </td>
                                            <td className="p-3">
                                                <span className={`px-2 py-1 rounded text-xs font-bold ${c.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                    {c.type === 'in' ? 'üì• Masuk' : 'üì§ Keluar'}
                                                </span>
                                            </td>
                                            <td className="p-3 font-medium">{c.category || '-'}</td>
                                            <td className="p-3 text-xs text-gray-500">{c.description}</td>
                                            <td className={`p-3 text-right font-bold ${c.type === 'in' ? 'text-green-600' : 'text-red-600'}`}>
                                                {c.type === 'in' ? '+' : '-'}{formatCurrency(c.amount)}
                                            </td>
                                            <td className="p-3 text-right font-bold text-blue-600">{formatCurrency(runningBalance)}</td>
                                        </tr>
                                    );
                                    acc.balance = runningBalance;
                                    return acc;
                                }, { rows: [], balance: 0 }).rows}
                            </tbody>
                        </table>
                        {filteredCashFlow.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada transaksi kas</div>}
                    </div>

                    {/* Modal Tambah Akun */}
                    {accountModal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Tambah Akun Kas/Bank</h3>
                                <form onSubmit={addAccount} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Nama Akun</label>
                                        <input 
                                            value={newAccount.name} 
                                            onChange={e => setNewAccount({ ...newAccount, name: e.target.value })} 
                                            placeholder="Contoh: Bank BRI Cabang Jakarta, Kas Toko 1" 
                                            className="w-full border p-2 rounded" 
                                            required 
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Tipe Akun</label>
                                        <select 
                                            value={newAccount.type} 
                                            onChange={e => setNewAccount({ ...newAccount, type: e.target.value })} 
                                            className="w-full border p-2 rounded"
                                        >
                                            <option value="cash">üíµ Kas Tunai</option>
                                            <option value="bank">üè¶ Bank</option>
                                            <option value="ewallet">üì± E-Wallet</option>
                                        </select>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setAccountModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-purple-600 text-white p-2 rounded font-bold">Tambah Akun</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Modal Transaksi */}
                    {modal && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50">
                            <div className="bg-white rounded-2xl w-full max-w-md p-6">
                                <h3 className="font-bold text-xl mb-4">Catat Transaksi Kas/Bank</h3>
                                <form onSubmit={addCashFlow} className="space-y-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Akun</label>
                                        <select 
                                            value={form.account} 
                                            onChange={e => setForm({ ...form, account: e.target.value })} 
                                            className="w-full border p-2 rounded"
                                        >
                                            {allAccountNames.map(acc => {
                                                const accountInfo = cashAccounts.find(a => a.name === acc);
                                                const icon = getAccountIcon(accountInfo?.type || 'cash');
                                                return <option key={acc} value={acc}>{icon} {acc}</option>;
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jenis Transaksi</label>
                                        <select value={form.type} onChange={e => setForm({ ...form, type: e.target.value })} className="w-full border p-2 rounded">
                                            <option value="in">üì• Kas Masuk</option>
                                            <option value="out">üì§ Kas Keluar</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Kategori</label>
                                        <input value={form.category} onChange={e => setForm({ ...form, category: e.target.value })} placeholder="Contoh: Penjualan, Gaji, dll" className="w-full border p-2 rounded" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Jumlah</label>
                                        <NumberInput value={form.amount} onChange={val => setForm({ ...form, amount: val })} className="w-full border p-2 rounded font-bold text-lg" required />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500">Keterangan</label>
                                        <textarea value={form.description} onChange={e => setForm({ ...form, description: e.target.value })} className="w-full border p-2 rounded" rows="2" placeholder="Detail transaksi..."></textarea>
                                    </div>
                                    <div className="flex gap-2 pt-2">
                                        <button type="button" onClick={() => setModal(false)} className="flex-1 border p-2 rounded">Batal</button>
                                        <button type="submit" className="flex-1 bg-blue-600 text-white p-2 rounded font-bold">Simpan</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // üîó PUBLIC SERVICE TRACKER (Tracking Progress via Link)
        // ==========================================
        const PublicServiceTracker = ({ serviceId, onBack }) => {
            const [service, setService] = useState(null);
            const [store, setStore] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchService = async () => {
                    try {
                        setLoading(true);
                        const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                        const serviceSnap = await getDoc(serviceRef);
                        
                        if (!serviceSnap.exists()) {
                            setError('Service tidak ditemukan');
                            setLoading(false);
                            return;
                        }

                        const serviceData = { id: serviceSnap.id, ...serviceSnap.data() };
                        setService(serviceData);

                        // Get store data
                        if (serviceData.storeId) {
                            const storeRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'stores', serviceData.storeId);
                            const storeSnap = await getDoc(storeRef);
                            if (storeSnap.exists()) {
                                setStore({ id: storeSnap.id, ...storeSnap.data() });
                            }
                        }

                        setLoading(false);
                    } catch (err) {
                        console.error('Error fetching service:', err);
                        setError('Gagal memuat data: ' + err.message);
                        setLoading(false);
                    }
                };

                fetchService();

                // Setup realtime listener
                const serviceRef = doc(db, APP_COLLECTION_PREFIX, 'public', 'services', serviceId);
                const unsubscribe = onSnapshot(serviceRef, (doc) => {
                    if (doc.exists()) {
                        setService({ id: doc.id, ...doc.data() });
                    }
                }, (err) => {
                    console.error('Realtime listener error:', err);
                    setError('Error realtime: ' + err.message);
                });

                return () => unsubscribe();
            }, [serviceId]);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
                        <div className="text-center">
                            <Loader2 className="w-12 h-12 animate-spin text-blue-600 mx-auto mb-4" />
                            <p className="text-slate-600 font-medium">Memuat data servis...</p>
                        </div>
                    </div>
                );
            }

            if (error || !service) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 max-w-md w-full text-center">
                            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <AlertTriangle className="w-8 h-8 text-red-600" />
                            </div>
                            <h2 className="text-xl font-bold text-slate-800 mb-2">Data Tidak Ditemukan</h2>
                            <p className="text-slate-600 mb-6">{error || 'Service tidak ditemukan'}</p>
                        </div>
                    </div>
                );
            }

            const statusColors = {
                'Diterima': 'bg-blue-100 text-blue-700 border-blue-300',
                'Diagnosa': 'bg-yellow-100 text-yellow-700 border-yellow-300',
                'Menunggu Sparepart': 'bg-orange-100 text-orange-700 border-orange-300',
                'Selesai': 'bg-green-100 text-green-700 border-green-300',
                'Dibatalkan': 'bg-red-100 text-red-700 border-red-300'
            };

            const paid = parseFloat(service.dp) || 0;
            const total = parseFloat(service.costEstimate) || 0;
            const remaining = total - paid;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
                    <div className="max-w-2xl mx-auto p-4 py-8">
                        {/* Header */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="flex items-center gap-4 mb-4">
                                <div className="w-12 h-12 bg-blue-600 rounded-xl flex items-center justify-center">
                                    <Smartphone className="w-6 h-6 text-white" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-800">Tracking Servis</h1>
                                    {store && <p className="text-sm text-slate-500">{store.name}</p>}
                                </div>
                            </div>
                            <div className="flex items-center gap-2 text-xs text-slate-500">
                                <Activity className="w-4 h-4" />
                                <span>Update Realtime</span>
                            </div>
                        </div>

                        {/* Service Info */}
                        <div className="bg-white rounded-2xl shadow-xl p-6 mb-6">
                            <div className="space-y-4">
                                <div className="flex justify-between items-start border-b pb-4">
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">Token Servis</p>
                                        <p className="text-2xl font-bold text-blue-600">{service.token}</p>
                                    </div>
                                    <div className={`px-4 py-2 rounded-xl border-2 font-bold text-sm ${statusColors[service.status] || 'bg-gray-100 text-gray-700'}`}>
                                        {service.status}
                                    </div>
                                </div>

                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">Pelanggan</p>
                                        <p className="font-bold text-slate-800">{service.customerName}</p>
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500 mb-1">No. HP</p>
                                        <p className="font-bold text-slate-800">{service.phone}</p>
                                    </div>
                                </div>

                                <div>
                                    <p className="text-xs text-slate-500 mb-1">Perangkat</p>
                                    <p className="font-bold text-slate-800">{service.unitType || service.deviceType}</p>
                                </div>

                                <div>
                                    <p className="text-xs text-slate-500 mb-1">Keluhan</p>
                                    <p className="text-slate-700 bg-slate-50 p-3 rounded-lg">{service.complaint || service.problem}</p>
                                </div>

                                <div className="border-t pt-4">
                                    <p className="text-xs text-slate-500 mb-1">Tanggal Masuk</p>
                                    <p className="font-bold text-slate-800">{formatDate(service.createdAt)}</p>
                                </div>
                            </div>
                        </div>

                        {/* Payment Info */}
                        <div className="bg-white rounded-2xl shadow-xl p-6">
                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2">
                                <Wallet className="w-5 h-5 text-green-600" />
                                Informasi Pembayaran
                            </h3>
                            <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                    <span className="text-slate-600">Total Biaya</span>
                                    <span className="font-bold text-xl text-slate-800">{formatCurrency(total)}</span>
                                </div>
                                {service.paymentStatus === 'Lunas' ? (
                                    <div className="bg-green-50 border border-green-200 rounded-lg p-4 flex items-center gap-3">
                                        <CheckCircle className="w-6 h-6 text-green-600" />
                                        <div>
                                            <p className="font-bold text-green-700">Lunas</p>
                                            <p className="text-xs text-green-600">Pembayaran sudah diselesaikan</p>
                                        </div>
                                    </div>
                                ) : service.paymentStatus === 'DP' ? (
                                    <div className="space-y-2">
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-600">DP Dibayar</span>
                                            <span className="font-bold text-green-600">{formatCurrency(paid)}</span>
                                        </div>
                                        <div className="flex justify-between items-center text-sm">
                                            <span className="text-slate-600">Sisa Pembayaran</span>
                                            <span className="font-bold text-orange-600">{formatCurrency(remaining)}</span>
                                        </div>
                                        <div className="bg-orange-50 border border-orange-200 rounded-lg p-3 text-xs text-orange-700">
                                            ‚è≥ Pembayaran DP telah diterima. Sisa pembayaran dapat dilunasi saat pengambilan.
                                        </div>
                                    </div>
                                ) : (
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                                        <p className="text-sm text-slate-600">Belum ada pembayaran</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Footer */}
                        <div className="text-center mt-8 text-xs text-slate-500">
                            <p>Halaman ini update secara realtime</p>
                            <p className="mt-1">Powered by iFix Pro Enterprise</p>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const { user, activeOwner, loading, logout } = useContext(SessionContext);
            const [view, setView] = useState('dashboard');
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            const [initialServiceData, setInitialServiceData] = useState(null);
            
            // Monitor access notifications
            useAccessNotification(user);
            
            // Check for Tracking Token or Track ID
            const [urlToken, setUrlToken] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('token');
            });
            
            const [trackId, setTrackId] = useState(() => {
                const params = new URLSearchParams(window.location.search);
                return params.get('track');
            });

            if (urlToken) {
                return <PublicTrackingView token={urlToken} onBack={() => { setUrlToken(null); window.history.pushState({}, '', window.location.pathname); }} />;
            }
            
            if (trackId) {
                return <PublicServiceTracker serviceId={trackId} onBack={() => { setTrackId(null); window.history.pushState({}, '', window.location.pathname); }} />;
            }

            if (loading) return <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center text-white gap-4"><Loader2 className="w-10 h-10 animate-spin text-blue-500"/><p className="text-sm font-medium animate-pulse">Menghubungkan ke Cloud Database...</p></div>;
            
            if (!user) return <LoginScreen />;
            if (user.role === 'guest') return <div className="min-h-screen bg-slate-50 flex items-center justify-center p-4"><div className="bg-white max-w-md w-full p-8 rounded-2xl shadow-xl text-center"><div className="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4"><ShieldAlert className="w-8 h-8"/></div><h2 className="text-xl font-bold text-slate-800 mb-2">Akun Belum Aktif</h2><p className="text-slate-500 mb-6">Halo <strong>{user.email}</strong>. Akun Anda berhasil dibuat, namun belum memiliki hak akses (Role). Silakan hubungi Superadmin atau Owner toko Anda untuk menambahkan email ini ke daftar pegawai.</p><button onClick={()=>getAuth().signOut().then(()=>window.location.reload())} className="text-blue-600 font-bold hover:underline">Keluar / Ganti Akun</button></div></div>;
            if (user.role === 'superadmin' && !activeOwner) return <SuperAdminDashboard />;
            
            return (
                <div className="flex bg-slate-50 min-h-screen relative overflow-x-hidden">
                    {mobileMenuOpen && ( <div className="fixed inset-0 bg-black/50 z-40 md:hidden backdrop-blur-sm transition-opacity" onClick={() => setMobileMenuOpen(false)}></div> )}
                    <Sidebar setView={setView} view={view} isOpen={mobileMenuOpen} close={() => setMobileMenuOpen(false)} />
                    <main className="flex-1 md:ml-64 transition-all duration-300" style={{minWidth: 0}}>
                        <header className="bg-white border-b border-slate-200 px-6 py-4 flex justify-between items-center sticky top-0 z-30 shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="text-right">
                                    <p className="text-sm font-bold text-slate-800">{user.name}</p>
                                    <p className="text-xs text-slate-500 uppercase">{user.role}</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <button onClick={()=>{setView('settings');}} className="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg font-bold flex items-center gap-2 text-white text-sm"><Crown className="w-4 h-4"/> Paket</button>
                                <button onClick={logout} className="bg-red-600 hover:bg-red-700 p-2 rounded-lg transition-colors flex items-center gap-2 text-white"><LogOut className="w-5 h-5"/></button>
                            </div>
                        </header>
                        <div className="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center sticky top-16 z-30 shadow-md">
                            <div className="flex items-center gap-3"><div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-bold text-xl">iF</div><div><h1 className="font-bold text-sm leading-tight">iFix Pro</h1><p className="text-[10px] text-blue-400 uppercase">{activeOwner?.plan || 'Mobile'}</p></div></div>
                            <button onClick={() => setMobileMenuOpen(true)} className="p-2 rounded-lg bg-slate-800 border border-slate-700"><Menu className="w-6 h-6 text-white"/></button>
                        </div>
                        <div className="p-4 md:p-8">
                            {view === 'dashboard' && <Dashboard setView={setView}/>}
                            {view === 'service' && <ServiceManager />}
                            {view === 'sales' && <SalesManager />}
                            {view === 'purchase' && <PurchaseManager />}
                            {view === 'return-sales' && <ReturnSalesManager />}
                            {view === 'return-purchase' && <ReturnPurchaseManager />}
                            {view === 'supplier' && <SupplierManager />}
                            {view === 'payable' && <PayableManager />}
                            {view === 'receivable' && <ReceivableManager />}
                            {view === 'cash' && <CashManager />}
                            {view === 'report' && <ReportManager />}
                            {view === 'customers' && <CustomerManager setView={setView} />}
                            {view === 'users' && <UserManager />}
                            {view === 'settings' && <SettingsManager />}
                            {view === 'inventory' && <StockManager />}
                            {view === 'finance' && <FinanceManager />}
                        </div>
                    </main>
                </div>
            );
        };

        const LoginScreen = () => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [rememberMe, setRememberMe] = useState(false);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const persistence = rememberMe ? browserLocalPersistence : browserSessionPersistence;
                    await setPersistence(auth, persistence);
                    await signInWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    let msg = err.message;
                    if (err.code === 'auth/invalid-credential') msg = "Email atau password salah.";
                    if (err.code === 'auth/user-not-found') msg = "Akun tidak ditemukan.";
                    if (err.code === 'auth/wrong-password') msg = "Password salah.";
                    if (err.code === 'auth/too-many-requests') msg = "Terlalu banyak percobaan. Coba lagi nanti.";
                    setError(msg);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1550751827-4bd374c3f58b?q=80&w=2070&auto=format&fit=crop')] bg-cover bg-center"></div>
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden relative z-10">
                        <div className="p-8 text-center bg-blue-600">
                            <h1 className="text-2xl font-black text-white tracking-tight">iFix Enterprise</h1>
                            <p className="text-blue-100 text-sm mt-1">Cloud Management Platform</p>
                        </div>
                        <div className="p-8">
                            <h2 className="text-xl font-bold text-slate-800 mb-6 text-center">Login</h2>

                            {error && <div className="bg-red-50 text-red-600 p-3 rounded-lg text-xs font-bold mb-4 flex items-center gap-2 border border-red-100"><ShieldAlert className="w-4 h-4"/> {error}</div>}

                            <form onSubmit={handleAuth} className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Email</label>
                                    <div className="relative">
                                        <input type="email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="nama@email.com" required/>
                                        <UserPlus className="w-5 h-5 text-slate-400 absolute left-3 top-3.5"/>
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase mb-1 block">Password</label>
                                    <div className="relative">
                                        <input type="password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full border border-slate-300 p-3 pl-10 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none" placeholder="******" required/>
                                        <Key className="w-5 h-5 text-slate-400 absolute left-3 top-3.5"/>
                                    </div>
                                </div>
                                
                                <div className="flex items-center">
                                    <input 
                                        id="remember-me" 
                                        type="checkbox" 
                                        checked={rememberMe}
                                        onChange={(e) => setRememberMe(e.target.checked)}
                                        className="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500"
                                    />
                                    <label htmlFor="remember-me" className="ml-2 text-sm font-medium text-slate-600 cursor-pointer">Ingat Saya</label>
                                </div>

                                <button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-600/30 transition-all flex items-center justify-center gap-2">
                                    {loading ? <Loader2 className="w-5 h-5 animate-spin"/> : 'Masuk Aplikasi'}
                                </button>
                            </form>
                            
                            <div className="mt-6 pt-6 border-t border-slate-100 text-center">
                                <p className="text-xs text-slate-400">Pastikan email Anda telah didaftarkan oleh Admin/Owner toko Anda.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // üõ°Ô∏è ERROR BOUNDARY COMPONENT
        // ==========================================
        class ErrorBoundary extends React.Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null, errorInfo: null };
            }

            static getDerivedStateFromError(error) {
                return { hasError: true };
            }

            componentDidCatch(error, errorInfo) {
                console.error('üî¥ React Error Boundary caught:', error, errorInfo);
                this.setState({
                    error,
                    errorInfo
                });
                
                // Tampilkan error di UI
                window.showError(
                    'React Component Error',
                    'Terjadi error saat merender komponen React.\n\nComponent Stack: ' + (errorInfo?.componentStack || 'N/A'),
                    error
                );
            }

            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen bg-gradient-to-br from-red-50 to-red-100 flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-2xl p-8 max-w-2xl w-full">
                                <div className="flex items-center gap-3 mb-6">
                                    <AlertTriangle className="w-10 h-10 text-red-600" />
                                    <h1 className="text-2xl font-bold text-red-600">Aplikasi Mengalami Error</h1>
                                </div>
                                <div className="bg-red-50 border border-red-200 rounded p-4 mb-6">
                                    <p className="text-sm font-mono text-red-800 whitespace-pre-wrap break-words">
                                        {this.state.error && this.state.error.toString()}
                                    </p>
                                </div>
                                <div className="space-y-3">
                                    <button
                                        onClick={() => window.location.reload()}
                                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <RefreshCw className="w-5 h-5" />
                                        Reload Halaman
                                    </button>
                                    <button
                                        onClick={() => {
                                            localStorage.clear();
                                            window.location.reload();
                                        }}
                                        className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2"
                                    >
                                        <Trash2 className="w-5 h-5" />
                                        Clear Cache & Reload
                                    </button>
                                </div>
                                <p className="text-xs text-slate-500 mt-6 text-center">
                                    Jika masalah berlanjut, hubungi support atau screenshot error ini.
                                </p>
                            </div>
                        </div>
                    );
                }

                return this.props.children;
            }
        }

        const Root = () => (
            <ErrorBoundary>
                <QuotaTrackingProvider>
                    <ToastProvider>
                        <SessionProvider>
                            <App />
                        </SessionProvider>
                    </ToastProvider>
                </QuotaTrackingProvider>
            </ErrorBoundary>
        );
        
        // Render dengan error handling
        try {
            console.log('üîÑ Rendering React app...');
            const root = createRoot(document.getElementById('root'));
            root.render(<Root />);
            console.log('‚úÖ React app rendered successfully');
            
            // ==========================================
            // üîí VERSION COMPATIBILITY CHECK
            // ==========================================
            console.log('üîí ===== VERSION LOCK STATUS =====');
            console.log('üì¶ Dependencies Status: LOCKED');
            console.log('‚úÖ React: 18.2.0 (Stable)');
            console.log('‚úÖ Firebase: 10.7.1 (Tested)');
            console.log('‚úÖ Protection Layer: Active');
            console.log('üìÖ Last Verified: Feb 3, 2026');
            console.log('‚ö†Ô∏è  DO NOT auto-update without testing!');
            console.log('üîí ================================');
            
        } catch (error) {
            console.error('‚ùå Failed to render React app:', error);
            window.showError(
                'React Render Error',
                'Gagal merender aplikasi React.\nPeriksa kompabilitas browser atau koneksi internet.',
                error
            );
        }
    </script>
</body>
</html>